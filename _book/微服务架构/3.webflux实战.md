# 1. æ¦‚è¿°

> å‹æƒ…æç¤ºï¼šReactive Programming ï¼Œç¿»è¯‘ä¸ºååº”å¼ç¼–ç¨‹ï¼Œåˆç§°ä¸ºå“åº”å¼ç¼–ç¨‹ã€‚æœ¬æ–‡ï¼Œæˆ‘ä»¬ç»Ÿä¸€ä½¿ç”¨å“åº”å¼ã€‚ä¸è¿‡ï¼Œæ¯”è¾ƒæ­£ç¡®çš„å«æ³•è¿˜æ˜¯ååº”å¼ã€‚

Spring Framework **5** åœ¨ 2017 å¹´ 9 æœˆä»½ï¼Œå‘å¸ƒäº† [GA](http://www.blogjava.net/RomulusW/archive/2008/05/04/197985.html) é€šç”¨ç‰ˆæœ¬ã€‚æ—¢ç„¶æ˜¯ä¸€ä¸ªæ–°çš„å¤§ç‰ˆæœ¬ï¼Œå¿…ç„¶å¸¦æ¥äº†éå¸¸å¤šçš„æ”¹è¿›ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯å°†å“åº”å¼ç¼–ç¨‹å¸¦å…¥äº† Spring ç”Ÿæ€ã€‚åˆæˆ–è€…è¯´ï¼Œå°†å“åº”å¼ç¼–ç¨‹â€œçœŸæ­£â€å¸¦å…¥äº† Java ç”Ÿæ€ä¹‹ä¸­ã€‚

åœ¨æ­¤ä¹‹å‰ï¼Œç›¸ä¿¡ç»å¤§å¤šæ•° Java å¼€å‘è€…ï¼Œå¯¹å“åº”å¼ç¼–ç¨‹çš„æ¦‚å¿µæ˜¯éå¸¸æ¨¡ç³Šçš„ã€‚ç”šè‡³è¯´ï¼Œæˆªæ­¢åˆ°ç›®å‰ 2019 å¹´ 11 æœˆä»½ï¼Œå¯¹äºå›½å†…çš„ Java å¼€å‘è€…ï¼Œä¹Ÿæ˜¯çŸ¥ä¹‹ç”šå°‘ã€‚

å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæœ€æ—©çœ‹åˆ°çš„å°±æ˜¯ Spring**5** æä¾›äº†ä¸€ä¸ªæ–°çš„ Web æ¡†æ¶ï¼ŒåŸºäºå“åº”å¼ç¼–ç¨‹çš„ [Spring WebFlux](https://github.com/spring-projects/spring-framework/tree/master/spring-webflux) ã€‚è‡³æ­¤ï¼ŒSpringMVC åœ¨â€œå¹²æ‰â€ [Struts](https://struts.apache.org/) ä¹‹åï¼Œéš¾é“è¦å¼€å§‹è¿›å…¥ Spring è‡ªå·±çš„ä¸¤ä¸ª Web æ¡†æ¶çš„åŒé›„äº‰éœ¸ï¼Ÿ

å®é™…ä¸Šï¼ŒWebFlux åœ¨å‡ºæ¥çš„ä¸¤å¹´æ—¶é—´é‡Œï¼Œæ®è‰¿è‰¿æ‰€äº†è§£åˆ°çš„æƒ…å†µï¼Œé²œæœ‰é¡¹ç›®ä»é‡‡ç”¨ SpringMVC è¿ç§»åˆ° WebFlux ï¼Œåˆæˆ–è€…æ–°é¡¹ç›®ç›´æ¥é‡‡ç”¨ WebFlux ã€‚è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

> è‰¿è‰¿ï¼šV2EX ä¸Šè¿˜æœ‰è¿™æ ·ä¸€ä¸ªè®¨è®º [ã€Šç°åœ¨æœ‰å…¬å¸åœ¨ä½¿ç”¨ Spring Boot 2.0 çš„ WebFlux å—ï¼Ÿã€‹](https://www.v2ex.com/t/507828) ã€‚

å“åº”å¼ç¼–ç¨‹ï¼Œå¯¹æˆ‘ä»¬ç°æœ‰çš„ç¼–ç¨‹æ–¹å¼ï¼Œæ˜¯ä¸€åœºé¢ è¦†ï¼Œå¯¹äºæ¡†æ¶ä¹Ÿæ˜¯ã€‚

- åœ¨ Spring æä¾›çš„æ¡†æ¶ä¸­ï¼Œå®é™…å¹¶æ²¡æœ‰å…¨éƒ¨å®ç°å¥½å¯¹å“åº”å¼ç¼–ç¨‹çš„æ”¯æŒã€‚ä¾‹å¦‚è¯´ï¼Œ[Spring Transaction](https://github.com/spring-projects/spring-framework/tree/master/spring-tx/src/main/java/org/springframework/transaction) äº‹åŠ¡ç»„ä»¶ï¼Œåœ¨ [Spring 5.2 M2 ç‰ˆæœ¬](https://spring.io/blog/2019/05/16/reactive-transactions-with-spring#reactive-transaction-management)ï¼Œæ‰æä¾›äº†æ”¯æŒå“åº”å¼ç¼–ç¨‹çš„ [ReactiveTransactionManager](https://github.com/spring-projects/spring-framework/blob/master/spring-tx/src/main/java/org/springframework/transaction/ReactiveTransactionManager.java) äº‹åŠ¡ç®¡ç†å™¨ã€‚
- æ›´ä¸è¦è¯´ï¼ŒJava ç”Ÿæ€å¸¸ç”¨çš„æ¡†æ¶ï¼Œä¾‹å¦‚è¯´ MyBatisã€Jedis ç­‰ç­‰ï¼Œéƒ½æš‚æœªæä¾›å“åº”å¼ç¼–ç¨‹çš„æ”¯æŒã€‚

æ‰€ä»¥ï¼ŒWebFlux æƒ³è¦èƒ½å¤ŸçœŸæ­£æ™®åŠåˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œä¸ä»…ä»…éœ€è¦ Spring è‡ªå·±ä½“ç³»ä¸­çš„æ¡†æ¶æä¾›å¯¹å“åº”å¼ç¼–ç¨‹çš„å¾ˆå¥½çš„æ”¯æŒï¼Œä¹Ÿéœ€è¦ Java ç”Ÿæ€ä¸­çš„æ¡†æ¶ä¹Ÿè¦åšåˆ°å¦‚æ­¤ã€‚ä¾‹å¦‚è¯´ï¼š![WebFlux æ™®åŠ](http://www.iocoder.cn/images/Spring-Boot/2019-11-31/02.png)

> è‰¿è‰¿ï¼šğŸ˜ˆ Java æ¡†æ¶å­˜åœ¨å¤§é‡åŸºäº ThreadLocal çº¿ç¨‹å˜é‡ï¼Œå®ç°å‚æ•°çš„é€ä¼ ï¼Œæ”¹é€ çš„æˆæœ¬ï¼Œå®é™…æ˜¯ä¸å°çš„ã€‚

å½“ç„¶ï¼Œå³ä½¿å¦‚æ­¤ï¼Œè¿™ä¹Ÿå¹¶ä¸å¦¨ç¢æˆ‘ä»¬æ¥å¯¹ WebFlux è¿›è¡Œä¸€ä¸ªå°å°çš„å…¥é—¨ã€‚æ¯•ç«Ÿï¼Œå“åº”å¼ç¼–ç¨‹è¿™æŠŠç«ï¼Œç»ˆå°†ç†Šç†Šç‡ƒèµ·ï¼Œçƒ§æ­»é‚£äº›å¼‚æ€§æ‹ã€‚å“ˆå“ˆå“ˆ~

> è‰¿è‰¿ï¼šä¸‹é¢çš„ä¼šæ¶‰åŠæ¯”è¾ƒå¤šçš„æ¦‚å¿µï¼Œä¸æƒ³çœ‹çš„èƒ–å‹ï¼Œç›´æ¥è·³åˆ° [ã€Œ2. å¿«é€Ÿå…¥é—¨ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) å°èŠ‚ï¼Œç›´æ¥å¼€å§‹ WebFlux çš„å…¥é—¨ã€‚

## 1.1 å“åº”å¼ç¼–ç¨‹

æˆ‘ä»¬å…ˆç®€å•æ¥äº†è§£ä¸‹å“åº”å¼ç¼–ç¨‹çš„ç›¸å…³å§¿åŠ¿ï¼Œä»¥ä¿è¯èƒ½å¤Ÿçœ‹æ‡‚ WebFlux å…¥é—¨çš„ä»£ç ç¤ºä¾‹ï¼Œå“ˆå“ˆå“ˆ~

ç»´åŸºç™¾ç§‘å¯¹å“åº”å¼ç¼–ç¨‹å®šä¹‰å¦‚ä¸‹ï¼š

> FROM https://en.wikipedia.org/wiki/Reactive_programming
>
> Reactive programming is an asynchronous programming paradigm concerned with data streams and the propagation of change. This means that it becomes possible to express static (e.g. arrays) or dynamic (e.g. event emitters) data streams with ease via the employed programming language(s).
>
> ååº”å¼ç¼–ç¨‹æ˜¯ä¸€ç§å¼‚æ­¥ç¼–ç¨‹èŒƒå¼ï¼Œå®ƒå…³æ³¨æ•°æ®æµå’Œå˜åŒ–çš„ä¼ æ’­ã€‚è¿™æ„å‘³ç€å¯ä»¥é€šè¿‡ä½¿ç”¨ç¼–ç¨‹è¯­è¨€è½»æ¾åœ°è¡¨ç¤ºé™æ€(å¦‚æ•°ç»„)æˆ–åŠ¨æ€(å¦‚äº‹ä»¶å‘å°„å™¨)æ•°æ®æµã€‚

Spring å®˜æ–¹æ–‡æ¡£å¯¹å“åº”å¼ç¼–ç¨‹å®šä¹‰å¦‚ä¸‹ï¼š

> FROM https://docs.spring.io/spring-framework/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/web-reactive.html#web-reactive-programming
>
> In plain terms reactive programming is about non-blocking applications that are asynchronous and event-driven and require a small number of threads to scale vertically (i.e. within the JVM) rather than horizontally (i.e. through clustering).
>
> ç®€å•åœ°è¯´ï¼Œå“åº”å¼ç¼–ç¨‹æ˜¯å…³äºéé˜»å¡åº”ç”¨ç¨‹åºçš„ï¼Œè¿™äº›åº”ç”¨ç¨‹åºæ˜¯å¼‚æ­¥çš„ã€äº‹ä»¶é©±åŠ¨çš„ï¼Œå¹¶ä¸”éœ€è¦å°‘é‡çš„çº¿ç¨‹æ¥å‚ç›´ä¼¸ç¼©(å³åœ¨ JVM ä¸­)ï¼Œè€Œä¸æ˜¯æ°´å¹³ä¼¸ç¼©(å³é€šè¿‡é›†ç¾¤)ã€‚

ğŸ˜ˆ ä¸¤ä¸ªçœ‹èµ·æ¥éƒ½ä¸å¾ˆæ˜“æ‡‚ã€‚ä¸è¿‡å¦‚æœèƒ–å‹çœ‹è¿‡ Netty æ¡†æ¶çš„ä»‹ç»ï¼Œä¼šå‘ç°è·Ÿ Spring çš„æè¿°éå¸¸ç›¸åƒã€‚å®šä¹‰å¦‚ä¸‹ï¼š

> FROM https://www.oschina.net/p/netty
>
> Netty æ˜¯ä¸€ä¸ª Java å¼€æºæ¡†æ¶ã€‚Netty æä¾›å¼‚æ­¥çš„ã€äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶å’Œå·¥å…·ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç¨‹åºã€‚

æ˜¯ä¸æ˜¯éƒ½çœ‹åˆ°äº†å¼‚æ­¥ + äº‹ä»¶é©±åŠ¨ã€‚æœ¬è´¨ä¸Šï¼ŒNetty ä¹Ÿæ˜¯æœ‰åŸºäºå“åº”å¼ç¼–ç¨‹çš„æ€æƒ³ã€‚æ‰€ä»¥åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œå¯ä»¥ä½¿ç”¨ Netty ä½œä¸º WebFlux çš„æœåŠ¡å™¨ã€‚

å“”å“”äº†è¿™ä¹ˆå¤šï¼Œè‰¿è‰¿æ¥ç”¨ç®€å•ä½†ä¸å®Œå…¨ç²¾å‡†çš„è¯­è¨€å°è¯•ä¸‹ã€‚ä»¥åç«¯ API è¯·æ±‚çš„å¤„ç†æ¥ä¸¾ä¾‹å­ã€‚

- åœ¨ç°åœ¨ä¸»æµçš„ç¼–ç¨‹æ¨¡å‹ä¸­ï¼Œè¯·æ±‚æ˜¯è¢«**åŒæ­¥é˜»å¡**å¤„ç†å®Œæˆï¼Œè¿”å›ç»“æœç»™å‰ç«¯ã€‚
- åœ¨å“åº”å¼çš„ç¼–ç¨‹æ¨¡å‹ä¸­ï¼Œè¯·æ±‚æ˜¯è¢«ä½œä¸º**ä¸€ä¸ªäº‹ä»¶**ä¸¢åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œç­‰åˆ°æ‰§è¡Œå®Œæ¯•ï¼Œ**å¼‚æ­¥**å›è°ƒç»“æœç»™ä¸»çº¿ç¨‹ï¼Œæœ€åè¿”å›ç»™å‰ç«¯ã€‚

é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä¸»çº¿ç¨‹ï¼ˆå®é™…æ˜¯å¤šä¸ªï¼Œè¿™é‡Œåªæ˜¯æ–¹ä¾¿æè¿°å“ˆï¼‰ä¸æ–­æ¥æ”¶è¯·æ±‚ï¼Œ**ä¸è´Ÿè´£ç›´æ¥åŒæ­¥é˜»å¡å¤„ç†**ï¼Œä»è€Œé¿å…è‡ªèº«è¢«é˜»å¡ã€‚

## 1.2 Reactor æ¡†æ¶

åœ¨ Java ç”Ÿæ€ä¸­ï¼Œæä¾›å“åº”å¼ç¼–ç¨‹çš„æ¡†æ¶ä¸»è¦æœ‰ [Reactor](https://projectreactor.io/)ã€[RxJava](https://github.com/ReactiveX/RxJava)ã€[JDK9 Flow API](https://community.oracle.com/docs/DOC-1006738) ã€‚

é‚£ä¹ˆï¼ŒSpring ä¼šé€‰æ‹©å“ªä¸ªæ¡†æ¶ä½œä¸ºå…¶å“åº”å¼ç¼–ç¨‹çš„åŸºç¡€å‘¢ï¼Ÿ

- é¦–å…ˆï¼Œå¯ä»¥æ’é™¤ JDK9 Flow API ï¼Œå› ä¸º Spring5 è¦æ”¯æŒ JDK8 ç‰ˆæœ¬å¼€å§‹ã€‚
- å…¶æ¬¡ï¼ŒReactor æ˜¯ Spring **æ¯**å…¬å¸ [Pivotal](https://zh.wikipedia.org/wiki/Pivotal)ï¼ˆå’³å’³å’³ï¼Œ2019 å¹´ç«Ÿç„¶è¢« [VMWare](https://zh.wikipedia.org/wiki/VMware) æ”¶è´­äº†ï¼‰æ˜¯å¼€æºçš„æ¡†æ¶ï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯â€œå¼ºå¼ºè”åˆâ€ï¼Œå˜¿å˜¿ã€‚

å¦‚æœèƒ–å‹æƒ³è¦äº†è§£ Reactor å’Œ RxJava çš„å¯¹æ¯”ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šå…«ä¸ªå±‚é¢æ¯”è¾ƒ Java 8, RxJava, Reactorã€‹](http://www.iocoder.cn/Fight/comparing-rxjava/?self) æ–‡ç« ï¼ŒæŒºè¯¦ç»†çš„ã€‚

è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ Reactor å®˜æ–¹å¯¹è‡ªå·±çš„ä»‹ç»ï¼š

> FROM https://projectreactor.io/
>
> Reactor is a fourth-generation Reactive library for building non-blocking applications on the JVM based on the [Reactive Streams Specification](https://github.com/reactive-streams/reactive-streams-jvm)
>
> Reactor æ˜¯ä¸€ä¸ªç¬¬å››ä»£å“åº”å¼ç¼–ç¨‹æ¡†æ¶ï¼Œç”¨äºæ„å»ºéé˜»å¡ JVM åº”ç”¨ç¨‹åºï¼ŒåŸºäº [Reactive Streams Specification](https://github.com/reactive-streams/reactive-streams-jvm) æ¥å®ç°ã€‚
>
> Reactor Operators and Schedulers can sustain high throughput rates on the order of 10's of millions of messages per second.
>
> Reactor çš„æ“ä½œå’Œè°ƒåº¦å¯ä»¥æä¾›æ¯ç§’åƒä¸‡æ¡æ¶ˆæ¯çš„é«˜ååé‡ã€‚
>
> Plus its low memory footprint should go under most of the radars.
>
> å†åŠ ä¸Šå®ƒçš„ä½å†…å­˜å ç”¨ï¼Œåº”è¯¥åœ¨å¤§å¤šæ•°é›·è¾¾ï¼ˆradarsï¼‰ä¹‹ä¸‹ã€‚å’³å’³å’³ï¼Œè¿™ä¸ª radars æ€ä¹ˆç¿»è¯‘ã€‚

ç®€å•æ¥è¯´ï¼ŒReactor è¯´æ˜¯ä¸€ä¸ªå“åº”å¼ç¼–ç¨‹æ¡†æ¶ï¼Œåˆå¿«åˆä¸å ç”¨å†…å­˜çš„é‚£ç§ã€‚ğŸ˜ˆ

å…³äº Reactor çš„ä½¿ç”¨ï¼Œè¿™é‡Œè‰¿è‰¿å°±ä¸è¿‡å¤šä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šä½¿ç”¨ Reactor è¿›è¡Œååº”å¼ç¼–ç¨‹ã€‹](http://www.iocoder.cn/Fight/j-cn-with-reactor-response-encode/?self) æ–‡ç« ã€‚å¦‚ä¸‹æ˜¯å¯¹å…¶ä¸­çš„ä¸€æ®µå†…å®¹çš„èŠ‚é€‰å¹¶ä¿®æ”¹ï¼š

Reactor æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„åŸºæœ¬æ¦‚å¿µï¼š

- [Flux](https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html) ï¼Œè¡¨ç¤ºçš„æ˜¯åŒ…å« 0 åˆ° N ä¸ªå…ƒç´ çš„å¼‚æ­¥åºåˆ—ã€‚å½“æ¶ˆæ¯é€šçŸ¥äº§ç”Ÿæ—¶ï¼Œè®¢é˜…è€…([Subscriber](https://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Subscriber.html))ä¸­å¯¹åº”çš„æ–¹æ³• `#onNext(t)`, `#onComplete(t)` å’Œ `#onError(t)` ä¼šè¢«è°ƒç”¨ã€‚
- [Mono](https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html) è¡¨ç¤ºçš„æ˜¯åŒ…å« 0 æˆ–è€… 1 ä¸ªå…ƒç´ çš„å¼‚æ­¥åºåˆ—ã€‚è¯¥åºåˆ—ä¸­åŒæ ·å¯ä»¥åŒ…å«ä¸ Flux ç›¸åŒçš„ä¸‰ç§ç±»å‹çš„æ¶ˆæ¯é€šçŸ¥ã€‚
- åŒæ—¶ï¼ŒFlux å’Œ Mono ä¹‹é—´å¯ä»¥è¿›è¡Œè½¬æ¢ã€‚ä¾‹å¦‚ï¼š
  - å¯¹ä¸€ä¸ª Flux åºåˆ—è¿›è¡Œè®¡æ•°æ“ä½œï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸ª `Mono<Long>` å¯¹è±¡ã€‚
  - æŠŠä¸¤ä¸ª Mono åºåˆ—åˆå¹¶åœ¨ä¸€èµ·ï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ª Flux å¯¹è±¡ã€‚

ğŸ˜ˆ å…¶å®ï¼Œå¯ä»¥å…ˆæš‚æ—¶ç®€å•æŠŠ Mono ç†è§£æˆ Object ï¼ŒFlux ç†è§£æˆ List ã€‚å˜¿å˜¿~

## 1.3 Spring WebFlux

Spring å®˜æ–¹æ–‡æ¡£å¯¹ Spring WebFlux ä»‹ç»å¦‚ä¸‹ï¼š

> FROM https://docs.spring.io/spring-framework/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/web-reactive.html
>
> Spring Framework 5 includes a new spring-webflux module. The module contains support for reactive HTTP and WebSocket clients as well as for reactive server web applications including REST, HTML browser, and WebSocket style interactions.
>
> Spring Framework 5 æä¾›äº†ä¸€ä¸ªæ–°çš„ [`spring-webflux`](https://github.com/spring-projects/spring-framework/tree/master/spring-webflux) æ¨¡å—ã€‚è¯¥æ¨¡å—åŒ…å«äº†ï¼š
>
> - å¯¹å“åº”å¼æ”¯æŒçš„ HTTP å’Œ WebSocket å®¢æˆ·ç«¯ã€‚
> - å¯¹å“åº”å¼æ”¯æŒçš„ Web æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬ Rest APIã€HTML æµè§ˆå™¨ã€WebSocket ç­‰äº¤äº’æ–¹å¼ã€‚
>
> On the server-side WebFlux supports 2 distinct programming models:
>
> - Annotation-based with @Controller and the other > annotations supported also with Spring MVC
> - Functional, Java 8 lambda style routing and handling
>
> åœ¨æœåŠ¡ç«¯æ–¹é¢ï¼ŒWebFlux æä¾›äº† 2 ç§ç¼–ç¨‹æ¨¡å‹ï¼ˆç¿»è¯‘æˆä½¿ç”¨æ–¹å¼ï¼Œå¯èƒ½æ›´æ˜“æ‡‚ï¼‰ï¼š
>
> - æ–¹å¼ä¸€ï¼Œ**åŸºäº Annotated Controller æ–¹å¼å®ç°**ï¼šåŸºäº `@Controller` å’Œ SpringMVC ä½¿ç”¨çš„å…¶å®ƒæ³¨è§£ã€‚ğŸ˜ˆ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¤§ä½“ä¸Šå¯ä»¥åƒä½¿ç”¨ SpringMVC çš„æ–¹å¼ï¼Œä½¿ç”¨ WebFlux ã€‚
> - æ–¹å¼äºŒï¼Œ**åŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼**ï¼šå‡½æ•°å¼ï¼ŒJava 8 lambda è¡¨è¾¾å¼é£æ ¼çš„è·¯ç”±å’Œå¤„ç†ã€‚ğŸ˜ˆ å¯èƒ½æœ‰ç‚¹æ™¦æ¶©ï¼Œæ™šç‚¹æˆ‘ä»¬çœ‹äº†ç¤ºä¾‹å°±ä¼šæ˜ç™½ã€‚
>
> Both programming models are executed on the same reactive foundation that adapts non-blocking HTTP runtimes to the Reactive Streams API.
>
> è¿™ä¸¤ä¸ªç¼–ç¨‹æ¨¡å‹ï¼Œéƒ½æ˜¯åœ¨åŒä¸€ä¸ªå“åº”å¼åŸºç¡€ï¼ˆfoundationï¼‰ä¸Šæ‰§è¡Œçš„ï¼Œè¯¥åŸºç¡€å°†éé˜»å¡ HTTP è¿è¡Œæ—¶ï¼ˆruntimeï¼‰**é€‚é…æˆ**å“åº”å¼ API ã€‚ğŸ˜ˆ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†åŸæœ‰çš„ API ï¼Œä½¿ç”¨ Reactor å°è£…æˆå“åº”å¼ API ï¼Œè®©æˆ‘ä»¬å¼€å‘è€…ä½¿ç”¨æ›´åŠ ä¾¿æ·ã€‚
>
> The diagram below shows the server-side stack including traditional, Servlet-based Spring MVC on the left from the spring-webmvc module and also the reactive stack on the right from the spring-webflux module.
>
> ä¸‹å›¾æ˜¾ç¤ºäº†æœåŠ¡ç«¯çš„æŠ€æœ¯æ ˆï¼Œå·¦ä¾§æ˜¯ [`spring-webmvc`](https://github.com/spring-projects/spring-framework/tree/master/spring-mvc) æ¨¡å—ä¸­ä¼ ç»Ÿçš„ã€åŸºäº Servlet çš„ Spring MVC ï¼Œå³ä¾§æ˜¯ `spring-webflux` æ¨¡å—ä¸­çš„å“åº”å¼æŠ€æœ¯æ ˆã€‚
>
> ![webflux-overview](http://static.iocoder.cn/8d45025963c78e6cb191676fd6e9ec44)
>
> - ğŸ˜ˆ ä»”ç»†çœ‹ç¬¬ä¸€å±‚çš„ä¸¤ä¸ªæ¡†æ¡†ï¼Œåˆ†åˆ«æ˜¯ä¸Šé¢æåˆ°çš„ WebFlux çš„ä¸¤ç§ç¼–ç¨‹æ¨¡å‹ã€‚è¡¨è¾¾çš„æ˜¯ SpringMVC ä¸æ”¯æŒ Router Functions æ–¹å¼ï¼Œè€Œ WebFlux æ”¯æŒã€‚
>
> WebFlux can run on Servlet containers with support for the Servlet 3.1 Non-Blocking IO API as well as on other async runtimes such as Netty and Undertow.
>
> WebFlux å¯ä»¥è¿è¡Œåœ¨ï¼š
>
> - æ”¯æŒ Servlet 3.1 éé˜»å¡ IO API çš„ Servlet å®¹å™¨ä¸Š
> - ä¹Ÿå¯ä»¥è¿è¡Œåœ¨æ”¯æŒå¼‚æ­¥è¿è¡Œæ—¶çš„ï¼Œä¾‹å¦‚è¯´ Netty æˆ–è€… Undertow ä¸Š
>
> Each runtime is adapted to a reactive ServerHttpRequest and ServerHttpResponse exposing the body of the request and response as Flux<DataBuffer>, rather than InputStream and OutputStream, with reactive backpressure.
>
> æ¯ä¸€ä¸ªè¿è¡Œæ—¶ï¼ˆruntimeï¼‰é€‚ç”¨äºå°†å“åº”å¼çš„ [ServerHttpRequest](https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/http/server/reactive/ServerHttpRequest.html) å’Œ [ServerHttpResponse](https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/http/server/reactive/ServerHttpResponse.html) ä¸­ request å’Œ response çš„ body æš´éœ²æˆ [`Flux`](https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html) å¯¹è±¡ï¼Œè€Œä¸æ˜¯ [InputStream ](https://docs.oracle.com/javase/7/docs/api/java/io/InputStream.html)å’Œ [InputStream ](https://docs.oracle.com/javase/7/docs/api/java/io/InputStream.html)å¯¹è±¡ï¼Œå¯ç”¨äºå“åº”å¼ä¸­çš„èƒŒå‹ï¼ˆ[backpressure](https://zhuanlan.zhihu.com/p/37076445)ï¼‰ã€‚ğŸ˜ˆ è¿™æ®µæœ‰ç‚¹æ™¦æ¶©ï¼Œç®€å•æ¥è¯´ï¼š
>
> - å¯¹äº Servlet æ¥è¯´ï¼Œ [`ServletRequest#getInputStream()`](https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/ServletRequest.java#L139-L152) æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚çš„ä¸»ä½“å†…å®¹è¿”å›çš„æ˜¯ InputStream å¯¹è±¡ã€‚
> - å¯¹äº WebFlux æ¥è¯´ï¼Œ[`ServerHttpRequest#getBody()`](https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/http/ReactiveHttpInputMessage.html#getBody--) æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚çš„ä¸»ä½“å†…å®¹è¿”å›çš„æ˜¯ `Flux<DataBuffer>` å¯¹è±¡ã€‚
>
> REST-style JSON and XML serialization and deserialization is supported on top as a `Flux<Object>`, and so is HTML view rendering and Server-Sent Events.
>
> REST é£æ ¼ API ä½¿ç”¨åˆ°çš„ JSON å’Œ XML åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œéœ€è¦æä¾›å¯¹ `Flux<Object>` çš„æ”¯æŒã€‚å¯¹äº HTML æ¸²æŸ“ï¼Œå’Œ [SSE](https://www.ruanyifeng.com/blog/2017/05/server-sent_events.html) ä¹Ÿè¦æä¾›å¯¹ `Flux<Object>` çš„æ”¯æŒã€‚

ğŸ˜ˆ å’³å’³å’³ï¼Œçœ‹å®Œäº†è¿™ä¸€å¤§æ®µï¼Œæ˜¯ä¸æ˜¯çªç„¶æœ‰ç‚¹æƒ³æ¶æ­»è‰¿è‰¿ï¼Œè¯´çš„ä»€ä¹ˆ XX ç©æ ·å•Šï¼å…¶å®ï¼Œåœ¨æˆ‘ä»¬åˆå­¦ SpringMVC çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼çš„å­¦å®Œã€‚éšç€æˆ‘ä»¬å¯¹ SpringMVC çš„æ—¥è¶‹ç†Ÿç»ƒï¼Œé€æ­¥å¯¹å…¶æä¾›çš„ç»„ä»¶ã€åŸç†ã€æºç æ…¢æ…¢ç†Ÿæ‚‰ã€‚æ‰€ä»¥ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´ï¼ŒWebFlux ä¹ƒè‡³å“åº”å¼ç¼–ç¨‹æ¥è¯´ï¼Œéƒ½æ˜¯è¶³å¤Ÿæ–°é¢–çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬è¦æŠ±ç€ç©ºæ¯å¿ƒæ€ï¼Œã€ŒStay Hungry, Stay Foolishã€ ã€‚

å¦‚æœèƒ–å‹çš„æ—¶é—´æ¯”è¾ƒå……åˆ†ï¼Œå¯ä»¥é€‰æ‹©æŠŠ [ã€ŠSpring æ–‡æ¡£ â€”â€” Web on Reactive Stackã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html) ä»”ç»†çœ‹çœ‹ï¼Œè¯¦å°½çš„ä»‹ç»äº† Spring åœ¨ Web æ–¹é¢ï¼Œå“åº”å¼ç›¸å…³çš„æŠ€æœ¯æ ˆã€‚

è™½ç„¶è¯´ä¸Šé¢æˆ‘ä»¬åœ¨ä»‹ç» WebFlux ï¼ŒæŠŠå®ƒæçš„å¾ˆå¤æ‚ï¼Œå®é™…åœ¨å¿«é€Ÿå…¥é—¨ä½¿ç”¨å®ƒï¼Œè¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚ä¸‹é¢ï¼Œå¼€å§‹è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„å¿«é€Ÿå…¥é—¨ä¸‹~

> è‰¿è‰¿ï¼šè€ƒè™‘åˆ°è‰¿è‰¿ä¹‹å‰å·²ç»å†™äº† [ã€ŠèŠ‹é“ Spring Boot SpringMVC å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/SpringMVC/?self) æ–‡ç« ï¼Œæ‰€ä»¥æœ¬æ–‡æˆ‘ä»¬æä¾›çš„ç¤ºä¾‹ï¼Œå°½é‡è¦†ç›–åˆ°åœ¨ SpringMVC æåˆ°çš„å†…å®¹ã€‚
>
> å½“ç„¶ï¼Œå¾ˆå¤šç›¸ä¼¼çš„æ¦‚å¿µï¼Œè‰¿è‰¿ä¹Ÿä¸é‡å¤ä»‹ç»ï¼Œä¸ç„¶æ˜¾å¾—æˆ‘è€å•°å—¦äº†ã€‚

# 2. å¿«é€Ÿå…¥é—¨

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-01](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01) ã€‚

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ [`spring-boot-starter-webflux`](https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-webflux) å®ç° WebFlux çš„è‡ªåŠ¨åŒ–é…ç½®ã€‚ç„¶åå®ç°ç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥æ¥å£ã€‚æ¥å£åˆ—è¡¨å¦‚ä¸‹ï¼š

| è¯·æ±‚æ–¹æ³• | URL             | åŠŸèƒ½                   |
| :------- | :-------------- | :--------------------- |
| `GET`    | `/users/list`   | æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨           |
| `GET`    | `/users/get`    | è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/add`    | æ·»åŠ ç”¨æˆ·               |
| `POST`   | `/users/update` | æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/delete` | åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |

ä¸‹é¢ï¼Œå¼€å§‹é¨æ¸¸~

## 2.1 å¼•å…¥ä¾èµ–

åœ¨ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/pom.xml) æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚



```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-27-webflux-01</artifactId>

    <dependencies>
        <!-- å®ç°å¯¹ Spring WebFlux çš„è‡ªåŠ¨åŒ–é…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>

        <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

    </dependencies>

</project>
```



- å…·ä½“æ¯ä¸ªä¾èµ–çš„ä½œç”¨ï¼Œèƒ–å‹è‡ªå·±è®¤çœŸçœ‹ä¸‹è‰¿è‰¿æ·»åŠ çš„æ‰€æœ‰æ³¨é‡Šå™¢ã€‚

æˆ‘ä»¬ä½¿ç”¨ [IDEA Maven æ’ä»¶](http://static.iocoder.cn/a37e002dadca75bc10237c0a0a30a12a) ï¼ŒæŸ¥çœ‹ä¸‹ `spring-boot-starter-webflux` ä¾èµ–ä¸­ï¼Œæ‰€å¼•å…¥çš„ä¾èµ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![IDEA Maven æ’ä»¶](http://www.iocoder.cn/images/Spring-Boot/2019-11-31/01.png)

- å¼•å…¥ [`reactor-core`](https://mvnrepository.com/artifact/io.projectreactor/reactor-core) ä¾èµ–ï¼Œä½¿ç”¨ Reactor ä½œä¸º WebFlux çš„å“åº”å¼æ¡†æ¶çš„åŸºç¡€ã€‚
- å¼•å…¥ [`spring-boot-starter-reactor-netty`](https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-reactor-netty) ä¾èµ–ï¼Œä½¿ç”¨ Netty æ„å»º WebFlux çš„ Web æœåŠ¡å™¨ã€‚å…¶ä¸­ [RxNetty](https://github.com/ReactiveX/RxNetty) åº“ï¼Œæ˜¯åŸºäº Reactor çš„å“åº”å¼æ¡†æ¶çš„åŸºç¡€ä¹‹ä¸Šï¼Œæä¾›å‡º Netty çš„å“åº”å¼ API ã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬é™¤äº†ä½¿ç”¨å¯ä»¥ä½¿ç”¨å…¶å®ƒä½œä¸º WebFlux çš„ Web æœåŠ¡å™¨ï¼Œå¦‚ä¸‹è¡¨æ ¼ï¼š

| Server name           | Server API used                                              | Reactive Streams support                                     |
| :-------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| Netty                 | Netty API                                                    | [Reactor Netty](https://github.com/reactor/reactor-netty)    |
| Undertow              | Undertow API                                                 | spring-web: Undertow to Reactive Streams bridge              |
| Tomcat                | Servlet 3.1 non-blocking I/O; Tomcat API to read and write ByteBuffers vs byte[] | spring-web: Servlet 3.1 non-blocking I/O to Reactive Streams bridge |
| Jetty                 | Servlet 3.1 non-blocking I/O; Jetty API to write ByteBuffers vs byte[] | spring-web: Servlet 3.1 non-blocking I/O to Reactive Streams bridge |
| Servlet 3.1 container | Servlet 3.1 non-blocking I/O                                 | spring-web: Servlet 3.1 non-blocking I/O to Reactive Streams bridge |

- å½“ç„¶ï¼Œä¹Ÿéœ€è¦åŸºäº Reactor çš„å“åº”å¼æ¡†æ¶çš„åŸºç¡€ä¹‹ä¸Šï¼Œå°è£…ç›¸åº”çš„å“åº”å¼ API ã€‚

å¯èƒ½èƒ–å‹ä¼šæœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆ WebFlux è¿è¡Œåœ¨ Servlet å®¹å™¨ä¸Šæ—¶ï¼Œéœ€è¦ **Servlet 3.1+** ä»¥ä¸Šçš„å®¹å™¨å‘¢ï¼Ÿåœ¨ [Servlet 3.1](https://zh.wikipedia.org/wiki/Java_Servlet) è§„èŒƒå‘å¸ƒæ—¶ï¼Œå®ƒå®šä¹‰äº†éå¸¸é‡è¦çš„ç‰¹æ€§ï¼ŒNon-blocking I/O éé˜»å¡ IO ï¼Œæä¾›äº†å¼‚æ­¥å¤„ç†è¯·æ±‚çš„æ”¯æŒã€‚æˆ‘ä»¬æ¥è¯¦ç»†å±•å¼€ä¸‹ï¼š

- åœ¨ Servlet 3.1 è§„èŒƒä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¯·æ±‚æ˜¯**åªèƒ½**è¢« Servlet åŒæ­¥é˜»å¡å¤„ç†å®Œæˆï¼Œè¿”å›ç»“æœç»™å‰ç«¯ã€‚
- åœ¨ Servlet 3.1 è§„èŒƒå¼€å§‹çš„ç‰ˆæœ¬ï¼Œè¯·æ±‚æ˜¯**å…è®¸**è¢« Servlet ä¸¢åˆ°çº¿ç¨‹æ± ä¸­å¤„æ‰§è¡Œï¼Œç­‰åˆ°æ‰§è¡Œå®Œæ¯•ï¼Œå¼‚æ­¥å›è°ƒç»“æœç»™ Servlet ï¼Œæœ€åè¿”å›ç»™å‰ç«¯ã€‚

> è‰¿è‰¿ï¼šæ¨èèƒ–å‹åœ¨é˜…è¯»å®Œæœ¬æ–‡ä¹‹åï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠServlet 3.0/3.1 ä¸­çš„å¼‚æ­¥å¤„ç†ã€‹](https://www.cnblogs.com/davenkin/p/async-servlet.html) æ–‡ç« ï¼Œå¯ä»¥å¯¹ WebFlux æœ‰æ›´å¥½çš„ç†è§£ã€‚

## 2.2 Application

åˆ›å»º [`Application.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/Application.java) ç±»ï¼Œé…ç½® `@SpringBootApplication` æ³¨è§£å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Application.java

@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```



- å…ˆæš‚æ—¶ä¸å¯åŠ¨é¡¹ç›®ã€‚ç­‰æˆ‘ä»¬æ·»åŠ å¥½ API æ¥å£ã€‚

åœ¨ [ã€Œ1.3 Spring WebFluxã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº† WebFlux æœ‰ä¸¤ç§ç¼–ç¨‹æ¨¡å‹ï¼Œåˆ†åˆ«æ˜¯ï¼š

- æ–¹å¼ä¸€ï¼ŒåŸºäº Annotated Controller æ–¹å¼å®ç°
- æ–¹å¼äºŒï¼ŒåŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼

æˆ‘ä»¬åˆ†åˆ«åœ¨ä¸‹é¢ä¸¤ä¸ªå°èŠ‚æ¥çœ‹çœ‹ã€‚

## 2.3 åŸºäº Annotated Controller æ–¹å¼å®ç°

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.controller`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserController.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserController.java

@RestController
@RequestMapping("/users")
public class UserController {

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/list")
    public Flux<UserVO> list() {
        // æŸ¥è¯¢åˆ—è¡¨
        List<UserVO> result = new ArrayList<>();
        result.add(new UserVO().setId(1).setUsername("yudaoyuanma"));
        result.add(new UserVO().setId(2).setUsername("woshiyutou"));
        result.add(new UserVO().setId(3).setUsername("chifanshuijiao"));
        // è¿”å›åˆ—è¡¨
        return Flux.fromIterable(result);
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get")
    public Mono<UserVO> get(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        UserVO user = new UserVO().setId(id).setUsername("username:" + id);
        // è¿”å›
        return Mono.just(user);
    }

    /**
     * æ·»åŠ ç”¨æˆ·
     *
     * @param addDTO æ·»åŠ ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ·»åŠ æˆåŠŸçš„ç”¨æˆ·ç¼–å·
     */
    @PostMapping("add")
    public Mono<Integer> add(@RequestBody Publisher<UserAddDTO> addDTO) {
        // æ’å…¥ç”¨æˆ·è®°å½•ï¼Œè¿”å›ç¼–å·
        Integer returnId = 1;
        // è¿”å›ç”¨æˆ·ç¼–å·
        return Mono.just(returnId);
    }

    /**
     * æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param updateDTO æ›´æ–°ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ˜¯å¦ä¿®æ”¹æˆåŠŸ
     */
    @PostMapping("/update")
    public Mono<Boolean> update(@RequestBody Publisher<UserUpdateDTO> updateDTO) {
        // æ›´æ–°ç”¨æˆ·è®°å½•
        Boolean success = true;
        // è¿”å›æ›´æ–°æ˜¯å¦æˆåŠŸ
        return Mono.just(success);
    }

    /**
     * åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return æ˜¯å¦åˆ é™¤æˆåŠŸ
     */
    @PostMapping("/delete") // URL ä¿®æ”¹æˆ /delete ï¼ŒRequestMethod æ”¹æˆ DELETE
    public Mono<Boolean> delete(@RequestParam("id") Integer id) {
        // åˆ é™¤ç”¨æˆ·è®°å½•
        Boolean success = false;
        // è¿”å›æ˜¯å¦æ›´æ–°æˆåŠŸ
        return Mono.just(success);
    }

}
```



- åœ¨ç±»å’Œæ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ äº† `@Controller` å’Œ SpringMVC åœ¨ä½¿ç”¨çš„ `@GetMapping` å’Œ `PostMapping` ç­‰æ³¨è§£ï¼Œæä¾› API æ¥å£ï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬åœ¨ä½¿ç”¨ SpringMVC æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚

- åœ¨ [`dto`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dto) å’Œ [`vo`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/vo) åŒ…ä¸‹ï¼Œæœ‰ API ä½¿ç”¨åˆ°çš„ DTO å’Œ VO ç±»ã€‚

- ğŸ˜ˆ å› ä¸ºæ˜¯å…¥é—¨ç¤ºä¾‹ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä»£ç ååˆ†ç®€å•ï¼Œä¿æŒæ·¡å®šã€‚åœ¨åæ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæä¾›å’Œ Spring Data JPAã€Spring Data MongoDBã€Spring Data Redis ç­‰ç­‰æ•´åˆçš„ç¤ºä¾‹ã€‚

- `#list()` æ–¹æ³•ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨ `Flux#fromIterable(Iterable<? extends T> it)` æ–¹æ³•ï¼Œå°† List åŒ…è£…æˆ Flux å¯¹è±¡è¿”å›ã€‚

- `#get(Integer id)` æ–¹æ³•ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨ `Mono#just(T data)` æ–¹æ³•ï¼Œå°† UserVO åŒ…è£…æˆ Mono å¯¹è±¡è¿”å›ã€‚

- `#add(Publisher<UserAddDTO> addDTO)` æ–¹æ³•ï¼Œå‚æ•°ä¸º [Publisher](https://www.reactive-streams.org/reactive-streams-1.0.0-javadoc/org/reactivestreams/Publisher.html) ç±»å‹ï¼Œæ³›å‹ä¸º UserAddDTO ç±»å‹ï¼Œå¹¶ä¸”æ·»åŠ äº† `@RequestBody` æ³¨è§£ï¼Œä» request çš„ Body ä¸­è¯»å–å‚æ•°ã€‚æ³¨æ„ï¼Œæ­¤æ—¶æäº¤å‚æ•°éœ€è¦ä½¿ç”¨ `"application/json"` ç­‰ Content-Type å†…å®¹ç±»å‹ã€‚

- `#add(...)` æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `application/x-www-form-urlencoded` æˆ– `multipart/form-data` è¿™ä¸¤ä¸ª Content-Type å†…å®¹ç±»å‹ï¼Œé€šè¿‡ request çš„ Form Data æˆ– Multipart Data ä¼ é€’å‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // UserController.java
  
  /**
   * æ·»åŠ ç”¨æˆ·
   *
   * @param addDTO æ·»åŠ ç”¨æˆ·ä¿¡æ¯ DTO
   * @return æ·»åŠ æˆåŠŸçš„ç”¨æˆ·ç¼–å·
   */
  @PostMapping("add2")
  public Mono<Integer> add(Mono<UserAddDTO> addDTO) {
      // æ’å…¥ç”¨æˆ·è®°å½•ï¼Œè¿”å›ç¼–å·
      Integer returnId = UUID.randomUUID().hashCode();
      // è¿”å›ç”¨æˆ·ç¼–å·
      return Mono.just(returnId);
  }
  ```

  

  - æ­¤æ—¶ï¼Œå‚æ•°ä¸º Mono ç±»å‹ï¼Œæ³›å‹ä¸º UserAddDTO ç±»å‹ã€‚
  - å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å‚æ•°ä¸º UserAddDTO ç±»å‹ã€‚å¦‚æœåç»­éœ€è¦ä½¿ç”¨åˆ° Reactor API ï¼Œåˆ™æˆ‘ä»¬è‡ªå·±ä¸»åŠ¨è°ƒç”¨ `Mono#just(T data)` æ–¹æ³•ï¼Œå°è£…å‡º Publisher å¯¹è±¡ã€‚ğŸ˜ˆ æ³¨æ„ï¼ŒFlux å’Œ Mono éƒ½å®ç°äº† Publisher æ¥å£ã€‚
  - å¯èƒ½æœ‰èƒ–å‹ä¸äº†è§£ request Form Dataã€Multipart Data å’Œ request Body çš„å·®å¼‚ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠHTTP è¯·æ±‚ä¸­ request payload å’Œ formData åŒºåˆ«ï¼Ÿã€‹](https://www.cnblogs.com/tugenhua0707/p/8975615.html) æ–‡ç« ã€‚
  - WebFlux å¯¹äº Form Data ï¼Œåœ¨ [ã€ŠWeb on Reactive Stack â€”â€” Spring WebFlux â€”â€” Form Dataã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-codecs-forms) æœ‰ç®€çŸ­è¯´æ˜ã€‚
  - WebFlux å¯¹äº Multipart Data ï¼Œåœ¨ [ã€ŠWeb on Reactive Stack â€”â€” Spring WebFlux â€”â€” Multipart Data ã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-codecs-multipart) æœ‰ç®€çŸ­è¯´æ˜ã€‚

- `#update(Publisher<UserUpdateDTO> updateDTO)` æ–¹æ³•ï¼Œå’Œ `#add(Publisher<UserAddDTO> addDTO)` æ–¹æ³•ä¸€è‡´ï¼Œå°±ä¸é‡å¤èµ˜è¿°ã€‚

- `#delete(Integer id)` æ–¹æ³•ï¼Œå’Œ `#get(Integer id)` æ–¹æ³•ä¸€è‡´ï¼Œå°±ä¸é‡å¤èµ˜è¿°ã€‚

## 2.4 åŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.controller`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserRouter](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserRouter.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserRouter.java

@Configuration
public class UserRouter {

    @Bean
    public RouterFunction<ServerResponse> userListRouterFunction() {
        return RouterFunctions.route(RequestPredicates.GET("/users2/list"),
                new HandlerFunction<ServerResponse>() {

                    @Override
                    public Mono<ServerResponse> handle(ServerRequest request) {
                        // æŸ¥è¯¢åˆ—è¡¨
                        List<UserVO> result = new ArrayList<>();
                        result.add(new UserVO().setId(1).setUsername("yudaoyuanma"));
                        result.add(new UserVO().setId(2).setUsername("woshiyutou"));
                        result.add(new UserVO().setId(3).setUsername("chifanshuijiao"));
                        // è¿”å›åˆ—è¡¨
                        return ServerResponse.ok().bodyValue(result);
                    }

                });
    }

    @Bean
    public RouterFunction<ServerResponse> userGetRouterFunction() {
        return RouterFunctions.route(RequestPredicates.GET("/users2/get"),
                new HandlerFunction<ServerResponse>() {

                    @Override
                    public Mono<ServerResponse> handle(ServerRequest request) {
                        // è·å¾—ç¼–å·
                        Integer id = request.queryParam("id")
                                .map(s -> StringUtils.isEmpty(s) ? null : Integer.valueOf(s)).get();
                        // æŸ¥è¯¢ç”¨æˆ·
                        UserVO user = new UserVO().setId(id).setUsername(UUID.randomUUID().toString());
                        // è¿”å›åˆ—è¡¨
                        return ServerResponse.ok().bodyValue(user);
                    }

                });
    }

    @Bean
    public RouterFunction<ServerResponse> demoRouterFunction() {
        return route(GET("/users2/demo"), request -> ok().bodyValue("demo"));
    }

}
```



- åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@Configuration` æ³¨è§£ï¼Œä¿è¯è¯¥ç±»ä¸­çš„ Bean ä»¬ï¼Œéƒ½è¢«æ‰«æåˆ°ã€‚

- åœ¨æ¯ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éƒ½é€šå¼„ [`RouterFunctions#route(RequestPredicate predicate, HandlerFunction handlerFunction)`](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/function/server/RouterFunctions.java) æ–¹æ³•ï¼Œå®šä¹‰äº†ä¸€æ¡è·¯ç”±ã€‚

  - ç¬¬ä¸€ä¸ªå‚æ•° `predicate` å‚æ•°ï¼Œæ˜¯ [RequestPredicate](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/function/server/RequestPredicate.java) ç±»å‹ï¼Œè¯·æ±‚è°“è¯­ï¼Œç”¨äºåŒ¹é…è¯·æ±‚ã€‚å¯ä»¥é€šè¿‡ [RequestPredicates](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/function/server/RequestPredicates.java) æ¥æ„å»ºå„ç§æ¡ä»¶ã€‚
  - ç¬¬äºŒä¸ªå‚æ•° `handlerFunction` å‚æ•°ï¼Œæ˜¯ [RouterFunction](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/function/server/RouterFunction.java) ç±»å‹ï¼Œå¤„ç†å™¨å‡½æ•°ã€‚

- æ¯ä¸ªæ–¹æ³•å®šä¹‰çš„è·¯ç”±ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹ä»£ç ï¼Œä¸€çœ¼èƒ½çœ‹çš„æ˜ç™½ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé‡‡ç”¨ç¬¬ä¸‰ä¸ªæ–¹æ³•çš„å†™æ³•ï¼Œæ›´åŠ ç®€æ´ã€‚æ³¨æ„ï¼Œéœ€è¦ä½¿ç”¨ `static import` é™æ€å¼•å…¥ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  import static org.springframework.web.reactive.function.server.RequestPredicates.*;
  import static org.springframework.web.reactive.function.server.RouterFunctions.*;
  import static org.springframework.web.reactive.function.server.ServerResponse.*;
  ```

  

ä¸€èˆ¬æ¥è¯´ï¼Œè‰¿è‰¿æ›´åŠ æ¨è**åŸºäº Annotated Controller æ–¹å¼å®ç°**çš„ç¼–ç¨‹æ–¹å¼ï¼Œæ›´ç¬¦åˆæˆ‘ä»¬ç°åœ¨çš„å¼€å‘ä¹ æƒ¯ï¼Œå­¦ä¹ æˆæœ¬ä¹Ÿç›¸å¯¹ä½ä¸€äº›ã€‚åŒæ—¶ï¼Œå’Œ API æ¥å£æ–‡æ¡£å·¥å…· Swagger ä¹Ÿæ›´å®¹æ˜“é›†æˆã€‚

ğŸ˜ˆ æœ‰æ²¡è§‰å¾—æ¯ä¸ª HandlerFunction å‡½æ•°ï¼Œå’Œæ¯ä¸ª [Servlet](https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/Servlet.java) æœ‰ç‚¹åƒã€‚

æ›´å¤šåŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼çš„ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹çœ‹å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€ŠIntroduction to the Functional Web Framework in Spring 5ã€‹](https://www.baeldung.com/spring-5-functional-web)
- [ã€ŠSpring Boot RouterFunction tutorialã€‹](http://zetcode.com/springboot/routerfunction/)

# 3. æµ‹è¯•æ¥å£

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-01](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01) ã€‚

åœ¨å¼€å‘å®Œæ¥å£ï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œæ¥å£çš„è‡ªæµ‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å…ˆå¯åŠ¨é¡¹ç›®ï¼Œç„¶åä½¿ç”¨ [Postman](https://www.getpostman.com/)ã€[curl](https://curl.haxx.se/)ã€æµè§ˆå™¨ï¼Œæ‰‹å·¥æ¨¡æ‹Ÿè¯·æ±‚åç«¯ API æ¥å£ã€‚

å®é™…ä¸Šï¼ŒWebFlux æä¾›äº† Web æµ‹è¯•å®¢æˆ·ç«¯ [WebTestClient](https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/web/reactive/server/WebTestClient.java) ç±»ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¿«é€Ÿæµ‹è¯•æ¥å£ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å¯¹ [UserController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserController.java) æä¾›çš„æ¥å£ï¼Œè¿›è¡Œä¸‹å•å…ƒæµ‹è¯•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬å°èŠ‚ï¼Œæˆ‘ä»¬ä¼šç»§ç»­åœ¨ [lab-27-webflux-01](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01) ç¤ºä¾‹çš„åŸºç¡€ä¸Šä¿®æ”¹ã€‚

MockMvc æä¾›äº†é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯•çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬åˆ†æˆ [ã€Œ3.1 é›†æˆæµ‹è¯•ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) å’Œ [ã€Œ3.2 å•å…ƒæµ‹è¯•ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ¥çœ‹ã€‚å¦‚æœèƒ–å‹å¯¹æµ‹è¯•è¿™å—ä¸å¤ªäº†è§£ï¼Œå¯ä»¥çœ‹çœ‹å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€Šå°è°ˆ Java å•å…ƒæµ‹è¯•ã€‹](http://www.iocoder.cn/Fight/A-little-bit-about-Java-unit-testing/?self)
- [ã€Šè°ˆè°ˆå•å…ƒæµ‹è¯•ã€‹](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/?self)

## 3.1 é›†æˆæµ‹è¯•

åˆ›å»º [UserControllerTest](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/src/test/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserControllerTest.java) æµ‹è¯•ç±»ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ç®€å•çš„ UserController çš„æ¯ä¸ªæ“ä½œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š



```
// UserControllerTest.java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
@AutoConfigureWebFlux
@AutoConfigureWebTestClient
public class UserControllerTest {

    @Autowired
    private WebTestClient webClient;

    @Test
    public void testList() {
        webClient.get().uri("/users/list")
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody().json("[\n" +
                "    {\n" +
                "        \"id\": 1,\n" +
                "        \"username\": \"yudaoyuanma\"\n" +
                "    },\n" +
                "    {\n" +
                "        \"id\": 2,\n" +
                "        \"username\": \"woshiyutou\"\n" +
                "    },\n" +
                "    {\n" +
                "        \"id\": 3,\n" +
                "        \"username\": \"chifanshuijiao\"\n" +
                "    }\n" +
                "]"); // å“åº”ç»“æœ
    }

    @Test
    public void testGet() {
        // è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
        webClient.get().uri("/users/get?id=1")
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody().json("{\n" +
                "    \"id\": 1,\n" +
                "    \"username\": \"username:1\"\n" +
                "}"); // å“åº”ç»“æœ
    }

    @Test
    public void testGet2() {
        // è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
        webClient.get().uri("/users/v2/get?id=1")
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody().json("{\n" +
                "    \"id\": 1,\n" +
                "    \"username\": \"test\"\n" +
                "}"); // å“åº”ç»“æœ
    }

    @Test
    public void testAdd() {
        Map<String, Object> params = new HashMap<>();
        params.put("username", "yudaoyuanma");
        params.put("password", "nicai");
        // æ·»åŠ ç”¨æˆ·
        webClient.post().uri("/users/add")
                .bodyValue(params)
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody().json("1"); // å“åº”ç»“æœã€‚å› ä¸ºæ²¡æœ‰æä¾› content çš„æ¯”è¾ƒï¼Œæ‰€ä»¥åªå¥½ä½¿ç”¨ json æ¥æ¯”è¾ƒã€‚ç«Ÿç„¶èƒ½é€šè¿‡
    }

    @Test
    public void testAdd2() { // å‘é€æ–‡ä»¶çš„æµ‹è¯•ï¼Œå¯ä»¥å‚è€ƒ https://dev.to/shavz/sending-multipart-form-data-using-spring-webtestclient-2gb7 æ–‡ç« 
        BodyInserters.FormInserter<String> formData = // Form Data æ•°æ®ï¼Œéœ€è¦è¿™ä¹ˆæ‹¼å‡‘
                BodyInserters.fromFormData("username", "yudaoyuanma")
                .with("password", "nicai");
        // æ·»åŠ ç”¨æˆ·
        webClient.post().uri("/users/add2")
                .body(formData)
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody().json("1"); // å“åº”ç»“æœã€‚å› ä¸ºæ²¡æœ‰æä¾› content çš„æ¯”è¾ƒï¼Œæ‰€ä»¥åªå¥½ä½¿ç”¨ json æ¥æ¯”è¾ƒã€‚ç«Ÿç„¶èƒ½é€šè¿‡
    }


    @Test
    public void testUpdate() {
        Map<String, Object> params = new HashMap<>();
        params.put("id", 1);
        params.put("username", "yudaoyuanma");
        // ä¿®æ”¹ç”¨æˆ·
        webClient.post().uri("/users/update")
                .bodyValue(params)
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody(Boolean.class) // æœŸæœ›è¿”å›å€¼ç±»å‹æ˜¯ Boolean
                .consumeWith((Consumer<EntityExchangeResult<Boolean>>) result -> // é€šè¿‡æ¶ˆè´¹ç»“æœï¼Œåˆ¤æ–­ç¬¦åˆæ˜¯ true ã€‚
                        Assert.assertTrue("è¿”å›ç»“æœéœ€è¦ä¸º true", result.getResponseBody()));
    }

    @Test
    public void testDelete() {
        // åˆ é™¤ç”¨æˆ·
        webClient.post().uri("/users/delete?id=1")
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody(Boolean.class) // æœŸæœ›è¿”å›å€¼ç±»å‹æ˜¯ Boolean
                .isEqualTo(true); // è¿™æ ·æ›´åŠ ç®€æ´ä¸€äº›
//                .consumeWith((Consumer<EntityExchangeResult<Boolean>>) result -> // é€šè¿‡æ¶ˆè´¹ç»“æœï¼Œåˆ¤æ–­ç¬¦åˆæ˜¯ true ã€‚
//                        Assert.assertTrue("è¿”å›ç»“æœéœ€è¦ä¸º true", result.getResponseBody()));
    }

}
```



- åœ¨ç±»ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ äº† `@AutoConfigureWebTestClient` æ³¨è§£ï¼Œç”¨äºè‡ªåŠ¨åŒ–é…ç½®æˆ‘ä»¬ç¨åæ³¨å…¥çš„ WebTestClient Bean å¯¹è±¡ `webClient` ã€‚åœ¨åç»­çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°éƒ½æ˜¯é€šè¿‡ `webClient` è°ƒç”¨åç«¯ API æ¥å£ã€‚è€Œæ¯ä¸€æ¬¡è°ƒç”¨åç«¯ API æ¥å£ï¼Œéƒ½ä¼šæ‰§è¡Œ**çœŸæ­£çš„åç«¯é€»è¾‘**ã€‚å› æ­¤ï¼Œæ•´ä¸ªé€»è¾‘ï¼Œèµ°çš„æ˜¯**é›†æˆæµ‹è¯•**ï¼Œä¼šå¯åŠ¨ä¸€ä¸ª**çœŸå®**çš„ Spring ç¯å¢ƒã€‚

- æ¯æ¬¡ API æ¥å£çš„è¯·æ±‚ï¼Œéƒ½é€šè¿‡

   

  RequestHeadersSpec

   

  æ¥æ„å»ºã€‚æ„å»ºå®Œæˆåï¼Œé€šè¿‡

   

  ```
  RequestHeadersSpec#exchange()
  ```

   

  æ–¹æ³•æ¥æ‰§è¡Œè¯·æ±‚ï¼Œè¿”å›

   

  ResponseSpec

   

  ç»“æœã€‚

  - WebTestClient çš„ `#get()`ã€`#head()`ã€`#delete()`ã€`#options()` æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ [RequestHeadersUriSpec](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/reactive/function/client/WebClient.RequestHeadersUriSpec.html) å¯¹è±¡ã€‚
  - WebTestClient çš„ `#post()`ã€`#put()`ã€`#delete()`ã€`#patch()` æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ [RequestBodyUriSpec](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/reactive/function/client/WebClient.RequestBodyUriSpec.html) å¯¹è±¡ã€‚
  - RequestHeadersUriSpec å’Œ RequestBodyUriSpec éƒ½ç»§æ‰¿äº† RequestHeadersSpec æ¥å£ã€‚

- æ‰§è¡Œå®Œè¯·æ±‚åï¼Œé€šè¿‡è°ƒç”¨ [RequestBodyUriSpec](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/reactive/function/client/WebClient.RequestBodyUriSpec.html) çš„å„ç§æ–­è¨€æ–¹æ³•ï¼Œæ·»åŠ å¯¹ç»“æœçš„é¢„æœŸï¼Œç›¸å½“äºåšæ–­è¨€ã€‚å¦‚æœä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæµ‹è¯•ä¸é€šè¿‡ã€‚

## 3.2 å•å…ƒæµ‹è¯•

ä¸ºäº†æ›´å¥½çš„å±•ç¤º WebFlux å•å…ƒæµ‹è¯•çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å†™ UserController çš„ä»£ç ï¼Œè®©å…¶ä¼šä¾èµ– UserService ã€‚ä¿®æ”¹ç‚¹å¦‚ä¸‹ï¼š

- åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.service`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/service) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserService](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-01/src/main/java/cn/iocoder/springboot/lab27/springwebflux/service/UserService.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // UserService.java
  
  @Service
  public class UserService {
  
      public UserVO get(Integer id) {
          return new UserVO().setId(id).setUsername("test");
      }
  
  }
  ```

  

- åœ¨ [UserController](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) ç±»ä¸­ï¼Œå¢åŠ  `GET /users/v2/get` æ¥å£ï¼Œè·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // UserController.java
  
  @Autowired
  private UserService userService;
  
  /**
   * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
   *
   * @param id ç”¨æˆ·ç¼–å·
   * @return ç”¨æˆ·
   */
  @GetMapping("/v2/get")
  public Mono<UserVO> get2(@RequestParam("id") Integer id) {
      // æŸ¥è¯¢ç”¨æˆ·
      UserVO user = userService.get(id);
      // è¿”å›
      return Mono.just(user);
  }
  ```

  

  - åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥äº† UserService Bean å¯¹è±¡ `userService` ï¼Œç„¶ååœ¨æ–°å¢çš„æ¥å£æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ `UserService#get(Integer id)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·ã€‚

åˆ›å»º [UserControllerTest2](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/src/test/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserControllerTest2.java) æµ‹è¯•ç±»ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ç®€å•çš„ UserController çš„æ–°å¢çš„è¿™ä¸ª API æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserControllerTest2.java

@RunWith(SpringRunner.class)
@WebFluxTest(UserController.class)
public class UserControllerTest2 {

    @Autowired
    private WebTestClient webClient;

    @MockBean
    private UserService userService;

    @Test
    public void testGet2() throws Exception {
        // Mock UserService çš„ get æ–¹æ³•
        System.out.println("before mock:" + userService.get(1)); // <1.1>
        Mockito.when(userService.get(1)).thenReturn(
                new UserVO().setId(1).setUsername("username:1")); // <1.2>
        System.out.println("after mock:" + userService.get(1)); // <1.3>

        // æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
        webClient.get().uri("/users/v2/get?id=1")
                .exchange() // æ‰§è¡Œè¯·æ±‚
                .expectStatus().isOk() // å“åº”çŠ¶æ€ç  200
                .expectBody().json("{\n" +
                "    \"id\": 1,\n" +
                "    \"username\": \"username:1\"\n" +
                "}"); // å“åº”ç»“æœ
    }

}
```



- åœ¨ç±»ä¸Šæ·»åŠ  [`@WebFluxTest`](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-test-autoconfigure/src/main/java/org/springframework/boot/test/autoconfigure/web/reactive/WebFluxTest.java) æ³¨è§£ï¼Œå¹¶ä¸”ä¼ å…¥çš„æ˜¯ UserController ç±»ï¼Œè¡¨ç¤ºæˆ‘ä»¬è¦å¯¹ UserController è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚
- åŒæ—¶ï¼Œ`@WebFluxTest` æ³¨è§£ï¼Œæ˜¯åŒ…å«äº† `@UserController` çš„ç»„åˆæ³¨è§£ï¼Œæ‰€ä»¥å®ƒä¼šè‡ªåŠ¨åŒ–é…ç½®æˆ‘ä»¬ç¨åæ³¨å…¥çš„ WebTestClient Bean å¯¹è±¡ `mvc` ã€‚åœ¨åç»­çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°éƒ½æ˜¯é€šè¿‡ `webClient` è°ƒç”¨åç«¯ API æ¥å£ã€‚**ä½†æ˜¯**ï¼æ¯ä¸€æ¬¡è°ƒç”¨åç«¯ API æ¥å£ï¼Œå¹¶**ä¸ä¼š**æ‰§è¡Œ**çœŸæ­£çš„åç«¯é€»è¾‘**ï¼Œè€Œæ˜¯èµ°çš„ Mock é€»è¾‘ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ªé€»è¾‘ï¼Œèµ°çš„æ˜¯**å•å…ƒæµ‹è¯•**ï¼Œ**åª**ä¼šå¯åŠ¨ä¸€ä¸ª **Mock** çš„ Spring ç¯å¢ƒã€‚

> è‰¿è‰¿ï¼šæ³¨æ„ä¸Šé¢æ¯ä¸ª**åŠ ç²—**çš„åœ°æ–¹ï¼

- ```
  userService
  ```

   

  å±æ€§ï¼Œæˆ‘ä»¬æ·»åŠ äº†

   

  `@MockBean`

   

  æ³¨è§£ï¼Œå®é™…è¿™é‡Œæ³¨å…¥çš„æ˜¯ä¸€ä¸ªä½¿ç”¨

   

  Mockito

   

  åˆ›å»ºçš„ UserService Mock ä»£ç†å¯¹è±¡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

  

  - UserController ä¸­ï¼Œä¹Ÿä¼šæ³¨å…¥ä¸€ä¸ª UserService å±æ€§ï¼Œæ­¤æ—¶æ³¨å…¥çš„å°±æ˜¯è¯¥ Mock å‡ºæ¥çš„ UserService Bean å¯¹è±¡ã€‚

  - é»˜è®¤æƒ…å†µä¸‹ï¼Œ

  - `<1.1>` å¤„ï¼Œæˆ‘ä»¬è°ƒç”¨ `UserService#get(Integer id)` æ–¹æ³•ï¼Œç„¶åæ‰“å°è¿”å›ç»“æœã€‚æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

    ```
    before mock:null
    ```

    

    - ç»“æœç«Ÿç„¶è¿”å›çš„æ˜¯ `null` ç©ºã€‚ç†è®ºæ¥è¯´ï¼Œæ­¤æ—¶åº”è¯¥è¿”å›ä¸€ä¸ª `id = 1` çš„ UserVO å¯¹è±¡ã€‚å®é™…ä¸Šï¼Œå› ä¸ºæ­¤æ—¶çš„ `userService` æ˜¯é€šè¿‡ Mockito æ¥ Mock å‡ºæ¥çš„å¯¹è±¡ï¼Œå…¶æ‰€æœ‰è°ƒç”¨å®ƒçš„æ–¹æ³•ï¼Œè¿”å›çš„éƒ½æ˜¯ç©ºã€‚

  - `<1.2>` å¤„ï¼Œé€šè¿‡ Mockito è¿›è¡Œ Mock `userService` çš„ `#get(Integer id)` æ–¹æ³•ï¼Œå½“ä¼ å…¥çš„ `id = 1` æ–¹æ³•å‚æ•°æ—¶ï¼Œè¿”å› `id = 1` å¹¶ä¸” `username = "username:1"` çš„ UserVO å¯¹è±¡ã€‚

  - `<1.3>` å¤„ï¼Œå†æ¬¡è°ƒç”¨ `UserService#get(Integer id)` æ–¹æ³•ï¼Œç„¶åæ‰“å°è¿”å›ç»“æœã€‚æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

    ```
    after cn.iocoder.springboot.lab27.springwebflux.vo.UserVO@23202c31
    ```

    

    - æ‰“å°çš„å°±æ˜¯æˆ‘ä»¬ Mock è¿”å›çš„ UserVO å¯¹è±¡ã€‚

- åç»­ï¼Œä½¿ç”¨ `webClient` å®Œæˆä¸€æ¬¡åç«¯ API è°ƒç”¨ï¼Œå¹¶è¿›è¡Œæ–­è¨€ç»“æœæ˜¯å¦æ­£ç¡®ã€‚æ‰§è¡ŒæˆåŠŸï¼Œå•å…ƒæµ‹è¯•é€šè¿‡ã€‚

å¯èƒ½èƒ–å‹å¯¹å•å…ƒæµ‹è¯•ä¸æ˜¯å¾ˆäº†è§£ï¼Œè¿™é‡Œåœ¨é¢å¤–æ¨èä¸€æœ¬ä¹¦ [ã€Šæœ‰æ•ˆçš„å•å…ƒæµ‹è¯•ã€‹](https://union-click.jd.com/jdc?d=3kDmSB) ã€‚å¾ˆè–„ï¼Œå‘¨æœ«æŠ½å‡ ä¸ªå°æ—¶å°±èƒ½è¯»å®Œã€‚

å¦‚æœè§‰å¾—æœ¬å°èŠ‚è¿˜ä¸å¤Ÿï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠSpringBoot WebFlux Test â€“ @WebFluxTestã€‹](https://grokonez.com/testing/springboot-webflux-test-webfluxtest) æ–‡ç« ï¼Œå†™çš„è¿˜æ˜¯ä¸é”™çš„ã€‚

# 4. å…¨å±€ç»Ÿä¸€è¿”å›

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02) ã€‚

åœ¨æˆ‘ä»¬æä¾›åç«¯ API ç»™å‰ç«¯æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šå‰ç«¯ï¼Œè¿™ä¸ª API è°ƒç”¨ç»“æœæ˜¯å¦æˆåŠŸï¼š

- å¦‚æœ**æˆåŠŸ**ï¼ŒæˆåŠŸçš„æ•°æ®æ˜¯ä»€ä¹ˆã€‚åç»­ï¼Œå‰ç«¯ä¼šå–æ•°æ®æ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚
- å¦‚æœ**å¤±è´¥**ï¼Œå¤±è´¥çš„åŸå› æ˜¯ä»€ä¹ˆã€‚ä¸€èˆ¬ï¼Œå‰ç«¯ä¼šå°†åŸå› å¼¹å‡ºæç¤ºç»™ç”¨æˆ·ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å°±éœ€è¦æœ‰ç»Ÿä¸€çš„è¿”å›ç»“æœï¼Œè€Œä¸èƒ½æ˜¯æ¯ä¸ªæ¥å£è‡ªå·±å®šä¹‰è‡ªå·±çš„é£æ ¼ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç»Ÿä¸€çš„å…¨å±€è¿”å›ä¿¡æ¯å¦‚ä¸‹ï¼š

- æˆåŠŸæ—¶ï¼Œè¿”å›**æˆåŠŸçš„çŠ¶æ€ç ** + **æ•°æ®**ã€‚
- å¤±è´¥æ—¶ï¼Œè¿”å›**å¤±è´¥çš„çŠ¶æ€ç ** + **é”™è¯¯æç¤º**ã€‚

åœ¨æ ‡å‡†çš„ RESTful API çš„å®šä¹‰ï¼Œæ˜¯æ¨èä½¿ç”¨ [HTTP å“åº”çŠ¶æ€ç ](https://zh.wikipedia.org/wiki/HTTPçŠ¶æ€ç ) è¿”å›çŠ¶æ€ç ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å®è·µå¾ˆå°‘è¿™ä¹ˆå»åšï¼Œä¸»è¦æœ‰å¦‚ä¸‹åŸå› ï¼š

- ä¸šåŠ¡è¿”å›çš„é”™è¯¯çŠ¶æ€ç å¾ˆå¤šï¼ŒHTTP å“åº”çŠ¶æ€ç æ— æ³•å¾ˆå¥½çš„æ˜ å°„ã€‚ä¾‹å¦‚è¯´ï¼Œæ´»åŠ¨è¿˜æœªå¼€å§‹ã€è®¢å•å·²å–æ¶ˆç­‰ç­‰ã€‚
- å›½å†…å¼€å‘è€…å¯¹ HTTP å“åº”çŠ¶æ€ç ä¸æ˜¯å¾ˆäº†è§£ï¼Œå¯èƒ½åªçŸ¥é“ 200ã€403ã€404ã€500 å‡ ç§å¸¸è§çš„ã€‚è¿™æ ·ï¼Œåå€’å¢åŠ å­¦ä¹ æˆæœ¬ã€‚

æ‰€ä»¥ï¼Œå®é™…é¡¹ç›®åœ¨å®è·µæ—¶ï¼Œæˆ‘ä»¬ä¼šå°†çŠ¶æ€ç æ”¾åœ¨ Response Body **å“åº”å†…å®¹**ä¸­è¿”å›ã€‚

åœ¨å…¨å±€ç»Ÿä¸€è¿”å›é‡Œï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦å®šä¹‰ä¸‰ä¸ªå­—æ®µï¼š

- `code`ï¼šçŠ¶æ€ç ã€‚æ— è®ºæ˜¯å¦æˆåŠŸï¼Œå¿…é¡»è¿”å›ã€‚

  - æˆåŠŸæ—¶ï¼ŒçŠ¶æ€ç ä¸º 0 ã€‚
  - å¤±è´¥æ—¶ï¼Œå¯¹åº”ä¸šåŠ¡çš„é”™è¯¯ç ã€‚

  > å…³äºè¿™ä¸€å—ï¼Œä¹Ÿæœ‰å›¢é˜Ÿå®è·µæ—¶ï¼Œå¢åŠ äº† `success` å­—æ®µï¼Œé€šè¿‡ `true` å’Œ `false` è¡¨ç¤ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚è¿™ä¸ªçœ‹æ¯ä¸ªå›¢é˜Ÿçš„ä¹ æƒ¯å§ã€‚è‰¿è‰¿çš„è¯ï¼Œè¿˜æ˜¯åå¥½åŸºäºçº¦å®šï¼Œè¿”å› 0 æ—¶è¡¨ç¤ºæˆåŠŸã€‚

- `data`ï¼šæ•°æ®ã€‚æˆåŠŸæ—¶ï¼Œè¿”å›è¯¥å­—æ®µã€‚

- `message`ï¼šé”™è¯¯æç¤ºã€‚å¤±è´¥æ—¶ï¼Œè¿”å›è¯¥å­—æ®µã€‚

é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªç¤ºä¾‹ï¼š



```
// æˆåŠŸå“åº”
{
    code: 0,
    data: {
        id: 1,
        username: "yudaoyuanma"
    }
}

// å¤±è´¥å“åº”
{
    code: 233666,
    message: "å¾å¦ˆå¤ªä¸‘äº†"
}
```



ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ã€‚

> è‰¿è‰¿ï¼šè€ƒè™‘åˆ°ä¸ç ´å [ã€Œ2. å¿«é€Ÿå…¥é—¨ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) å’Œ [ã€Œ3. æµ‹è¯•æ¥å£ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æä¾›çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å¼„æ­å»ºä¸€ä¸ªã€‚

## 4.1 å¼•å…¥ä¾èµ–

åœ¨ [ã€Œ2.2 å¼•å…¥ä¾èµ–ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) ä¸€è‡´ã€‚

## 4.2 Application

åœ¨ [ã€Œ2.3 Applicationã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) ä¸€è‡´ã€‚

## 4.3 CommonResult

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.core.vo`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/vo) åŒ…è·¯å¾„ï¼Œåˆ›å»º [CommonResult](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/vo/CommonResult.java) ç±»ï¼Œç”¨äºå…¨å±€ç»Ÿä¸€è¿”å›ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// CommonResult.java

public class CommonResult<T> implements Serializable {

    public static Integer CODE_SUCCESS = 0;

    /**
     * é”™è¯¯ç 
     */
    private Integer code;
    /**
     * é”™è¯¯æç¤º
     */
    private String message;
    /**
     * è¿”å›æ•°æ®
     */
    private T data;

    /**
     * å°†ä¼ å…¥çš„ result å¯¹è±¡ï¼Œè½¬æ¢æˆå¦å¤–ä¸€ä¸ªæ³›å‹ç»“æœçš„å¯¹è±¡
     *
     * å› ä¸º A æ–¹æ³•è¿”å›çš„ CommonResult å¯¹è±¡ï¼Œä¸æ»¡è¶³è°ƒç”¨å…¶çš„ B æ–¹æ³•çš„è¿”å›ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œè½¬æ¢ã€‚
     *
     * @param result ä¼ å…¥çš„ result å¯¹è±¡
     * @param <T> è¿”å›çš„æ³›å‹
     * @return æ–°çš„ CommonResult å¯¹è±¡
     */
    public static <T> CommonResult<T> error(CommonResult<?> result) {
        return error(result.getCode(), result.getMessage());
    }

    public static <T> CommonResult<T> error(Integer code, String message) {
        Assert.isTrue(!CODE_SUCCESS.equals(code), "code å¿…é¡»æ˜¯é”™è¯¯çš„ï¼");
        CommonResult<T> result = new CommonResult<>();
        result.code = code;
        result.message = message;
        return result;
    }

    public static <T> CommonResult<T> success(T data) {
        CommonResult<T> result = new CommonResult<>();
        result.code = CODE_SUCCESS;
        result.data = data;
        result.message = "";
        return result;
    }

    @JsonIgnore // å¿½ç•¥ï¼Œé¿å… jackson åºåˆ—åŒ–ç»™å‰ç«¯
    public boolean isSuccess() { // æ–¹ä¾¿åˆ¤æ–­æ˜¯å¦æˆåŠŸ
        return CODE_SUCCESS.equals(code);
    }

    @JsonIgnore // å¿½ç•¥ï¼Œé¿å… jackson åºåˆ—åŒ–ç»™å‰ç«¯
    public boolean isError() { // æ–¹ä¾¿åˆ¤æ–­æ˜¯å¦å¤±è´¥
        return !isSuccess();
    }

    // ... çœç•¥ setting/getting/toString æ–¹æ³•

}
```



- æ¯ä¸ªå­—æ®µï¼Œèƒ–å‹è‡ªå·±çœ‹ç›¸åº”çš„æ³¨é‡Šã€‚

## 4.4 GlobalResponseBodyHandler

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.core.web`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/web) åŒ…è·¯å¾„ï¼Œåˆ›å»º [GlobalResponseBodyHandler](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/web/GlobalResponseBodyHandler.java) ç±»ï¼Œå…¨å±€ç»Ÿä¸€è¿”å›çš„å¤„ç†å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// GlobalResponseBodyHandler.java

public class GlobalResponseBodyHandler extends ResponseBodyResultHandler {

    private static Logger LOGGER = LoggerFactory.getLogger(GlobalResponseBodyHandler.class);

    private static MethodParameter METHOD_PARAMETER_MONO_COMMON_RESULT;

    private static final CommonResult COMMON_RESULT_SUCCESS = CommonResult.success(null);

    static {
        try {
            // <1> è·å¾— METHOD_PARAMETER_MONO_COMMON_RESULT ã€‚å…¶ä¸­ -1 è¡¨ç¤º `#methodForParams()` æ–¹æ³•çš„è¿”å›å€¼
            METHOD_PARAMETER_MONO_COMMON_RESULT = new MethodParameter(
                    GlobalResponseBodyHandler.class.getDeclaredMethod("methodForParams"), -1);
        } catch (NoSuchMethodException e) {
            LOGGER.error("[static][è·å– METHOD_PARAMETER_MONO_COMMON_RESULT æ—¶ï¼Œæ‰¾ä¸éƒ½æ–¹æ³•");
            throw new RuntimeException(e);
        }
    }

    public GlobalResponseBodyHandler(List<HttpMessageWriter<?>> writers, RequestedContentTypeResolver resolver) {
        super(writers, resolver);
    }

    public GlobalResponseBodyHandler(List<HttpMessageWriter<?>> writers, RequestedContentTypeResolver resolver, ReactiveAdapterRegistry registry) {
        super(writers, resolver, registry);
    }

    @Override
    @SuppressWarnings("unchecked")
    public Mono<Void> handleResult(ServerWebExchange exchange, HandlerResult result) {
        Object returnValue = result.getReturnValue();
        Object body;
        // <1.1> å¤„ç†è¿”å›ç»“æœä¸º Mono çš„æƒ…å†µ
        if (returnValue instanceof Mono) {
            body = ((Mono<Object>) result.getReturnValue())
                    .map((Function<Object, Object>) GlobalResponseBodyHandler::wrapCommonResult)
                    .defaultIfEmpty(COMMON_RESULT_SUCCESS);
        // <1.2> å¤„ç†è¿”å›ç»“æœä¸º Flux çš„æƒ…å†µ
        } else if (returnValue instanceof Flux) {
            body = ((Flux<Object>) result.getReturnValue())
                    .collectList()
                    .map((Function<Object, Object>) GlobalResponseBodyHandler::wrapCommonResult)
                    .defaultIfEmpty(COMMON_RESULT_SUCCESS);
        // <1.3> å¤„ç†ç»“æœä¸ºå…¶å®ƒç±»å‹
        } else {
            body = wrapCommonResult(returnValue);
        }
        // <2>
        return writeBody(body, METHOD_PARAMETER_MONO_COMMON_RESULT, exchange);
    }

    private static Mono<CommonResult> methodForParams() {
        return null;
    }

    private static CommonResult<?> wrapCommonResult(Object body) {
        // å¦‚æœå·²ç»æ˜¯ CommonResult ç±»å‹ï¼Œåˆ™ç›´æ¥è¿”å›
        if (body instanceof CommonResult) {
            return (CommonResult<?>) body;
        }
        // å¦‚æœä¸æ˜¯ï¼Œåˆ™åŒ…è£…æˆ CommonResult ç±»å‹
        return CommonResult.success(body);
    }

}
```



- ç»§æ‰¿ WebFlux çš„ [ResponseBodyResultHandler](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/result/method/annotation/ResponseBodyResultHandler.java) ç±»ï¼Œå› ä¸ºè¯¥ç±»å°† Response çš„ body å†™å›ç»™å‰ç«¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é€šè¿‡é‡å†™è¯¥ç±»çš„ `#handleResult(ServerWebExchange exchange, HandlerResult result)` æ–¹æ³•ï¼Œå°†è¿”å›ç»“æœè¿›è¡Œä½¿ç”¨ CommonResult åŒ…è£…ã€‚

- `<1>` å¤„ï¼Œè·å¾— `METHOD_PARAMETER_MONO_COMMON_RESULT` ã€‚å…¶ä¸­ `-1` è¡¨ç¤º `#methodForParams()` æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ `Mono<CommonResult>` ã€‚åç»­æˆ‘ä»¬åœ¨`#handleResult(ServerWebExchange exchange, HandlerResult result)` æ–¹æ³•ä¸­ï¼Œä¼šä½¿ç”¨åˆ° `METHOD_PARAMETER_MONO_COMMON_RESULT` ã€‚

- é‡å†™

   

  ```
  #handleResult(ServerWebExchange exchange, HandlerResult result)
  ```

   

  æ–¹æ³•ï¼Œå°†è¿”å›ç»“æœè¿›è¡Œä½¿ç”¨ CommonResult åŒ…è£…ã€‚

  - `<1.1>` å¤„ï¼Œå¤„ç†è¿”å›ç»“æœä¸º Mono çš„æƒ…å†µã€‚é€šè¿‡è°ƒç”¨ `Mono#map(Function<? super T, ? extends R> mapper)` æ–¹æ³•ï¼Œå°†åŸè¿”å›ç»“æœï¼Œè¿›è¡ŒåŒ…è£…æˆ `CommonResult<?>` ã€‚
  - `<1.2>` å¤„ï¼Œå¤„ç†è¿”å›ç»“æœä¸º Flux çš„æƒ…å†µã€‚å…ˆé€šè¿‡è°ƒç”¨ `Flux#collectList()` æ–¹æ³•ï¼Œå°†å…¶è½¬æ¢æˆ `Mono<List<T>>` å¯¹è±¡ï¼Œåç»­å°±æ˜¯å’Œ `<1.1>` ç›¸åŒçš„é€»è¾‘ã€‚
  - `<1.3>` å¤„ï¼Œå¤„ç†ç»“æœä¸ºå…¶å®ƒç±»å‹çš„æƒ…å†µï¼Œç›´æ¥è¿›è¡ŒåŒ…è£…æˆ `CommonResult<?>` ã€‚

- `<2>` å¤„ï¼Œè°ƒç”¨çˆ¶ç±»æ–¹æ³• `#writeBody(Object body, MethodParameter bodyParameter, ServerWebExchange exchange)` æ–¹æ³•ï¼Œå®ç°å°†ç»“æœå†™å›ç»™å‰ç«¯ã€‚

åœ¨æ€è·¯ä¸Šï¼Œå’Œ SpringMVC ä½¿ç”¨ ResponseBodyAdvice + `@ControllerAdvice` æ³¨è§£ï¼Œæ˜¯ä¸€è‡´çš„ã€‚åªæ˜¯è¯´ï¼ŒWebFlux æš‚æ—¶æ²¡æœ‰æä¾›è¿™æ ·çš„æ–¹å¼ï¼Œæ‰€ä»¥å’±åªå¥½é€šè¿‡ç»§æ‰¿ ResponseBodyResultHandler ç±»ï¼Œé‡å†™å…¶ `#handleResult(ServerWebExchange exchange, HandlerResult result)` æ–¹æ³•ï¼Œå°†è¿”å›ç»“æœè¿›è¡Œä½¿ç”¨ CommonResult åŒ…è£…ã€‚

## 4.5 WebFluxConfiguration

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config/) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [WebFluxConfiguration](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config/WebFluxConfiguration.java) é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// WebFluxConfiguration.java

@Configuration
public class WebFluxConfiguration {

    @Bean
    public GlobalResponseBodyHandler responseWrapper(ServerCodecConfigurer serverCodecConfigurer,
                                                     RequestedContentTypeResolver requestedContentTypeResolver) {
        return new GlobalResponseBodyHandler(serverCodecConfigurer.getWriters(), requestedContentTypeResolver);
    }

}
```



- åœ¨ `#responseWrapper(serverCodecConfigurer, requestedContentTypeResolver)` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº† [4.4 GlobalResponseBodyHandler](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) Bean å¯¹è±¡ï¼Œå®ç°å¯¹è¿”å›ç»“æœçš„åŒ…è£…ã€‚

## 4.6 UserController

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.controller`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserController](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller//UserController.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserController.java

@RestController
@RequestMapping("/users")
public class UserController {

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/list")
    public Flux<UserVO> list() {
        // æŸ¥è¯¢åˆ—è¡¨
        List<UserVO> result = new ArrayList<>();
        result.add(new UserVO().setId(1).setUsername("yudaoyuanma"));
        result.add(new UserVO().setId(2).setUsername("woshiyutou"));
        result.add(new UserVO().setId(3).setUsername("chifanshuijiao"));
        // è¿”å›åˆ—è¡¨
        return Flux.fromIterable(result);
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get")
    public Mono<UserVO> get(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        UserVO user = new UserVO().setId(id).setUsername("username:" + id);
        // è¿”å›
        return Mono.just(user);
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get2")
    public Mono<CommonResult<UserVO>> get2(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        UserVO user = new UserVO().setId(id).setUsername("username:" + id);
        // è¿”å›
        return Mono.just(CommonResult.success(user));
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get3")
    public UserVO get3(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        UserVO user = new UserVO().setId(id).setUsername("username:" + id);
        // è¿”å›
        return user;
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get4")
    public CommonResult<UserVO> get4(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        UserVO user = new UserVO().setId(id).setUsername("username:" + id);
        // è¿”å›
        return CommonResult.success(user);
    }

}
```



- API æ¥å£è™½ç„¶æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å…ˆæ ¹æ®è¿”å›ç»“æœçš„ç±»å‹ï¼Œåˆ†æˆ Flux å’Œ Mono ä¸¤ç±»ã€‚ç„¶åï¼Œè‰¿è‰¿è¿™é‡Œåˆåˆ›å»ºäº† Mono åˆ†ç±»çš„å››ç§æƒ…å†µçš„æ¥å£ï¼Œå°±æ˜¯ `/users/get`ã€`/users/get2`ã€`/users/get3`ã€`/users/get4` å››ä¸ªã€‚èƒ–å‹çœ‹ä¸‹è¿™å››ä¸ªæ¥å£çš„è¿”å›ç»“æœçš„ç±»å‹ï¼Œå¾ˆå®¹æ˜“å°±æ˜ç™½äº†ã€‚

- åœ¨ `#get(Integer id)` æ–¹æ³•ï¼Œè¿”å›çš„ç»“æœæ˜¯ UserVO ç±»å‹ã€‚è¿™æ ·ï¼Œç»“æœä¼šè¢« GlobalResponseBodyHandler æ‹¦æˆªï¼ŒåŒ…è£…æˆ CommonResult ç±»å‹è¿”å›ã€‚è¯·æ±‚ç»“æœå¦‚ä¸‹ï¼š

  ```
  {
      "code": 0,
      "message": "",
      "data": {
          "id": 10,
          "username": "username:10"
      }
  }
  ```

  

  - ä¼šæœ‰ `"message": ""` çš„è¿”å›çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ SpringMVC æä¾›çš„ Jackson åºåˆ—åŒ–ï¼Œå¯¹äº CommonResult æ­¤æ—¶çš„ `message = null` çš„æƒ…å†µä¸‹ï¼Œä¼šåºåˆ—åŒ–å®ƒæˆ `"message": ""` è¿”å›ã€‚å®é™…æƒ…å†µä¸‹ï¼Œä¸ä¼šå½±å“å‰ç«¯å¤„ç†ã€‚

- åœ¨ `# get2(Integer id)` æ–¹æ³•ï¼Œè¿”å›çš„ç»“æœæ˜¯ `Mono<Common<UserVO>>` ç±»å‹ã€‚ç»“æœè™½ç„¶ä¹Ÿä¼šè¢« GlobalResponseBodyHandler å¤„ç†ï¼Œä½†æ˜¯**ä¸ä¼š**äºŒæ¬¡å†é‡å¤åŒ…è£…æˆ CommonResult ç±»å‹è¿”å›ã€‚

# 5. å…¨å±€å¼‚å¸¸å¤„ç†

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02) ã€‚

åœ¨ [ã€Œ4. å…¨å±€ç»Ÿä¸€è¿”å›ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰äº†ä½¿ç”¨ CommonResult å…¨å±€ç»Ÿä¸€è¿”å›ï¼Œå¹¶ä¸”çœ‹åˆ°äº†æˆåŠŸè¿”å›çš„ç¤ºä¾‹ä¸ä»£ç ã€‚è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯æ¥å…¨å±€å¼‚å¸¸å¤„ç†ï¼Œæœ€ç»ˆèƒ½ä¹Ÿæ˜¯é€šè¿‡ CommonResult è¿”å›ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±ä¸å“”å“”ï¼Œç›´æ¥çœ‹ç€ç¤ºä¾‹ä»£ç ï¼Œé¨æ¸¸èµ·æ¥ã€‚

> å‹æƒ…æç¤ºï¼šè¯¥ç¤ºä¾‹ï¼ŒåŸºäº [ã€Œ4. å…¨å±€ç»Ÿä¸€è¿”å›ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) çš„ [lab-27-webflux-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02) çš„åŸºç¡€ä¸Šï¼Œç»§ç»­æ”¹é€ ã€‚

## 5.1 ServiceExceptionEnum

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.constants`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/constants) åŒ…è·¯å¾„ï¼Œåˆ›å»º [ServiceExceptionEnum](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/constants/ServiceExceptionEnum.java) æšä¸¾ç±»ï¼Œæšä¸¾é¡¹ç›®ä¸­çš„é”™è¯¯ç ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// ServiceExceptionEnum.java

public enum ServiceExceptionEnum {

    // ========== ç³»ç»Ÿçº§åˆ« ==========
    SUCCESS(0, "æˆåŠŸ"),
    SYS_ERROR(2001001000, "æœåŠ¡ç«¯å‘ç”Ÿå¼‚å¸¸"),
    MISSING_REQUEST_PARAM_ERROR(2001001001, "å‚æ•°ç¼ºå¤±"),

    // ========== ç”¨æˆ·æ¨¡å— ==========
    USER_NOT_FOUND(1001002000, "ç”¨æˆ·ä¸å­˜åœ¨"),

    // ========== è®¢å•æ¨¡å— ==========

    // ========== å•†å“æ¨¡å— ==========
    ;

    /**
     * é”™è¯¯ç 
     */
    private int code;
    /**
     * é”™è¯¯æç¤º
     */
    private String message;

    ServiceExceptionEnum(int code, String message) {
        this.code = code;
        this.message = message;
    }

    // ... çœç•¥ getting æ–¹æ³•

}
```



- å› ä¸ºé”™è¯¯ç æ˜¯å…¨å±€çš„ï¼Œæœ€å¥½æŒ‰ç…§æ¨¡å—æ¥æ‹†åˆ†ã€‚å¦‚ä¸‹æ˜¯è‰¿è‰¿åœ¨ [onemall](https://github.com/YunaiV/onemall) é¡¹ç›®çš„å®è·µï¼š

  

  ```
  /**
   * æœåŠ¡å¼‚å¸¸
   *
   * å‚è€ƒ https://www.kancloud.cn/onebase/ob/484204 æ–‡ç« 
   *
   * ä¸€å…± 10 ä½ï¼Œåˆ†æˆå››æ®µ
   *
   * ç¬¬ä¸€æ®µï¼Œ1 ä½ï¼Œç±»å‹
   *      1 - ä¸šåŠ¡çº§åˆ«å¼‚å¸¸
   *      2 - ç³»ç»Ÿçº§åˆ«å¼‚å¸¸
   * ç¬¬äºŒæ®µï¼Œ3 ä½ï¼Œç³»ç»Ÿç±»å‹
   *      001 - ç”¨æˆ·ç³»ç»Ÿ
   *      002 - å•†å“ç³»ç»Ÿ
   *      003 - è®¢å•ç³»ç»Ÿ
   *      004 - æ”¯ä»˜ç³»ç»Ÿ
   *      005 - ä¼˜æƒ åŠµç³»ç»Ÿ
   *      ... - ...
   * ç¬¬ä¸‰æ®µï¼Œ3 ä½ï¼Œæ¨¡å—
   *      ä¸é™åˆ¶è§„åˆ™ã€‚
   *      ä¸€èˆ¬å»ºè®®ï¼Œæ¯ä¸ªç³»ç»Ÿé‡Œé¢ï¼Œå¯èƒ½æœ‰å¤šä¸ªæ¨¡å—ï¼Œå¯ä»¥å†å»åšåˆ†æ®µã€‚ä»¥ç”¨æˆ·ç³»ç»Ÿä¸ºä¾‹å­ï¼š
   *          001 - OAuth2 æ¨¡å—
   *          002 - User æ¨¡å—
   *          003 - MobileCode æ¨¡å—
   * ç¬¬å››æ®µï¼Œ3 ä½ï¼Œé”™è¯¯ç 
   *       ä¸é™åˆ¶è§„åˆ™ã€‚
   *       ä¸€èˆ¬å»ºè®®ï¼Œæ¯ä¸ªæ¨¡å—è‡ªå¢ã€‚
   */
  ```

  

## 5.2 ServiceException

æˆ‘ä»¬åœ¨ä¸€èµ·è®¨è®ºä¸‹ Service é€»è¾‘å¼‚å¸¸çš„æ—¶å€™ï¼Œå¦‚ä½•è¿›è¡Œè¿”å›ã€‚è¿™é‡Œçš„é€»è¾‘å¼‚å¸¸ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ï¼Œä¾‹å¦‚è¯´ç”¨æˆ·åå·²ç»å­˜åœ¨ï¼Œå•†å“åº“å­˜ä¸è¶³ç­‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¸¸ç”¨çš„æ–¹æ¡ˆé€‰æ‹©ï¼Œæœ‰ä¸¤ç§ï¼š

- å°è£…ç»Ÿä¸€çš„ä¸šåŠ¡å¼‚å¸¸ç±» ServiceException ï¼Œé‡Œé¢æœ‰é”™è¯¯ç å’Œé”™è¯¯æç¤ºï¼Œç„¶åè¿›è¡Œ `throws` æŠ›å‡ºã€‚
- å°è£…é€šç”¨çš„è¿”å›ç±» CommonResult ï¼Œé‡Œé¢æœ‰é”™è¯¯ç å’Œé”™è¯¯æç¤ºï¼Œç„¶åè¿›è¡Œ `return` è¿”å›ã€‚

ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬é€‰æ‹©äº† CommonResult ï¼Œç»“æœå‘ç°å¦‚ä¸‹æƒ…å†µï¼š

- å› ä¸º Spring `@Transactional` å£°æ˜å¼äº‹åŠ¡ï¼Œæ˜¯åŸºäºå¼‚å¸¸è¿›è¡Œå›æ»šçš„ï¼Œå¦‚æœä½¿ç”¨ CommonResult è¿”å›ï¼Œåˆ™äº‹åŠ¡å›æ»šä¼šéå¸¸éº»çƒ¦ã€‚
- å½“è°ƒç”¨åˆ«çš„æ–¹æ³•æ—¶ï¼Œå¦‚æœåˆ«äººè¿”å›çš„æ˜¯ CommonResult å¯¹è±¡ï¼Œè¿˜éœ€è¦ä¸æ–­çš„è¿›è¡Œåˆ¤æ–­ï¼Œå†™èµ·æ¥æŒºéº»çƒ¦çš„ã€‚

æ‰€ä»¥ï¼Œåæ¥æˆ‘ä»¬é‡‡ç”¨äº†æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ ServiceException çš„æ–¹å¼ã€‚

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.core.exception`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/exception) åŒ…è·¯å¾„ï¼Œåˆ›å»º [ServiceException](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/exception/ServiceException.java) å¼‚å¸¸ç±»ï¼Œç»§æ‰¿ RuntimeException å¼‚å¸¸ç±»ï¼Œç”¨äºå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// ServiceException.java

public final class ServiceException extends RuntimeException {

    /**
     * é”™è¯¯ç 
     */
    private final Integer code;

    public ServiceException(ServiceExceptionEnum serviceExceptionEnum) {
        // ä½¿ç”¨çˆ¶ç±»çš„ message å­—æ®µ
        super(serviceExceptionEnum.getMessage());
        // è®¾ç½®é”™è¯¯ç 
        this.code = serviceExceptionEnum.getCode();
    }

    // ... çœç•¥ getting æ–¹æ³•

}
```



- æä¾›ä¼ å…¥ `serviceExceptionEnum` å‚æ•°çš„æ„é€ æ–¹æ³•ã€‚å…·ä½“çš„å¤„ç†ï¼Œçœ‹ä¸‹ä»£ç å’Œæ³¨é‡Šã€‚

## 5.3 GlobalExceptionHandler

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.core.web`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/web) åŒ…è·¯å¾„ï¼Œåˆ›å»º [GlobalExceptionHandler](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/web/GlobalExceptionHandler.java) ç±»ï¼Œå…¨å±€ç»Ÿä¸€è¿”å›çš„å¤„ç†å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// GlobalExceptionHandler.java

@ControllerAdvice(basePackages = "cn.iocoder.springboot.lab27.springwebflux.controller")
public class GlobalExceptionHandler {

    private Logger logger = LoggerFactory.getLogger(getClass());

    /**
     * å¤„ç† ServiceException å¼‚å¸¸
     */
    @ResponseBody
    @ExceptionHandler(value = ServiceException.class)
    public CommonResult serviceExceptionHandler(ServiceException ex) {
        logger.debug("[serviceExceptionHandler]", ex);
        // åŒ…è£… CommonResult ç»“æœ
        return CommonResult.error(ex.getCode(), ex.getMessage());
    }

    /**
     * å¤„ç† ServerWebInputException å¼‚å¸¸
     *
     * WebFlux å‚æ•°ä¸æ­£ç¡®
     */
    @ResponseBody
    @ExceptionHandler(value = ServerWebInputException.class)
    public CommonResult serverWebInputExceptionHandler(ServerWebInputException ex) {
        logger.debug("[ServerWebInputExceptionHandler]", ex);
        // åŒ…è£… CommonResult ç»“æœ
        return CommonResult.error(ServiceExceptionEnum.MISSING_REQUEST_PARAM_ERROR.getCode(),
                ServiceExceptionEnum.MISSING_REQUEST_PARAM_ERROR.getMessage());
    }

    /**
     * å¤„ç†å…¶å®ƒ Exception å¼‚å¸¸
     */
    @ResponseBody
    @ExceptionHandler(value = Exception.class)
    public CommonResult exceptionHandler(Exception e) {
        // è®°å½•å¼‚å¸¸æ—¥å¿—
        logger.error("[exceptionHandler]", e);
        // è¿”å› ERROR CommonResult
        return CommonResult.error(ServiceExceptionEnum.SYS_ERROR.getCode(),
                ServiceExceptionEnum.SYS_ERROR.getMessage());
    }

}
```



- åœ¨ WebFlux ä¸­ï¼Œå¯ä»¥ä½¿ç”¨é€šè¿‡å®ç° [ResponseBodyAdvice](https://github.com/spring-projects/spring-framework/blob/master/spring-webmvc/src/main/java/org/springframework/web/servlet/mvc/method/annotation/ResponseBodyAdvice.java) æ¥å£ï¼Œå¹¶æ·»åŠ  [`@ControllerAdvice`](https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/bind/annotation/ControllerAdvice.java) æ¥å£ï¼Œæ‹¦æˆª Controller çš„è¿”å›ç»“æœã€‚æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œ `@ControllerAdvice` æ³¨è§£ï¼Œè®¾ç½®äº† `basePackages` å±æ€§ï¼Œ**åªæ‹¦æˆª** `"cn.iocoder.springboot.lab27.springwebflux.controller"` åŒ…ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ Controller ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºåœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¼•å…¥ Swagger ç­‰åº“ï¼Œä¹Ÿä½¿ç”¨ Controller æä¾› API æ¥å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¾ç„¶ä¸åº”è¯¥è®© GlobalResponseBodyHandler å»æ‹¦æˆªè¿™äº›æ¥å£ï¼Œ**æ¯•ç«Ÿå®ƒä»¬å¹¶ä¸éœ€è¦æˆ‘ä»¬å»æ›¿å®ƒä»¬åšå…¨å±€ç»Ÿä¸€çš„è¿”å›**ã€‚
- æˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œé€šè¿‡æ·»åŠ  [`@ExceptionHandler`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/ExceptionHandler.html) æ³¨è§£ï¼Œå®šä¹‰æ¯ä¸ªæ–¹æ³•å¯¹åº”å¤„ç†çš„å¼‚å¸¸ã€‚å¹¶ä¸”ï¼Œä¹Ÿæ·»åŠ äº† `@ResponseBody` æ³¨è§£ï¼Œæ ‡è®°ç›´æ¥ä½¿ç”¨è¿”å›ç»“æœä½œä¸º API çš„å“åº”ã€‚
- `#serviceExceptionHandler(...)` æ–¹æ³•ï¼Œæ‹¦æˆªå¤„ç† ServiceException ä¸šåŠ¡å¼‚å¸¸ï¼Œç›´æ¥ä½¿ç”¨è¯¥å¼‚å¸¸çš„ `code` + `message` å±æ€§ï¼Œæ„å»ºå‡º CommonResult å¯¹è±¡è¿”å›ã€‚
- `#serverWebInputExceptionHandler(...)` æ–¹æ³•ï¼Œæ‹¦æˆªå¤„ç† ServerWebInputException è¯·æ±‚å‚æ•°å¼‚å¸¸ï¼Œæ„å»ºå‡ºé”™è¯¯ç ä¸º `ServiceExceptionEnum.MISSING_REQUEST_PARAM_ERROR` çš„ CommonResult å¯¹è±¡è¿”å›ã€‚
- `#exceptionHandler(...)` æ–¹æ³•ï¼Œæ‹¦æˆªå¤„ç† Exception å¼‚å¸¸ï¼Œæ„å»ºå‡ºé”™è¯¯ç ä¸º `ServiceExceptionEnum.SYS_ERROR` çš„ CommonResult å¯¹è±¡è¿”å›ã€‚è¿™æ˜¯ä¸€ä¸ª**å…œåº•**çš„å¼‚å¸¸å¤„ç†ï¼Œé¿å…æœ‰ä¸€äº›å…¶å®ƒå¼‚å¸¸ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨ GlobalExceptionHandler ä¸­ï¼Œæä¾›è‡ªå®šä¹‰çš„å¤„ç†æ–¹å¼ã€‚

**æ³¨æ„**ï¼Œåœ¨ `#exceptionHandler(...)` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¿˜å¤šä½¿ç”¨ `logger` æ‰“å°äº†é”™è¯¯æ—¥å¿—ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ¥å…¥ ELK ç­‰æ—¥å¿—æœåŠ¡ï¼Œå‘èµ·å‘Šè­¦ï¼Œé€šçŸ¥æˆ‘ä»¬å»æ’æŸ¥è§£å†³ã€‚å¦‚æœèƒ–å‹çš„ç³»ç»Ÿé‡Œæš‚æ—¶æ²¡æœ‰æ—¥å¿—æœåŠ¡ï¼Œå¯ä»¥è®°å½•é”™è¯¯æ—¥å¿—åˆ°æ•°æ®åº“ä¸­ï¼Œä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚è€Œå…¶å®ƒä¸¤ä¸ªæ–¹æ³•ï¼Œå› ä¸ºæ˜¯æ›´åä¸šåŠ¡çš„ï¼Œç›¸å¯¹æ­£å¸¸çš„å¼‚å¸¸ï¼Œæ‰€ä»¥æ— éœ€è®°å½•é”™è¯¯æ—¥å¿—ã€‚

## 5.4 UserController

åœ¨ [UserController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserController.java) ç±»ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ ä¸¤ä¸ª API æ¥å£ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•å…¨å±€å¼‚å¸¸å¤„ç†çš„æ•ˆæœã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserController.java

/**
 * æµ‹è¯•æŠ›å‡º NullPointerException å¼‚å¸¸
 */
@GetMapping("/exception-01")
public UserVO exception01() {
    throw new NullPointerException("æ²¡æœ‰ç²—é¢é±¼ä¸¸");
}

/**
 * æµ‹è¯•æŠ›å‡º ServiceException å¼‚å¸¸
 */
@GetMapping("/exception-02")
public UserVO exception02() {
    throw new ServiceException(ServiceExceptionEnum.USER_NOT_FOUND);
}
```



- åœ¨ `#exception01()` æ–¹æ³•ï¼ŒæŠ›å‡º NullPointerException å¼‚å¸¸ã€‚è¿™æ ·ï¼Œå¼‚å¸¸ä¼šè¢« `GlobalExceptionHandler#exceptionHandler(...)` æ–¹æ³•æ¥æ‹¦æˆªï¼ŒåŒ…è£…æˆ CommonResult ç±»å‹è¿”å›ã€‚è¯·æ±‚ç»“æœå¦‚ä¸‹ï¼š

  ```
  {
      "code": 2001001000,
      "message": "æœåŠ¡ç«¯å‘ç”Ÿå¼‚å¸¸",
      "data": null
  }
  ```

  

- åœ¨ `#exception02()` æ–¹æ³•ï¼ŒæŠ›å‡º ServiceException å¼‚å¸¸ã€‚è¿™æ ·ï¼Œå¼‚å¸¸ä¼šè¢« `GlobalExceptionHandler#serviceExceptionHandler(...)` æ–¹æ³•æ¥æ‹¦æˆªï¼ŒåŒ…è£…æˆ CommonResult ç±»å‹è¿”å›ã€‚è¯·æ±‚ç»“æœå¦‚ä¸‹ï¼š

  ```
  {
      "code": 1001002000,
      "message": "ç”¨æˆ·ä¸å­˜åœ¨",
      "data": null
  }
  ```

  

## 5.5 ç®€å•å°ç»“

é‡‡ç”¨ `ControllerAdvice` + `@ExceptionHandler` æ³¨è§£çš„æ–¹å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç° WebFlux çš„å…¨å±€å¼‚å¸¸å¤„ç†ã€‚ä¸è¿‡è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªå¼Šç«¯ï¼Œä¸æ”¯æŒ WebFlux çš„åŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼ã€‚ä¸è¿‡è€ƒè™‘åˆ°ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šé‡‡ç”¨åŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆè¿˜æ˜¯æ²¡é—®é¢˜çš„ã€‚çœ‹äº†ä¸‹ WebFlux çš„å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿæ˜¯æ¨èè¿™ç§æ–¹æ¡ˆï¼Œè¯¦ç»†å¯è§ [ã€ŠWeb on Reactive Stack â€”â€” Spring WebFlux â€”â€” Managing Exceptionsã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-ann-controller-exceptions) ã€‚

å¦‚æœèƒ–å‹çœŸçš„éœ€è¦æ”¯æŒ WebFlux çš„åŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠHandling Errors in Spring WebFluxã€‹](https://www.baeldung.com/spring-webflux-errors) æ–‡ç« ï¼Œé€šè¿‡ç»§æ‰¿ [`org.springframework.boot.autoconfigure.web.reactive.error.AbstractErrorWebExceptionHandler`](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/web/reactive/error/AbstractErrorWebExceptionHandler.java) æŠ½è±¡ç±»ï¼Œå®ç°è‡ªå®šä¹‰çš„å…¨å±€å¼‚å¸¸å¤„ç†å™¨ã€‚

# 6. WebFilter è¿‡æ»¤å™¨

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02) ã€‚

åœ¨ SpringMVC ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° [HandlerInterceptor](https://github.com/spring-projects/spring-framework/blob/master/spring-webmvc/src/main/java/org/springframework/web/servlet/HandlerInterceptor.java) æ¥å£ï¼Œæ‹¦æˆª SpringMVC å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ï¼Œè‡ªå®šä¹‰å‰ç½®å’Œå¤„ç†çš„é€»è¾‘ã€‚ä¸äº†è§£è¿™å—çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot SpringMVC å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/SpringMVC/?self) çš„ [ã€Œ6. HandlerInterceptor æ‹¦æˆªå™¨ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) å°èŠ‚ã€‚

åœ¨ WebFlux ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° [WebFilter](https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/server/WebFilter.java) æ¥å£ï¼Œè¿‡æ»¤ WebFlux å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ï¼Œè‡ªå®šä¹‰å‰ç½®å’Œå¤„ç†çš„é€»è¾‘ã€‚è¯¥æ¥å£ä»£ç å¦‚ä¸‹ï¼š



```
// DemoWebFilterWebFilter.java

/**
 * Contract for interception-style, chained processing of Web requests that may
 * be used to implement cross-cutting, application-agnostic requirements such
 * as security, timeouts, and others.
 *
 * @author Rossen Stoyanchev
 * @since 5.0
 */
public interface WebFilter {

	/**
	 * Process the Web request and (optionally) delegate to the next
	 * {@code WebFilter} through the given {@link WebFilterChain}.
	 * @param exchange the current server exchange
	 * @param chain provides a way to delegate to the next filter
	 * @return {@code Mono<Void>} to indicate when request processing is complete
	 */
	Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain);

}
```



- å› ä¸º [WebFilterChain](https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/server/WebFilterChain.java) çš„ `#filter(ServerWebExchange exchange)` æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ `Mono<Void>` å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œå„ç§ Reactor çš„æ“ä½œã€‚å’³å’³å’³ï¼Œå½“ç„¶éœ€è¦èƒ–å‹æ¯”è¾ƒäº†è§£ Reactor çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬æ‰èƒ½å®ç°å‡ºçš„ WebFilter ï¼Œå¦åˆ™ä¼šè§‰å¾—æŒºéš¾ç”¨çš„ã€‚
- å¦å¤–ï¼ŒWebFilterChain æ˜¯ç”±å¤šä¸ª WebFilter è¿‡æ»¤å™¨ç»„æˆçš„é“¾ï¼Œå…¶é»˜è®¤çš„å®ç°ä¸º [DefaultWebFilterChain](https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/server/handler/DefaultWebFilterChain.java) ã€‚
- æ€»ä½“æ¥è¯´ï¼Œä»å½¢æ€ä¸Šå’Œæˆ‘ä»¬åœ¨ Servlet çœ‹åˆ°çš„ [FilterChain](https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/FilterChain.java) å’Œ [Filter](https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/Filter.java) æ˜¯æ¯”è¾ƒç›¸ä¼¼çš„ï¼Œåªæ˜¯å› ä¸ºç»“åˆäº† Reactor å“åº”å¼ç¼–ç¨‹ï¼Œæ‰€ä»¥ç¼–å†™æ—¶ï¼Œå·®å¼‚è›®å¤§çš„ã€‚

## 6.1 DemoWebFilter

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªç®€å•çš„ WebFilter ç¤ºä¾‹ã€‚

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.core.filter`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/filter) åŒ…è·¯å¾„ï¼Œåˆ›å»º [DemoWebFilter](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/core/filter) ç±»ï¼Œä¸€ä¸ªç®€å•çš„ WebFilter ç¤ºä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// DemoWebFilter.java

@Component
@Order(1)
public class DemoWebFilter implements WebFilter {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Override
    public Mono<Void> filter(ServerWebExchange serverWebExchange, WebFilterChain webFilterChain) {
        // <1> ç»§ç»­æ‰§è¡Œè¯·æ±‚
        return webFilterChain.filter(serverWebExchange)
                .doOnSuccess(new Consumer<Void>() { // <2> æ‰§è¡ŒæˆåŠŸåå›è°ƒ

                    @Override
                    public void accept(Void aVoid) {
                        logger.info("[accept][æ‰§è¡ŒæˆåŠŸ]");
                    }

                });
    }

}
```



- åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@Component` æ³¨è§£ï¼Œåˆ›å»º DemoWebFilter Bean å¯¹è±¡ã€‚è¿™æ ·ï¼Œè¯¥è¿‡æ»¤å™¨å°±å·²ç»åŠ å…¥äº† WebFlux çš„è¿‡æ»¤å™¨é“¾ä¸­ã€‚ç›®å‰ï¼Œæš‚æœª**å†…ç½®**æ”¯æŒæ ¹æ®è¯·æ±‚è·¯å¾„ uri ç­‰æ¡ä»¶æ¥é…ç½®æ˜¯å¦è¿‡æ»¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±åœ¨å®ç° `#filter(serverWebExchange, webFilterChain)` æ–¹æ³•æ¥å®Œæˆã€‚

- åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@Order` æ³¨è§£ï¼Œè®¾ç½®è¿‡æ»¤å™¨çš„é¡ºåºã€‚

- å®ç°

   

  ```
  #filter(serverWebExchange, webFilterChain)
  ```

   

  æ–¹æ³•ï¼Œå®ç°åœ¨è¯·æ±‚æ‰§è¡Œå®Œæˆåï¼Œæ‰“å°ä¸€æ¡æ‰§è¡ŒæˆåŠŸçš„æ—¥å¿—ã€‚

  - `<1>` å¤„ï¼Œè°ƒç”¨ `WebFilterChain#filter(exchange)` æ–¹æ³•ï¼Œäº¤ç»™è¿‡æ»¤å™¨**é“¾**ä¸­çš„ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œç»§ç»­è¿›è¡Œè¿‡æ»¤å¤„ç†ï¼Œå¹¶è¿”å› `Mono<Void>` å¯¹è±¡ã€‚
  - `<2>` å¤„ï¼Œè°ƒç”¨ `Mono#doOnSuccess(Consumer<? super T> onSuccess)` æ–¹æ³•ï¼Œå®ç°åœ¨è¯·æ±‚æ‰§è¡Œå®Œæˆåï¼Œæ‰“å°ä¸€æ¡æ‰§è¡ŒæˆåŠŸçš„æ—¥å¿—ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ [ã€ŠReactor æ–‡æ¡£ â€”â€” Monoã€‹](https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html) ï¼Œå®ç°å„ç§å…¶å®ƒæ“ä½œã€‚

ğŸ˜ˆ åœ¨åé¢çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹ä¸€ä¸ªå®ç°å¤„ç† Cors è·¨åŸŸçš„ [CorsWebFilter](https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/cors/reactive/CorsWebFilter.java) ï¼Œå¯¹ç†è§£ WebFilter æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚

## 6.2 Filtering Handler Functions

åœ¨åŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æ–¹å¼ï¼Œå®ç°å¯¹æ¯ä¸ªè·¯ç”±çš„è¿‡æ»¤å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserRouter.java

@Bean
public RouterFunction<ServerResponse> demo2RouterFunction() {
    return route(GET("/users2/demo2"), request -> ok().bodyValue("demo"))
            .filter(new HandlerFilterFunction<ServerResponse, ServerResponse>() {

                @Override
                public Mono<ServerResponse> filter(ServerRequest request, HandlerFunction<ServerResponse> next) {
                    return next.handle(request).doOnSuccess(new Consumer<ServerResponse>() { // æ‰§è¡ŒæˆåŠŸåå›è°ƒ

                        @Override
                        public void accept(ServerResponse serverResponse) {
                            logger.info("[accept][æ‰§è¡ŒæˆåŠŸ]");
                        }

                    });
                }

            });
}
```



å› ä¸ºå®é™…åœºæ™¯ä¸‹ï¼Œä½¿ç”¨åˆ°åŸºäºå‡½æ•°å¼ç¼–ç¨‹æ–¹å¼æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œå°±ä¸æ‰©å±•å¼€æ¥è®²ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠWeb on Reactive Stack â€”â€” Spring WebFlux â€”â€” Filtering Handler Functionsã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-fn-handler-filter-function) æ–‡æ¡£ã€‚

# 7. Servletã€Filterã€Listener

ç›®å‰æµ‹è¯•ä¸‹æ¥ï¼Œ[`java.servlet`](https://docs.oracle.com/javaee/7/api/javax/servlet/package-summary.html) æä¾›çš„ Servletã€Filterã€Listener ç»„ä»¶ï¼Œæ— æ³•åœ¨ WebFlux ä¸­ä½¿ç”¨ã€‚æµ‹è¯•çš„ç¤ºä¾‹ï¼Œå¯è§ [lab-27-webflux-03](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-03) ã€‚

è‰¿è‰¿ç¿»äº†ä¸‹ Spring Security å¯¹ WebFlux çš„æ”¯æŒï¼Œä¹Ÿæ˜¯é€šè¿‡å®ç° WebFlux æ¥å£çš„ [WebFilterChainProxy](https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/server/WebFilterChainProxy.java) è¿‡æ»¤å™¨ï¼Œå³åœ¨ [ã€Œ6. WebFilter è¿‡æ»¤å™¨ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) ä¸­çœ‹åˆ°çš„å†…å®¹ã€‚

# 8. Cors è·¨åŸŸ

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02) ã€‚

åœ¨å‰åç«¯åˆ†ç¦»ä¹‹åï¼Œæˆ‘ä»¬ä¼šç¢°åˆ°è·¨åŸŸçš„é—®é¢˜ã€‚ä¾‹å¦‚è¯´ï¼Œå‰ç«¯åœ¨ [http://www.iocoder.cn](http://www.iocoder.cn/) åŸŸåä¸‹ï¼Œè€Œåç«¯ API åœ¨ [http://api.iocoder.cn](http://api.iocoder.cn/) åŸŸåä¸‹ã€‚

å¯¹è·¨åŸŸä¸æ˜¯å¾ˆäº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹é˜®å¤§çš„ [ã€Šè·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£ã€‹](https://www.ruanyifeng.com/blog/2016/04/cors.html) æ–‡ç« ã€‚ğŸ˜ˆ å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å…ˆç»§ç»­æœ¬æ–‡çš„é˜…è¯»ã€‚

è§£å†³è·¨åŸŸçš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚è¯´ï¼Œåœ¨ Nginx ä¸Šé…ç½®å¤„ç†è·¨åŸŸè¯·æ±‚çš„å‚æ•°ã€‚åˆä¾‹å¦‚è¯´ï¼Œé¡¹ç›®ä¸­æœ‰ç½‘å…³æœåŠ¡ï¼Œç»Ÿä¸€é…ç½®å¤„ç†ã€‚å½“ç„¶ï¼Œæœ¬æ–‡æ—¢ç„¶æ˜¯ Spring Boot WebFlux å…¥é—¨ï¼Œé‚£ä¹ˆå¿…ç„¶åªä½¿ç”¨ WebFlux æ¥è§£å†³è·¨åŸŸã€‚ç›®å‰ä¸€å…±æœ‰ä¸‰ç§æ–¹æ¡ˆï¼š

- æ–¹å¼ä¸€ï¼Œä½¿ç”¨ [`@CrossCors`](https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/bind/annotation/CrossOrigin.java) æ³¨è§£ï¼Œé…ç½®æ¯ä¸ª API æ¥å£ã€‚
- æ–¹å¼äºŒï¼Œä½¿ç”¨ [`CorsRegistry.java`](https://github.com/spring-projects/spring-framework/blob/master/spring-webmvc/src/main/java/org/springframework/web/servlet/config/annotation/CorsRegistry.java) æ³¨å†Œè¡¨ï¼Œé…ç½®æ¯ä¸ª API æ¥å£ã€‚
- æ–¹æ¡ˆä¸‰ï¼Œä½¿ç”¨ [`CorsFilter.java`](https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/filter/CorsFilter.java) **è¿‡æ»¤å™¨**ï¼Œå¤„ç†è·¨åŸŸè¯·æ±‚ã€‚

å…¶ä¸­ï¼Œæ–¹æ¡ˆä¸€å’Œæ–¹æ¡ˆäºŒï¼Œæœ¬è´¨æ˜¯ç›¸åŒçš„æ–¹æ¡ˆï¼Œåªæ˜¯é…ç½®æ–¹å¼ä¸åŒã€‚æƒ³è¦ç†è§£åº•å±‚åŸç†çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [AbstractHandlerMapping#getHandler(ServerWebExchange exchange)](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/handler/AbstractHandlerMapping.java#L190-L192) æ–¹æ³•ï¼Œè·å¾—å¤„ç†å™¨ä¹‹åï¼Œä¼šè¿›è¡Œä¸‹ Cors è·¨åŸŸçš„å¤„ç†ã€‚

> å‹æƒ…æç¤ºï¼šè¯¥ç¤ºä¾‹ï¼ŒåŸºäº [ã€Œ6. WebFilter è¿‡æ»¤å™¨ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) çš„ [lab-27-webflux-02](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-02) çš„åŸºç¡€ä¸Šï¼Œç»§ç»­æ”¹é€ ã€‚

## 8.1 @CrossCors

`@CrossCors` æ³¨è§£ï¼Œæ·»åŠ åœ¨ç±»æˆ–æ–¹æ³•ä¸Šï¼Œæ ‡è®°è¯¥ç±»/æ–¹æ³•å¯¹åº”æ¥å£çš„ Cors ä¿¡æ¯ã€‚

`@CrossCors` æ³¨è§£çš„**å¸¸ç”¨å±æ€§**ï¼Œå¦‚ä¸‹ï¼š

- `origins` å±æ€§ï¼Œè®¾ç½®å…è®¸çš„è¯·æ±‚æ¥æºã€‚`[]` æ•°ç»„ï¼Œå¯ä»¥å¡«å†™å¤šä¸ªè¯·æ±‚æ¥æºã€‚é»˜è®¤å€¼ä¸º `*` ã€‚
- `value` å±æ€§ï¼Œå’Œ `origins` å±æ€§ç›¸åŒï¼Œæ˜¯å®ƒçš„åˆ«åã€‚
- `allowCredentials` å±æ€§ï¼Œæ˜¯å¦å…è®¸å®¢æˆ·ç«¯è¯·æ±‚å‘é€ Cookie ã€‚é»˜è®¤ä¸º `false` ï¼Œä¸å…è®¸è¯·æ±‚å‘é€ Cookie ã€‚
- `maxAge` å±æ€§ï¼Œæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ã€‚é»˜è®¤å€¼ä¸º 1800 ç§’ã€‚

`@CrossCors` æ³¨è§£çš„**ä¸å¸¸ç”¨å±æ€§**ï¼Œå¦‚ä¸‹ï¼š

- `methods` å±æ€§ï¼Œè®¾ç½®å…è®¸çš„è¯·æ±‚æ–¹æ³•ã€‚`[]` æ•°ç»„ï¼Œå¯ä»¥å¡«å†™å¤šä¸ªè¯·æ±‚æ–¹æ³•ã€‚é»˜è®¤å€¼ä¸º `GET` + `POST` ã€‚
- `allowedHeaders` å±æ€§ï¼Œå…è®¸çš„è¯·æ±‚å¤´ Header ã€‚`[]` æ•°ç»„ï¼Œå¯ä»¥å¡«å†™å¤šä¸ªè¯·æ±‚æ¥æºã€‚é»˜è®¤å€¼ä¸º `*` ã€‚
- `exposedHeaders` å±æ€§ï¼Œå…è®¸çš„å“åº”å¤´ Header ã€‚`[]` æ•°ç»„ï¼Œå¯ä»¥å¡«å†™å¤šä¸ªè¯·æ±‚æ¥æºã€‚é»˜è®¤å€¼ä¸º `*` ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨**æ¯ä¸ª** Controller ä¸Šï¼Œæ·»åŠ  `@CrossCors` æ³¨è§£å³å¯ã€‚å½“ç„¶ï¼Œå¦‚æœæŸä¸ª API æ¥å£å¸Œæœ›åšè‡ªå®šä¹‰çš„é…ç½®ï¼Œå¯ä»¥åœ¨ Method æ–¹æ³•ä¸Šæ·»åŠ ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š



```
// TestController.java

@RestController
@RequestMapping("/test")
@CrossOrigin(origins = "*", allowCredentials = "true") // å…è®¸æ‰€æœ‰æ¥æºï¼Œå…è®¸å‘é€ Cookie
public class TestController {

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @return ç”¨æˆ·
     */
    @GetMapping("/get")
    @CrossOrigin(allowCredentials = "false") // å…è®¸æ‰€æœ‰æ¥æºï¼Œä¸å…è®¸å‘é€ Cookie
    public Mono<UserVO> get() {
        // æŸ¥è¯¢ç”¨æˆ·
        UserVO user =  new UserVO().setId(1).setUsername(UUID.randomUUID().toString());
        // è¿”å›
        return Mono.just(user);
    }

}
```



**åœ¨ç»å¤§æ•°åœºåˆä¸‹ï¼Œè‚¯å®šæ˜¯åœ¨ Controller ä¸Šï¼Œæ·»åŠ  `@CrossOrigin(allowCredentials = "true")` å³å¯**ã€‚

## 8.2 CorsRegistry

æ˜¾ç„¶ï¼Œåœ¨æ¯ä¸ª Controller ä¸Šé…ç½® `@CrossOrigin` æ³¨è§£ï¼Œæ˜¯æŒºéº»çƒ¦ä¸€äº‹ã€‚æ‰€ä»¥æ›´å¤šçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©é…ç½® CorsRegistry æ³¨å†Œè¡¨ã€‚

ä¿®æ”¹ [WebFluxConfiguration](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config/WebFluxConfiguration.java) é…ç½®ç±»ï¼Œå¢åŠ  CorsRegistry ç›¸å…³çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// WebFluxConfiguration.java

@Configuration
public class WebFluxConfiguration implements WebFluxConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        // æ·»åŠ å…¨å±€çš„ CORS é…ç½®
        registry.addMapping("/**") // åŒ¹é…æ‰€æœ‰ URL ï¼Œç›¸å½“äºå…¨å±€é…ç½®
                .allowedOrigins("*") // å…è®¸æ‰€æœ‰è¯·æ±‚æ¥æº
                .allowCredentials(true) // å…è®¸å‘é€ Cookie
                .allowedMethods("*") // å…è®¸æ‰€æœ‰è¯·æ±‚ Method
                .allowedHeaders("*") // å…è®¸æ‰€æœ‰è¯·æ±‚ Header
//                .exposedHeaders("*") // å…è®¸æ‰€æœ‰å“åº” Header
                .maxAge(1800L); // æœ‰æ•ˆæœŸ 1800 ç§’ï¼Œ2 å°æ—¶
    }

}
```



- éœ€è¦å®ç° [WebFluxConfigurer](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/config/WebFluxConfigurer.java) æ¥å£ï¼Œé‡å†™ `#addCorsMappings(CorsRegistry registry)` æ–¹æ³•ï¼Œå®ç°è‡ªå®šä¹‰çš„ CORS é…ç½®ã€‚
- è¿™é‡Œé…ç½®åŒ¹é…çš„è·¯å¾„æ˜¯ `/**` ï¼Œä»è€Œå®ç°å…¨å±€ CORS é…ç½®ã€‚
- å¦‚æœæƒ³è¦é…ç½®å•ä¸ªè·¯å¾„çš„ CORS é…ç½®ï¼Œå¯ä»¥é€šè¿‡ `CorsRegistry#addMapping(String pathPattern)` æ–¹æ³•ï¼Œç»§ç»­å¾€å…¶ä¸­æ·»åŠ  CORS é…ç½®ã€‚
- å¦‚æœèƒ–å‹æƒ³è¦æ›´å®‰å…¨ï¼Œå¯ä»¥ `originns` å±æ€§ï¼Œåªå¡«å†™å…è®¸çš„å‰ç«¯åŸŸååœ°å€ã€‚

## 8.3 CorsWebFilter

åœ¨ [Spring WebFlux](https://github.com/spring-projects/spring-framework/tree/master/spring-webflux) ä¸­ï¼Œå†…ç½®æä¾› CorsWebFilter è¿‡æ»¤å™¨ï¼Œå®ç°å¯¹ CORS çš„å¤„ç†ã€‚

é…ç½®æ–¹å¼å¾ˆç®€å•ï¼Œä¿®æ”¹ [WebFluxConfiguration](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-02/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config/WebFluxConfiguration.java) é…ç½®ç±»ï¼Œå¢åŠ  CorsWebFilter ç›¸å…³çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// WebFluxConfiguration.java

@Bean
@Order(0) // è®¾ç½® order æ’åºã€‚è¿™ä¸ªé¡ºåºå¾ˆé‡è¦å“¦ï¼Œä¸ºé¿å…éº»çƒ¦è¯·è®¾ç½®åœ¨æœ€å‰
public CorsWebFilter corsFilter() {
    // åˆ›å»º UrlBasedCorsConfigurationSource é…ç½®æºï¼Œç±»ä¼¼ CorsRegistry æ³¨å†Œè¡¨
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    // åˆ›å»º CorsConfiguration é…ç½®ï¼Œç›¸å½“äº CorsRegistration æ³¨å†Œä¿¡æ¯
    CorsConfiguration config = new CorsConfiguration();
    config.setAllowedOrigins(Collections.singletonList("*")); // å…è®¸æ‰€æœ‰è¯·æ±‚æ¥æº
    config.setAllowCredentials(true); // å…è®¸å‘é€ Cookie
    config.addAllowedMethod("*"); // å…è®¸æ‰€æœ‰è¯·æ±‚ Method
    config.setAllowedHeaders(Collections.singletonList("*")); // å…è®¸æ‰€æœ‰è¯·æ±‚ Header
    // config.setExposedHeaders(Collections.singletonList("*")); // å…è®¸æ‰€æœ‰å“åº” Header
    config.setMaxAge(1800L); // æœ‰æ•ˆæœŸ 1800 ç§’ï¼Œ2 å°æ—¶
    source.registerCorsConfiguration("/**", config);
    // åˆ›å»º CorsWebFilter å¯¹è±¡
    return new CorsWebFilter(source); // åˆ›å»º CorsFilter è¿‡æ»¤å™¨
}
```



- è‰¿è‰¿å·²ç»æ·»åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹å™¢ã€‚æ•ˆæœä¸Šï¼Œå’Œ [ã€Œ8.2 CorsRegistryã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ˜¯ä¸€è‡´çš„ã€‚

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ CorsWebFilter çš„æºç ï¼Œäº†è§£ä¸‹ CORS è·¨åŸŸçš„å…·ä½“é€»è¾‘ï¼ŒåŒæ—¶ä¹Ÿèƒ½å†çœ‹ä¸€ä¸ª WebFliter çš„ç¤ºä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// CorsWebFilter.java

public class CorsWebFilter implements WebFilter {

	/**
	 * Cors é…ç½®æº
	 */
	private final CorsConfigurationSource configSource;
	/**
	 * Cors å¤„ç†å™¨ï¼Œé»˜è®¤ä¸º DefaultCorsProcessor
	 */
	private final CorsProcessor processor;

	public CorsWebFilter(CorsConfigurationSource configSource) {
		this(configSource, new DefaultCorsProcessor());
	}

	public CorsWebFilter(CorsConfigurationSource configSource, CorsProcessor processor) {
		Assert.notNull(configSource, "CorsConfigurationSource must not be null");
		Assert.notNull(processor, "CorsProcessor must not be null");
		this.configSource = configSource;
		this.processor = processor;
	}

	@Override
	public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {
		ServerHttpRequest request = exchange.getRequest();
		// å¦‚æœæ˜¯ CORS è·¨åŸŸè¯·æ±‚
		if (CorsUtils.isCorsRequest(request)) {
			// è·å¾—è¯¥æ¥å£çš„ CORS è·¨åŸŸè¯·æ±‚çš„é…ç½®
			CorsConfiguration corsConfiguration = this.configSource.getCorsConfiguration(exchange);
			if (corsConfiguration != null) {
				// æ‰§è¡Œ CORS è·¨åŸŸè¯·æ±‚çš„å¤„ç†ï¼Œ
				boolean isValid = this.processor.process(corsConfiguration, exchange);
				// !isValid è¡¨ç¤ºï¼Œå¦‚æœè·¨åŸŸè¯·æ±‚çš„æ ¡éªŒä¸é€šè¿‡
				// CorsUtils.isPreFlightRequest(request) è¡¨ç¤ºï¼Œæ˜¯ OPTIONS â€œé¢„æ£€è¯·æ±‚â€
				if (!isValid || CorsUtils.isPreFlightRequest(request)) {
					// ç›´æ¥è¿”å›ç©ºçš„ Mono ï¼Œä¸è¿›è¡Œåç»­çš„å¤„ç†
					return Mono.empty();
				}
			}
		}
		// ç»§ç»­è¿‡æ»¤å™¨çš„å¤„ç†
		return chain.filter(exchange);
	}

}
```



- ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±è·Ÿç€æ³¨é‡Šæ¥ç†è§£ä¸‹ã€‚

## 8.4 å¦‚ä½•é€‰æ‹©

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ å®Œä¸‰ç§ WebFlux é…ç½® CORS çš„æ–¹å¼ã€‚**ä¸ªäººå»ºè®®çš„è¯ï¼Œæ¨èä½¿ç”¨ [ã€Œ8.3 CorsWebFilterã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ–¹å¼ã€‚**ğŸ˜ˆ

åœ¨ WebFlux ä¸­ï¼Œæ˜¯å…ˆæ‰§è¡Œå®Œ WebFilter çš„è¿‡æ»¤é“¾ï¼Œåœ¨é€šè¿‡ [AbstractHandlerMapping#getHandler(ServerWebExchange exchange)](https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/handler/AbstractHandlerMapping.java#L190-L192) æ–¹æ³•ï¼Œè·å¾—å¤„ç†å™¨ã€‚é‚£ä¹ˆï¼Œæ–¹æ¡ˆä¸€å’Œæ–¹æ¡ˆäºŒï¼Œ**éœ€è¦å¤šèµ°å®Œæ•´ä¸ª WebFilter çš„è¿‡æ»¤é“¾**ã€‚è¿™æ ·ä»¿ä½›ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼

ä½†æ˜¯ï¼Œåœ¨å‰ç«¯ä½¿ç”¨ç¬¦åˆ CORS è§„èŒƒçš„ç½‘ç»œåº“æ—¶ï¼Œä¾‹å¦‚è¯´ Vue å¸¸ç”¨çš„ç½‘ç»œåº“ [axios](https://github.com/axios/axios) ï¼Œåœ¨å‘èµ·[éç®€å•è¯·æ±‚](https://www.ruanyifeng.com/blog/2016/04/cors.html)æ—¶ï¼Œä¼šè‡ªåŠ¨å…ˆå…ˆå‘èµ· `OPTIONS` â€œé¢„æ£€â€è¯·æ±‚ï¼Œè¦æ±‚æœåŠ¡å™¨ç¡®è®¤æ˜¯å¦èƒ½å¤Ÿè¿™æ ·è¯·æ±‚ã€‚å¯¹äºè¿™ç§â€œé¢„æ£€â€è¯·æ±‚ï¼Œæœ€å¥½è¢« CorsWebFilter ç›´æ¥å¤„ç†äº†ï¼Œè€Œä¸è¦èµ°å®Œæ•´ä¸ª WebFilter çš„è¿‡æ»¤é“¾ã€‚

æ‰€ä»¥ï¼Œæ¨èä½¿ç”¨ [ã€Œ8.3 CorsWebFilterã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ–¹å¼ã€‚å¹¶ä¸”ï¼ŒCorsWebFilter æœ€å¥½æ”¾åœ¨æ•´ä¸ªè¿‡æ»¤å™¨é“¾çš„**ç¬¬ä¸€ä¸ª**ã€‚

å¦‚æœèƒ–å‹è§‰å¾—æœ¬å°èŠ‚ä¸å¤Ÿå°½å…´ï¼Œå¯ä»¥è¡¥å……çœ‹çœ‹ [ã€ŠWeb on Reactive Stack â€”â€” Spring WebFlux â€”â€” CORSã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-cors) æ–‡æ¡£ã€‚

# 9. é›†æˆå“åº”å¼çš„ MongoDB

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-mongodb](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-mongodb) ã€‚

åœ¨ [ã€ŠèŠ‹é“ Spring Boot MongoDB å…¥ã€‹](http://www.iocoder.cn/Spring-Boot/MongoDB/?self) ä¸­ï¼Œæˆ‘é—¨å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ [Spring Data MongoDB](https://spring.io/projects/spring-data-mongodb) ï¼Œå½“æ—¶é€‰æ‹©çš„æ˜¯ [`spring-data-mongodb`](https://mvnrepository.com/artifact/org.springframework.data/spring-data-mongodb) åº“ï¼Œä½¿ç”¨äº† MongoDB çš„ CRUD æ“ä½œã€‚

åœ¨æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥æ•´åˆ [Spring Data MongoDB](https://spring.io/projects/spring-data-mongodb) åˆ° WebFlux ä¸­ï¼Œä½¿ç”¨ MongoDB çš„å“åº”å¼çš„ CRUD æ“ä½œã€‚ç„¶åå®ç°ç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥æ¥å£ã€‚æ¥å£åˆ—è¡¨å¦‚ä¸‹ï¼š

| è¯·æ±‚æ–¹æ³• | URL             | åŠŸèƒ½                   |
| :------- | :-------------- | :--------------------- |
| `GET`    | `/users/list`   | æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨           |
| `GET`    | `/users/get`    | è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/add`    | æ·»åŠ ç”¨æˆ·               |
| `POST`   | `/users/update` | æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/delete` | åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |

## 9.1 å¼•å…¥ä¾èµ–

åœ¨ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-01/pom.xml) æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚



```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-27-webflux-mongodb</artifactId>

    <dependencies>
        <!-- å®ç°å¯¹ Spring WebFlux çš„è‡ªåŠ¨åŒ–é…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
            <version>2.2.1.RELEASE</version>
        </dependency>

        <!-- è‡ªåŠ¨åŒ–é…ç½®å“åº”å¼çš„ Spring Data Mongodb -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-mongodb-reactive</artifactId>
        </dependency>

        <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

    </dependencies>

</project>
```



- å…·ä½“æ¯ä¸ªä¾èµ–çš„ä½œç”¨ï¼Œèƒ–å‹è‡ªå·±è®¤çœŸçœ‹ä¸‹è‰¿è‰¿æ·»åŠ çš„æ‰€æœ‰æ³¨é‡Šå™¢ã€‚

## 9.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`application.yml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-mongodb/src/main/resources/application.yaml) ä¸­ï¼Œæ·»åŠ  MongoDB é…ç½®ï¼Œå¦‚ä¸‹ï¼š



```
spring:
  data:
    # MongoDB é…ç½®é¡¹ï¼Œå¯¹åº” MongoProperties ç±»
    mongodb:
      host: 127.0.0.1
      port: 27017
      database: yourdatabase
      username: test01
      password: password01
      # ä¸Šè¿°å±æ€§ï¼Œä¹Ÿå¯ä»¥åªé…ç½® uri

logging:
  level:
    org:
      springframework:
        data:
          mongodb:
            core: DEBUG # æ‰“å° mongodb æ“ä½œçš„å…·ä½“è¯­å¥ã€‚ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä¸å»ºè®®å¼€å¯ã€‚
```



## 9.3 Application

åˆ›å»º [`Application.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-mongodb/src/main/java/cn/iocoder/springboot/lab27/springwebflux/Application.java) ç±»ï¼Œé…ç½® `@SpringBootApplication` æ³¨è§£å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Application.java

@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```



- å…ˆæš‚æ—¶ä¸å¯åŠ¨é¡¹ç›®ã€‚ç­‰æˆ‘ä»¬æ·»åŠ å¥½ API æ¥å£ã€‚

## 9.5 UserRepository

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.dao`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-mongodb/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dao) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserRepository](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-mongodb/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dao/UserRepository.java) æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserRepository.java

public interface UserRepository extends ReactiveMongoRepository<UserDO, Integer> {

    Mono<UserDO> findByUsername(String username);

}
```



- å¯¹åº”çš„å®ä½“ä¸º [`UserDO.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-mongodb/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dataobject/UserDO.java) ç±»ã€‚

- å®ç° [ReactiveMongoRepository](https://github.com/spring-projects/spring-data-mongodb/blob/master/spring-data-mongodb/src/main/java/org/springframework/data/mongodb/repository/ReactiveMongoRepository.java) æ¥å£ï¼Œå®ƒæ˜¯ MongoDB å“åº”å¼çš„ Repository åŸºç¡€æ¥å£ã€‚æ¥å£å¦‚ä¸‹ï¼š

  ```
  // ReactiveMongoRepository.java
  
  <S extends T> Mono<S> insert(S entity);
  <S extends T> Flux<S> insert(Iterable<S> entities);
  <S extends T> Flux<S> insert(Publisher<S> entities);
  <S extends T> Flux<S> findAll(Example<S> example);
  <S extends T> Flux<S> findAll(Example<S> example, Sort sort);
  ```

  

  - æ‰€æœ‰çš„è¿”å›å€¼ï¼Œéƒ½ä½¿ç”¨ Mono å’Œ Flux åŒ…è£…è¿‡ã€‚

- `#findByUsername(String username)` æ–¹æ³•ï¼Œå®šä¹‰äº†æŸ¥è¯¢æŒ‡å®šç”¨æˆ·åçš„ç”¨æˆ·ï¼Œè¿”å›çš„ç»“æœä¹Ÿç®—æ˜¯ä½¿ç”¨ Mono åŒ…è£…è¿‡ã€‚

## 9.5 UserController

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.controller`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-mongodb/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-mongodb/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserController.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserController.java

@RestController
@RequestMapping("/users")
public class UserController {

    private static final UserDO USER_NULL = new UserDO();

    @Autowired
    private UserRepository userRepository;

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/list")
    public Flux<UserVO> list() {
        // è¿”å›åˆ—è¡¨
        return userRepository.findAll()
                .map(userDO -> new UserVO().setId(userDO.getId()).setUsername(userDO.getUsername()));
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get")
    public Mono<UserVO> get(@RequestParam("id") Integer id) {
        // è¿”å›
        return userRepository.findById(id)
                .map(userDO -> new UserVO().setId(userDO.getId()).setUsername(userDO.getUsername()));
    }

    /**
     * æ·»åŠ ç”¨æˆ·
     *
     * @param addDTO æ·»åŠ ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ·»åŠ æˆåŠŸçš„ç”¨æˆ·ç¼–å·
     */
    @PostMapping("add")
    public Mono<Integer> add(UserAddDTO addDTO) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findByUsername(addDTO.getUsername());

        // æ‰§è¡Œæ’å…¥
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Integer>>() {

                    @Override
                    public Mono<Integer> apply(UserDO userDO) {
                        if (userDO != USER_NULL) {
                            // è¿”å› -1 è¡¨ç¤ºæ’å…¥å¤±è´¥ã€‚
                            // å®é™…ä¸Šï¼Œä¸€èˆ¬æ˜¯æŠ›å‡º ServiceException å¼‚å¸¸ã€‚å› ä¸ºè¿™ä¸ªç¤ºä¾‹é¡¹ç›®é‡Œæš‚æ—¶æ²¡åšå…¨å±€å¼‚å¸¸çš„å®šä¹‰ï¼Œæ‰€ä»¥æš‚æ—¶è¿”å› -1 å•¦
                            return Mono.just(-1);
                        }
                        // å°† addDTO è½¬æˆ UserDO
                        userDO = new UserDO().setId((int) (System.currentTimeMillis() / 1000)) // ä½¿ç”¨å½“å‰æ—¶é—´æˆ³çš„æè¿°ï¼Œä½œä¸º ID ã€‚
                                .setUsername(addDTO.getUsername())
                                .setPassword(addDTO.getPassword())
                                .setCreateTime(new Date());
                        // æ’å…¥æ•°æ®åº“
                        return userRepository.insert(userDO).map(UserDO::getId);
                    }

                });
    }

    /**
     * æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param updateDTO æ›´æ–°ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ˜¯å¦ä¿®æ”¹æˆåŠŸ
     */
    @PostMapping("/update")
    public Mono<Boolean> update(UserUpdateDTO updateDTO) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findById(updateDTO.getId());

        // æ‰§è¡Œæ›´æ–°
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Boolean>>() {

                    @Override
                    public Mono<Boolean> apply(UserDO userDO) {
                        // å¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œåˆ™ç›´æ¥è¿”å› false å¤±è´¥
                        if (userDO == USER_NULL) {
                            return Mono.just(false);
                        }
                        // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                        return userRepository.findByUsername(updateDTO.getUsername())
                                .defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                                .flatMap(new Function<UserDO, Mono<? extends Boolean>>() {

                                    @Override
                                    public Mono<? extends Boolean> apply(UserDO usernameUserDO) {
                                        // å¦‚æœç”¨æˆ·åå·²ç»ä½¿ç”¨ï¼ˆè¯¥ç”¨æˆ·åå¯¹åº”çš„ id ä¸æ˜¯è‡ªå·±ï¼Œè¯´æ˜å°±å·²ç»è¢«ä½¿ç”¨äº†ï¼‰
                                        if (usernameUserDO != USER_NULL && !Objects.equals(updateDTO.getId(), usernameUserDO.getId())) {
                                            return Mono.just(false);
                                        }
                                        // æ‰§è¡Œæ›´æ–°
                                        userDO.setUsername(updateDTO.getUsername());
                                        userDO.setPassword(updateDTO.getPassword());
                                        return userRepository.save(userDO).map(userDO -> true); // è¿”å› true æˆåŠŸ
                                    }

                                });
                    }

                });
    }

    /**
     * åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return æ˜¯å¦åˆ é™¤æˆåŠŸ
     */
    @PostMapping("/delete") // URL ä¿®æ”¹æˆ /delete ï¼ŒRequestMethod æ”¹æˆ DELETE
    public Mono<Boolean> delete(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findById(id);

        // æ‰§è¡Œåˆ é™¤ã€‚è¿™é‡Œä»…ä»…æ˜¯ç¤ºä¾‹ï¼Œé¡¹ç›®ä¸­ä¸è¦ç‰©ç†åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°åˆ é™¤
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Boolean>>() {

                    @Override
                    public Mono<Boolean> apply(UserDO userDO) {
                        // å¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œåˆ™ç›´æ¥è¿”å› false å¤±è´¥
                        if (userDO == USER_NULL) {
                            return Mono.just(false);
                        }
                        // æ‰§è¡Œåˆ é™¤
                        return userRepository.deleteById(id).map(aVoid -> true); // è¿”å› true æˆåŠŸ
                    }

                });
    }

}
```



- ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…ã€‚
- ç¤ºä¾‹ä¸ºäº†è®©ç¤ºä¾‹æ›´åŠ ç®€æ´ä¸€ç‚¹ï¼Œè®© Controller ç›´æ¥è°ƒç”¨äº† Repository çš„ä»£ç ã€‚å®é™…é¡¹ç›®ä¸­ï¼Œè¿˜æ˜¯æŒ‰ç…§ `Controller -> Service -> Repository` çš„è°ƒç”¨å…³ç³»ï¼Œå˜¿å˜¿ã€‚
- ç¤ºä¾‹ä¸»è¦è€ƒè™‘èƒ–å‹å¯èƒ½å¯¹ Reactor çš„ API æ–¹æ³•ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥å¹¶æœªä½¿ç”¨ Java Lambda è¡¨è¾¾å¼ç®€åŒ–ä»£ç ã€‚å®é™…é¡¹ç›®ä¸­ï¼Œ[Function](https://www.geeksforgeeks.org/function-interface-in-java-with-examples/) å¯ä»¥è¿›è¡Œç®€åŒ–ã€‚

åœ¨ Reactor Mono ä¸­ï¼Œæœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„ API æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š



```
// Mono.java

public final <R> Mono<R> map(Function<? super T, ? extends R> mapper) {
    // ... çœç•¥å®ç°
}

public final <R> Mono<R> flatMap(Function<? super T, ? extends Mono<? extends R>>
		transformer) {
    // ... çœç•¥å®ç°
}
```



- æœ¬è´¨ä¸Šï¼Œä½¿ç”¨è¿™ä¸ªä¸¤ä¸ªæ–¹æ³•çš„ç›®çš„ï¼Œéƒ½æ˜¯æ˜ å°„å’Œè½¬æ¢ï¼Œæ˜¯ä¸€è‡´çš„ã€‚

- ä¸¤è€…çš„æ–¹æ³•è¿”å›ï¼Œç»“æœéƒ½æ˜¯ `Mono<R>` ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚

- ä¸¤è€…çš„æ–¹æ³•å‚æ•°ï¼Œ`#map(...)` æ–¹æ³•æ˜¯ `Function<? super T, ? extends R>` ï¼Œè€Œ `#flatMap(...)` æ–¹æ³•æ˜¯ `Function<? super T, ? extends Mono<? extends R>>` ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Function æ¥å£çš„ä»£ç ï¼š

  ```
  // Function.java
  
  public interface Function<T, R> {
  
      R apply(T t);
  
  }
  ```

  

  - Function æ¥å£çš„ç¬¬äºŒä¸ªæ³›å‹ `R` ï¼Œä»£è¡¨ `#apply(T t)` æ¥å£æ–¹æ³•çš„è¿”å›ç±»å‹ã€‚
  - `#map(...)` æ–¹æ³•å¯¹åº”çš„ Function çš„ `R` æ³›å‹ï¼Œä¸º `? extends R` ï¼›`#flatMap(...)` æ–¹æ³•å¯¹åº”çš„ Function çš„ `R` æ³›å‹ï¼Œä¸º `? extends Mono<? extends R>` ã€‚
  - ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ`#map(...)` æ–¹æ³•æ˜¯å…¶ Function æ‰§è¡Œç»“æœåœ¨åŒ…è£…ä¸Š Mono ï¼›`#flatMap(...)` æ–¹æ³•æ˜¯å…¶ Function æ‰§è¡Œç»“æœè¿”å›å°±å·²ç»åŒ…è£…å¥½ Mono ã€‚

ğŸ˜ˆ æ€»ç»“æ¥è¯´ï¼Œ`#map(...)` å’Œ `#flatMap(...)` æ–¹æ³•çš„ä½¿ç”¨å·®å¼‚æ˜¯:

- å¦‚æœå¸Œæœ› Function è¿”å›çš„ç»“æœï¼Œè‡ªåŠ¨è¢« Mono åŒ…è£…ï¼Œåˆ™ä½¿ç”¨ `#map(...)` æ–¹æ³•ã€‚
- å¦‚æœå¸Œæœ› Function è¿”å›çš„ç»“æœï¼Œæ˜¯è‡ªå·±æ‰‹åŠ¨è¿›è¡Œ Mono åŒ…è£…ï¼Œåˆ™ä½¿ç”¨ `#flatMap(...)` æ–¹æ³•ã€‚

å› æ­¤ï¼Œåœ¨ `UserController#delete(Integer id)` æ–¹æ³•ä¸­ï¼Œå­˜åœ¨å¤šå±‚åµŒå¥—çš„é€»è¾‘ï¼Œéœ€è¦å…ˆè¿›è¡ŒæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå†æ‰§è¡Œåˆ é™¤ç”¨æˆ·æ“ä½œã€‚æ‰€ä»¥ï¼Œç¬¬ä¸€å±‚æˆ‘ä»¬ä½¿ç”¨äº† `Mono#flatMap(transformer)` æ–¹æ³•ï¼Œç¬¬äºŒå±‚æˆ‘ä»¬ä½¿ç”¨äº† `Mono#map(mapper)` æ–¹æ³•ã€‚

å¦å¤–ï¼Œå¯¹äº `#map(...)` å’Œ `#flatMap(...)` æ–¹æ³•æ¥è¯´ï¼Œå¿…é¡»ä¿è¯ Mono é‡Œçš„æ•°æ®éç©ºï¼Œä½†æ˜¯æŸ¥è¯¢åº“æ˜¾ç„¶ä¼šå­˜åœ¨æŸ¥æ‰¾ä¸åˆ°æ•°æ®ï¼Œè¿”å› `null` çš„æƒ…å†µï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† `Mono#defaultIfEmpty(defaultV)` æ–¹æ³•ï¼Œä¼ å…¥ç©º UserDO çš„æ ‡è¯†å¯¹è±¡ `USER_NULL` ã€‚å¦åˆ™ï¼Œ`#map(...)` å’Œ `#flatMap(...)` æ–¹æ³•çš„é€»è¾‘ï¼Œæ˜¯ä¸ä¼šæ‰§è¡Œçš„ã€‚

ğŸ˜ˆ æ˜¯ä¸æ˜¯ä¸å¤ªä¹ æƒ¯ä½¿ç”¨ Reactor çš„æ–¹å¼ç¼–å†™ä»£ç ï¼Œ = = è‰¿è‰¿ä¹Ÿæ˜¯~~~

# 10. é›†æˆå“åº”å¼çš„ Redis

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-redis](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-redis) ã€‚

åœ¨ [ã€ŠèŠ‹é“ Spring Boot Redis å…¥ã€‹](http://www.iocoder.cn/Spring-Boot/Redis/?self) ä¸­ï¼Œæˆ‘é—¨å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ [Spring Data Redis](https://spring.io/projects/spring-data-redis) ï¼Œå½“æ—¶é€‰æ‹©çš„æ˜¯ [`spring-data-redis`](https://mvnrepository.com/artifact/org.springframework.data/spring-data-redis) åº“ï¼Œä½¿ç”¨äº† Redis çš„ key-value æ“ä½œã€‚

åœ¨æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥æ•´åˆ [Spring Data Redis](https://spring.io/projects/spring-data-redis) åˆ° WebFlux ä¸­ï¼Œä½¿ç”¨ Redis çš„å“åº”å¼çš„ key-value æ“ä½œã€‚ç„¶åå®ç°ç”¨æˆ·ç¼“å­˜çš„è¯»å–å’Œä¿®æ”¹çš„æ¥å£ã€‚æ¥å£åˆ—è¡¨å¦‚ä¸‹ï¼š

| è¯·æ±‚æ–¹æ³• | URL          | åŠŸèƒ½               |
| :------- | :----------- | :----------------- |
| `GET`    | `/users/get` | æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„ç¼“å­˜ |
| `POST`   | `/users/set` | ä¿®æ”¹æŒ‡å®šç”¨æˆ·çš„ç¼“å­˜ |

## 10.1 å¼•å…¥ä¾èµ–

åœ¨ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-redis/pom.xml) æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚



```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-27-webflux-redis</artifactId>

    <dependencies>
        <!-- å®ç°å¯¹ Spring WebFlux çš„è‡ªåŠ¨åŒ–é…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
            <version>2.2.1.RELEASE</version>
        </dependency>

        <!-- è‡ªåŠ¨åŒ–é…ç½®å“åº”å¼çš„ Spring Data Jedis -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

    </dependencies>

</project>
```



- å…·ä½“æ¯ä¸ªä¾èµ–çš„ä½œç”¨ï¼Œèƒ–å‹è‡ªå·±è®¤çœŸçœ‹ä¸‹è‰¿è‰¿æ·»åŠ çš„æ‰€æœ‰æ³¨é‡Šå™¢ã€‚

å› ä¸º Jedis æš‚æ—¶æä¾›éé˜»å¡çš„å¼‚æ­¥ API ï¼Œå…·ä½“å¯ä»¥çœ‹çœ‹ [ISSUE#713](https://github.com/xetorthio/jedis/pull/713) ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Spring Data Redis æä¾›çš„ Redis å“åº”å¼æ“ä½œï¼Œåªèƒ½æš‚æ—¶ä½¿ç”¨ [Lettuce](https://lettuce.io/) æˆ– [Redisson](https://github.com/redisson/redisson) ä½œä¸º Redis çš„å®¢æˆ·ç«¯ã€‚

## 10.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`application.yml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-redis/src/main/resources/application.yaml) ä¸­ï¼Œæ·»åŠ  Redis é…ç½®ï¼Œå¦‚ä¸‹ï¼š



```
spring:
  # å¯¹åº” RedisProperties ç±»
  redis:
    host: 127.0.0.1
    port: 6379
    password: # Redis æœåŠ¡å™¨å¯†ç ï¼Œé»˜è®¤ä¸ºç©ºã€‚ç”Ÿäº§ä¸­ï¼Œä¸€å®šè¦è®¾ç½® Redis å¯†ç ï¼
    database: 0 # Redis æ•°æ®åº“å·ï¼Œé»˜è®¤ä¸º 0 ã€‚
    timeout: 0 # Redis è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚
```



## 10.3 RedisConfiguration

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-redis/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [RedisConfiguration](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-redis/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config/RedisConfiguration.java) é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// RedisConfiguration.java

@Configuration
public class RedisConfiguration {

    @Bean
    public ReactiveRedisTemplate<String, Object> commonRedisTemplate(ReactiveRedisConnectionFactory factory) {
        RedisSerializationContext<String, Object> serializationContext =
                RedisSerializationContext.<String, Object>newSerializationContext(RedisSerializer.string())
                        .value(RedisSerializer.json()) // åˆ›å»ºé€šç”¨çš„ GenericJackson2JsonRedisSerializer ä½œä¸ºåºåˆ—åŒ–
                        .build();
        return new ReactiveRedisTemplate<>(factory, serializationContext);
    }

    @Bean
    public ReactiveRedisTemplate<String, UserCacheObject> userRedisTemplate(ReactiveRedisConnectionFactory factory) {
        RedisSerializationContext<String, UserCacheObject> serializationContext =
                RedisSerializationContext.<String, UserCacheObject>newSerializationContext(RedisSerializer.string())
                        .value(new Jackson2JsonRedisSerializer<>(UserCacheObject.class)) // åˆ›å»ºä¸“å± UserCacheObject çš„ Jackson2JsonRedisSerializer ä½œä¸ºåºåˆ—åŒ–
                        .build();
        return new ReactiveRedisTemplate<>(factory, serializationContext);
    }

}
```



- `#commonRedisTemplate()` æ–¹æ³•ï¼Œåˆ›å»ºäº†é€šç”¨çš„ [ReactiveRedisTemplate](https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ReactiveRedisTemplate.java) Bean å¯¹è±¡ï¼Œåå­—ä¸º `"commonRedisTemplate"` ã€‚ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯é€šç”¨çš„å‘¢ï¼Ÿå› ä¸ºå…¶ value çš„åºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯é€šç”¨çš„ [GenericJackson2JsonRedisSerializer](https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/GenericJackson2JsonRedisSerializer.java) ã€‚
- `#userRedisTemplate()` æ–¹æ³•ï¼Œåˆ›å»ºä¸“å± [UserCacheObject](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-redis/src/main/java/cn/iocoder/springboot/lab27/springwebflux/cacheobject/UserCacheObject.java) çš„ [ReactiveRedisTemplate](https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ReactiveRedisTemplate.java) Bean å¯¹è±¡ï¼Œåå­—ä¸º `"userRedisTemplate"` ã€‚ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸“ç”¨çš„å‘¢ï¼Ÿå› ä¸ºå…¶ value çš„åºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯ä¸“å± UserCacheObject çš„ [Jackson2JsonRedisSerializer](https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/Jackson2JsonRedisSerializer.java) ã€‚
- å…³äº GenericJackson2JsonRedisSerializer å’Œ Jackson2JsonRedisSerializer çš„å·®åˆ«ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot Redis å…¥ã€‹](http://www.iocoder.cn/Spring-Boot/Redis/?self) çš„ [ã€Œ3. åºåˆ—åŒ–ã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) å°èŠ‚ã€‚

## 10.4 Application

åˆ›å»º [`Application.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-redis/src/main/java/cn/iocoder/springboot/lab27/springwebflux/Application.java) ç±»ï¼Œé…ç½® `@SpringBootApplication` æ³¨è§£å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// Application.java

@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```



- å…ˆæš‚æ—¶ä¸å¯åŠ¨é¡¹ç›®ã€‚ç­‰æˆ‘ä»¬æ·»åŠ å¥½ API æ¥å£ã€‚

## 10.5 UserController

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.controller`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-redis/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-redis/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserController.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserController.java

@RestController
@RequestMapping("/users")
public class UserController {

    // ========== ä½¿ç”¨é€šç”¨çš„ ReactiveRedisTemplate çš„æ–¹å¼ ==========

    @Autowired
    private ReactiveRedisTemplate<String, Object> commonRedisTemplate;

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get")
    public Mono<UserCacheObject> get(@RequestParam("id") Integer id) {
        String key = genKey(id);
        return commonRedisTemplate.opsForValue().get(key)
                .map(o -> (UserCacheObject) o);
    }

    /**
     * è®¾ç½®æŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯
     *
     * @param user ç”¨æˆ·
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PostMapping("/set")
    public Mono<Boolean> set(UserCacheObject user) {
        String key = genKey(user.getId());
        return commonRedisTemplate.opsForValue().set(key, user);
    }

    private static String genKey(Integer id) {
        return "user::" + id;
    }

    // ========== ä½¿ç”¨ä¸“å±çš„ ReactiveRedisTemplate çš„æ–¹å¼ =========

    @Autowired
    private ReactiveRedisTemplate<String, UserCacheObject> userRedisTemplate;

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/v2/get")
    public Mono<UserCacheObject> getV2(@RequestParam("id") Integer id) {
        String key = genKeyV2(id);
        return userRedisTemplate.opsForValue().get(key);
    }

    /**
     * è®¾ç½®æŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯
     *
     * @param user ç”¨æˆ·
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PostMapping("/v2/set")
    public Mono<Boolean> setV2(UserCacheObject user) {
        String key = genKeyV2(user.getId());
        return userRedisTemplate.opsForValue().set(key, user);
    }

    private static String genKeyV2(Integer id) {
        return "user::v2::" + id;
    }

}
```



- ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…ã€‚

- ç¤ºä¾‹ä¸ºäº†è®©ç¤ºä¾‹æ›´åŠ ç®€æ´ä¸€ç‚¹ï¼Œè®© Controller ç›´æ¥è°ƒç”¨äº† RedisTemplate çš„ä»£ç ã€‚å®é™…é¡¹ç›®ä¸­ï¼Œè¿˜æ˜¯æŒ‰ç…§ `Controller -> Service -> Repository` çš„è°ƒç”¨å…³ç³»ï¼Œå˜¿å˜¿ã€‚

- ç¤ºä¾‹æä¾›äº†ä¸¤ç»„ API ï¼Œå·®åˆ«åœ¨äºä½¿ç”¨é€šç”¨çš„ `commonRedisTemplate` è¿˜æ˜¯ä¸“å±çš„ `userRedisTemplate` ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸¤ç»„ API ï¼Œå­˜å‚¨åˆ° Reids ä¸­çš„ç»“æœçš„å·®åˆ«ã€‚æ‰“å¼€ `redis-cli` è¿æ¥ Redis æœåŠ¡ï¼Œæ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

  

  ```
  # é€šç”¨
  127.0.0.1:6379> get user::1
  "{\"@class\":\"cn.iocoder.springboot.lab27.springwebflux.cacheobject.UserCacheObject\",\"id\":1,\"name\":\"nicai\",\"gender\":1}"
  
  # ä¸“å±
  127.0.0.1:6379> get user::v2::1
  "{\"id\":1,\"name\":\"nicai\",\"gender\":1}"
  ```

  

  - ç›¸åŒç‚¹ï¼Œæ˜¯ value å€¼éƒ½æ˜¯ JSON åºåˆ—åŒ– UserCacheObject çš„ç»“æœã€‚
  - **ä¸åŒç‚¹ï¼Œæ˜¯é€šç”¨ç›¸æ¯”ä¸“å±æ¥è¯´ï¼Œå¤šäº† `@class` å±æ€§**ã€‚å› ä¸º GenericJackson2JsonRedisSerializer æ˜¯**é€šç”¨**çš„åºåˆ—åŒ–ç±»ï¼Œååºåˆ—åŒ–æ—¶ï¼Œé€šè¿‡ `@class` å±æ€§ï¼Œå¯ä»¥çŸ¥é“åˆ›å»ºçš„å¯¹è±¡çš„ç±»å‹ã€‚è€Œ Jackson2JsonRedisSerializer æ˜¯**ä¸“å±**çš„åºåˆ—åŒ–ç±»ï¼Œååºåˆ—åŒ–æ—¶ï¼Œå³ä½¿æ²¡æœ‰ `@class` å±æ€§ï¼Œä¹ŸçŸ¥é“åˆ›å»ºçš„å¯¹è±¡çš„ç±»å‹ã€‚

åœ¨å®é™…ä½¿ç”¨ Spring Data Redis çš„æ—¶å€™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ [StringRedisTemplate](https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/StringRedisTemplate.java) å³å¯ã€‚è€Œåœ¨æœ‰åºåˆ—åŒ–çš„æ—¶å€™ï¼Œç»™æ¯ä¸€ä¸ªéœ€è¦åºåˆ—åŒ–çš„ç±»ï¼Œåˆ›å»ºå…¶ä¸“å±çš„ [RedisTemplate](https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisTemplate.java) ã€‚

# 11. é›†æˆå“åº”å¼çš„ Elasticsearch

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-elasticsearch](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-elasticsearch) ã€‚

åœ¨ [ã€ŠèŠ‹é“ Spring Boot Elasticsearch å…¥ã€‹](http://www.iocoder.cn/Spring-Boot/Elasticsearch/?self) ä¸­ï¼Œæˆ‘é—¨å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ [Spring Data Elasticsearch](https://spring.io/projects/spring-data-elasticsearch) ï¼Œå½“æ—¶é€‰æ‹©çš„æ˜¯ [`spring-data-elasticsearch`](https://mvnrepository.com/artifact/org.springframework.data/spring-data-elasticsearch) åº“ï¼Œä½¿ç”¨äº† Elasticsearch çš„ CRUD æ“ä½œã€‚

åœ¨æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥æ•´åˆ [Spring Data Elasticsearch](https://spring.io/projects/spring-data-elasticsearch) åˆ° WebFlux ä¸­ï¼Œä½¿ç”¨ Elasticsearch çš„å“åº”å¼çš„ CRUD æ“ä½œã€‚ç„¶åå®ç°ç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥æ¥å£ã€‚æ¥å£åˆ—è¡¨å¦‚ä¸‹ï¼š

| è¯·æ±‚æ–¹æ³• | URL             | åŠŸèƒ½                   |
| :------- | :-------------- | :--------------------- |
| `GET`    | `/users/list`   | æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨           |
| `GET`    | `/users/get`    | è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/add`    | æ·»åŠ ç”¨æˆ·               |
| `POST`   | `/users/update` | æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/delete` | åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |

> å› ä¸ºä½¿ç”¨çš„æ˜¯ Spring Data Elasticsearch ï¼Œæ‰€ä»¥å’Œ [ã€Œ9. é›†æˆå“åº”å¼çš„ MongoDBã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚

## 11.1 å¼•å…¥ä¾èµ–

åœ¨ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-elasticsearch/pom.xml) æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚



```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-27-webflux-elasticsearch</artifactId>

    <dependencies>
        <!-- å®ç°å¯¹ Spring WebFlux çš„è‡ªåŠ¨åŒ–é…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
            <version>2.2.1.RELEASE</version>
        </dependency>

        <!-- è‡ªåŠ¨åŒ–é…ç½®å“åº”å¼çš„ Spring Data Elasticsearch -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
        </dependency>

        <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

    </dependencies>

</project>
```



- å…·ä½“æ¯ä¸ªä¾èµ–çš„ä½œç”¨ï¼Œèƒ–å‹è‡ªå·±è®¤çœŸçœ‹ä¸‹è‰¿è‰¿æ·»åŠ çš„æ‰€æœ‰æ³¨é‡Šå™¢ã€‚

è‡ª [`spring-data-elasticsearch`](https://mvnrepository.com/artifact/org.springframework.data/spring-data-elasticsearch) çš„ [`3.2.0.RELEASE`](https://mvnrepository.com/artifact/org.springframework.data/spring-data-elasticsearch/3.2.0.RELEASE) ç‰ˆæœ¬å¼€å§‹ï¼Œå…¶åŸºäºå“åº”å¼çš„ [WebClient](https://www.callicoder.com/spring-5-reactive-webclient-webtestclient-examples/) ï¼Œå°è£…äº†è¯·æ±‚ Elasticsearch HTTP API çš„ [DefaultReactiveElasticsearchClient](https://github.com/spring-projects/spring-data-elasticsearch/blob/master/src/main/java/org/springframework/data/elasticsearch/client/reactive/DefaultReactiveElasticsearchClient.java) å®¢æˆ·ç«¯ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆï¼ŸSpring Data Elasticsearch å¼€å§‹æ”¯æŒ**å“åº”å¼**ï¼Œå¹¶ä¸”å¼€å§‹ä½¿ç”¨ **Elasticsearch HTTP API**ã€‚

> å‹æƒ…æç¤ºï¼šSpring Data Elasticsearch ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„æ˜¯ Elasticsearch TCP API ã€‚

## 11.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`application.yml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-elasticsearch/src/main/resources/application.yaml) ä¸­ï¼Œæ·»åŠ  MongoDB é…ç½®ï¼Œå¦‚ä¸‹ï¼š



```
spring:
  data:
    # Elasticsearch é…ç½®é¡¹
    elasticsearch:
      client:
        # å¯¹åº” ReactiveRestClientProperties é…ç½®ç±»
        reactive:
          endpoints: 127.0.0.1:9200 # ES Restful API åœ°å€
```



## 11.3 ElasticsearchConfiguration

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [ElasticsearchConfiguration](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config/ElasticsearchConfiguration.java) é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// ElasticsearchConfiguration.java

@Configuration
@EnableReactiveElasticsearchRepositories // å¼€å¯å“åº”å¼çš„ Elasticsearch çš„ Repository çš„è‡ªåŠ¨åŒ–é…ç½®
public class ElasticsearchConfiguration {
}
```



- é€šè¿‡ [`@EnableReactiveElasticsearchRepositories`](https://github.com/spring-projects/spring-data-elasticsearch/blob/master/src/main/java/org/springframework/data/elasticsearch/repository/config/EnableReactiveElasticsearchRepositories.java) æ³¨è§£ï¼Œå¼€å¯å“åº”å¼çš„ Elasticsearch çš„ Repository çš„è‡ªåŠ¨åŒ–é…ç½®ã€‚

## 11.4 Application

åˆ›å»º [`Application.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/Application.java) ç±»ï¼Œé…ç½® `@SpringBootApplication` æ³¨è§£å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
@SpringBootApplication
public class Application {

    public static void main(String[] args) {
//        System.setProperty("es.set.netty.runtime.available.processors", "false");
        SpringApplication.run(Application.class, args);
    }

}
```



- å…ˆæš‚æ—¶ä¸å¯åŠ¨é¡¹ç›®ã€‚ç­‰æˆ‘ä»¬æ·»åŠ å¥½ API æ¥å£ã€‚

## 11.5 UserRepository

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.dao`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dao) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserRepository](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dao/UserRepository.java) æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserRepository.java

public interface UserRepository extends ReactiveElasticsearchRepository<UserDO, Integer> {

    Mono<UserDO> findByUsername(String username);

}
```



- å¯¹åº”çš„å®ä½“ä¸º [`UserDO.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dataobject/UserDO.java) ç±»ã€‚

- å®ç° [ReactiveElasticsearchRepository](https://github.com/spring-projects/spring-data-elasticsearch/blob/master/src/main/java/org/springframework/data/elasticsearch/repository/ReactiveElasticsearchRepository.java) æ¥å£ï¼Œå®ƒæ˜¯ Elasticsearch å“åº”å¼çš„ Repository åŸºç¡€æ¥å£ã€‚æ¥å£å¦‚ä¸‹ï¼š

  

  ```
  // ReactiveElasticsearchRepository.java
  @NoRepositoryBean
  public interface ReactiveElasticsearchRepository<T, ID> extends ReactiveSortingRepository<T, ID> {
  
  }
  ```

  

  - å…¶å®šä¹‰çš„æ¥å£ï¼Œéƒ½ä»å…¶çˆ¶æ¥å£ [ReactiveCrudRepository](https://github.com/spring-projects/spring-data-commons/blob/master/src/main/java/org/springframework/data/repository/reactive/ReactiveCrudRepository.java) å’Œ [ReactiveSortingRepository](https://github.com/spring-projects/spring-data-commons/blob/master/src/main/java/org/springframework/data/repository/reactive/ReactiveSortingRepository.java) æ‰€ç»§æ‰¿ã€‚

- `#findByUsername(String username)` æ–¹æ³•ï¼Œå®šä¹‰äº†æŸ¥è¯¢æŒ‡å®šç”¨æˆ·åçš„ç”¨æˆ·ï¼Œè¿”å›çš„ç»“æœä¹Ÿç®—æ˜¯ä½¿ç”¨ Mono åŒ…è£…è¿‡ã€‚

## 11.6 UserController

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.controller`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserController](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-elasticsearch/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserController.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserController.java

@RestController
@RequestMapping("/users")
public class UserController {

    private static final UserDO USER_NULL = new UserDO();

    @Autowired
    private UserRepository userRepository;

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/list")
    public Flux<UserVO> list() {
        // è¿”å›åˆ—è¡¨
        return userRepository.findAll()
                .map(userDO -> new UserVO().setId(userDO.getId()).setUsername(userDO.getUsername()));
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get")
    public Mono<UserVO> get(@RequestParam("id") Integer id) {
        // è¿”å›
        return userRepository.findById(id)
                .map(userDO -> new UserVO().setId(userDO.getId()).setUsername(userDO.getUsername()));
    }

    /**
     * æ·»åŠ ç”¨æˆ·
     *
     * @param addDTO æ·»åŠ ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ·»åŠ æˆåŠŸçš„ç”¨æˆ·ç¼–å·
     */
    @PostMapping("add")
    public Mono<Integer> add(UserAddDTO addDTO) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findByUsername(addDTO.getUsername());

        // æ‰§è¡Œæ’å…¥
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Integer>>() {

                    @Override
                    public Mono<Integer> apply(UserDO userDO) {
                        if (userDO != USER_NULL) {
                            // è¿”å› -1 è¡¨ç¤ºæ’å…¥å¤±è´¥ã€‚
                            // å®é™…ä¸Šï¼Œä¸€èˆ¬æ˜¯æŠ›å‡º ServiceException å¼‚å¸¸ã€‚å› ä¸ºè¿™ä¸ªç¤ºä¾‹é¡¹ç›®é‡Œæš‚æ—¶æ²¡åšå…¨å±€å¼‚å¸¸çš„å®šä¹‰ï¼Œæ‰€ä»¥æš‚æ—¶è¿”å› -1 å•¦
                            return Mono.just(-1);
                        }
                        // å°† addDTO è½¬æˆ UserDO
                        userDO = new UserDO().setId((int) (System.currentTimeMillis() / 1000)) // ä½¿ç”¨å½“å‰æ—¶é—´æˆ³çš„æè¿°ï¼Œä½œä¸º ID ã€‚
                                .setUsername(addDTO.getUsername())
                                .setPassword(addDTO.getPassword())
                                .setCreateTime(new Date());
                        // æ’å…¥æ•°æ®åº“
                        return userRepository.insert(userDO).map(UserDO::getId);
                    }

                });
    }

    /**
     * æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param updateDTO æ›´æ–°ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ˜¯å¦ä¿®æ”¹æˆåŠŸ
     */
    @PostMapping("/update")
    public Mono<Boolean> update(UserUpdateDTO updateDTO) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findById(updateDTO.getId());

        // æ‰§è¡Œæ›´æ–°
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Boolean>>() {

                    @Override
                    public Mono<Boolean> apply(UserDO userDO) {
                        // å¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œåˆ™ç›´æ¥è¿”å› false å¤±è´¥
                        if (userDO == USER_NULL) {
                            return Mono.just(false);
                        }
                        // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                        return userRepository.findByUsername(updateDTO.getUsername())
                                .defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                                .flatMap(new Function<UserDO, Mono<? extends Boolean>>() {

                                    @Override
                                    public Mono<? extends Boolean> apply(UserDO usernameUserDO) {
                                        // å¦‚æœç”¨æˆ·åå·²ç»ä½¿ç”¨ï¼ˆè¯¥ç”¨æˆ·åå¯¹åº”çš„ id ä¸æ˜¯è‡ªå·±ï¼Œè¯´æ˜å°±å·²ç»è¢«ä½¿ç”¨äº†ï¼‰
                                        if (usernameUserDO != USER_NULL && !Objects.equals(updateDTO.getId(), usernameUserDO.getId())) {
                                            return Mono.just(false);
                                        }
                                        // æ‰§è¡Œæ›´æ–°
                                        userDO.setUsername(updateDTO.getUsername());
                                        userDO.setPassword(updateDTO.getPassword());
                                        return userRepository.save(userDO).map(userDO -> true); // è¿”å› true æˆåŠŸ
                                    }

                                });
                    }

                });
    }

    /**
     * åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return æ˜¯å¦åˆ é™¤æˆåŠŸ
     */
    @PostMapping("/delete") // URL ä¿®æ”¹æˆ /delete ï¼ŒRequestMethod æ”¹æˆ DELETE
    public Mono<Boolean> delete(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findById(id);

        // æ‰§è¡Œåˆ é™¤ã€‚è¿™é‡Œä»…ä»…æ˜¯ç¤ºä¾‹ï¼Œé¡¹ç›®ä¸­ä¸è¦ç‰©ç†åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°åˆ é™¤
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Boolean>>() {

                    @Override
                    public Mono<Boolean> apply(UserDO userDO) {
                        // å¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œåˆ™ç›´æ¥è¿”å› false å¤±è´¥
                        if (userDO == USER_NULL) {
                            return Mono.just(false);
                        }
                        // æ‰§è¡Œåˆ é™¤
                        return userRepository.deleteById(id).map(aVoid -> true); // è¿”å› true æˆåŠŸ
                    }

                });
    }

}
```



- ä»£ç å’Œ [ã€Œ10. é›†æˆå“åº”å¼çš„ MongoDBã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¸é‡å¤è§£æäº†ã€‚

ğŸ˜ˆ æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œè‰¿è‰¿åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬ï¼ŒSpring Data Elasticsearch åœ¨ä½¿ç”¨å“åº”å¼çš„æ¨¡å¼ä¸‹ï¼Œæ’å…¥æ•°æ®æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºç´¢å¼•ã€‚æ‰€ä»¥ï¼Œéœ€è¦èƒ–å‹æ‰‹åŠ¨åœ¨ Elastcisearch ä¸­ï¼Œåˆ›å»º UserDO å¯¹åº”çš„ `users` ç´¢å¼•ã€‚

# 12. æ•´åˆå“åº”å¼çš„ JPA

è¿™æ˜¯ä¸€ä¸ªæ‚²ä¼¤çš„æ¶ˆæ¯ï¼ŒSpring Data æš‚æ—¶æ— æ³•æä¾›å“åº”å¼çš„ [Spring Data JPA](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/) ã€‚è¿™ç‰¹å–µçš„å¾ˆä¸¥é‡å‘€ï¼å› ä¸ºå¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæ—¥å¸¸å¼€å‘æœ€é‡è¦çš„ï¼Œå°±æ˜¯æ“ä½œ MySQLã€Oracleã€PostgreSQLã€SQLServer ç­‰å…³ç³»æ•°æ®åº“ã€‚

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼

- é—®é¢˜ä¸€ï¼ŒSpring Data JPA åŸºäº JDBC å®ç°å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œè€Œ JDBC æä¾›çš„æ˜¯é˜»å¡åŒæ­¥çš„ API æ–¹æ³•ã€‚
- é—®é¢˜äºŒï¼ŒMySQLã€Oracle ç­‰å…³ç³»æ•°æ®åº“æ˜¯ BIO æ¨¡å‹ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯çš„ Connection å¯¹åº”åˆ°æœåŠ¡ç«¯å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™æ ·ï¼Œå°±å¯¼è‡´ MySQLã€Oracle æ— æ³•å»ºç«‹å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥äº†ã€‚

å¯¹äºé—®é¢˜ä¸€ï¼Œç›®å‰ Oracle æå‡ºäº† [ADBA(Asynchronous Database Access API)](https://blogs.oracle.com/java/jdbc-next:-a-new-asynchronous-api-for-connecting-to-a-database) ï¼Œè€Œç¤¾åŒºæå‡ºäº† [r2dbc(Reactive Relational Database Connectivity)](https://github.com/r2dbc) ï¼Œå¸Œæœ›æä¾›å¼‚æ­¥éé˜»å¡çš„ API ï¼Œè®¿é—®æ•°æ®åº“ã€‚å…·ä½“çš„ï¼Œèƒ–å‹å¯ä»¥é˜…è¯»å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€ŠSpringOne å¤§ä¼šä¸Šå‘å¸ƒäº†ä¸€ä¸ªå®éªŒæ€§çš„ååº”å¼å…³ç³»å‹æ•°æ®åº“è¿æ¥é©±åŠ¨ R2DBCã€‹](https://www.infoq.cn/article/2018/10/springone-r2dbc)
- [ã€Šå“åº”å¼ç¼–ç¨‹ä¹‹æ•°æ®è®¿é—®ï¼šADBA ä¸ R2DBCã€‹](https://blog.csdn.net/alex_xfboy/article/details/89716237)

è¿™æ ·ï¼Œè™½ç„¶ MySQLã€Oracle æœåŠ¡å™¨æ˜¯ BIO çš„æ¨¡å‹ï¼Œè‡³å°‘æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯æœ‰å¼‚æ­¥éé˜»å¡çš„ API å¯ä»¥è°ƒç”¨ã€‚åªæ˜¯è¯´ï¼Œè¾›è‹¦æ•°æ®åº“æœåŠ¡å™¨è€å“¥äº†ï¼Œå˜¿å˜¿ã€‚æƒ³è¦å°é²œçš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [Spring Data R2DBC](https://spring.io/projects/spring-data-r2dbc) é¡¹ç›®ã€‚ğŸ˜ˆ çœ‹çœ‹å°±å¥½ï¼Œç›®å‰è¿˜å¤„äºå®éªŒé˜¶æ®µå“ˆ~è¿™é‡Œæ¨èçœ‹çœ‹ï¼š

- [ã€ŠA Quick Look at R2DBC with Spring Dataã€‹](https://www.baeldung.com/spring-data-r2dbc) æ–‡ç« 
- [spring-data-examples/r2dbc](https://github.com/spring-projects/spring-data-examples/tree/master/r2dbc) ç¤ºä¾‹é¡¹ç›®ï¼Œæ”¯æŒ R2DBC å’Œäº‹åŠ¡ã€‚

å¯¹äºé—®é¢˜äºŒï¼Œéœ€è¦æ•°æ®åº“è‡ªèº«å°† BIO æ”¹é€ æˆ NIO çš„æ–¹å¼ï¼Œæä¾›æ”¯æ’‘å¤§é‡å®¢æˆ·ç«¯è¿æ¥çš„èƒ½åŠ›ã€‚ä¾‹å¦‚è¯´ï¼Œå›½äº§ä¹‹å…‰ [TiDB](https://pingcap.com/docs-cn/) å°±æ˜¯åŸºäº NIO çš„æ–¹å¼ã€‚

å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œæä¾›æ•°æ®åº“ Proxy ä»£ç†æœåŠ¡å™¨ï¼Œæä¾› NIO å»ºç«‹è¿æ¥çš„æ–¹å¼ã€‚è¿™æ ·ï¼Œå³ä½¿æ•°æ®åº“æœåŠ¡å™¨æ˜¯ BIO çš„æ–¹å¼ï¼ŒProxy å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªæ•°æ®åº“çš„è¿æ¥æ± ï¼Œæä¾›æ”¯æ’‘æ›´å¤šçš„å®¢æˆ·ç«¯çš„é“¾æ¥çš„èƒ½åŠ›ã€‚ä¾‹å¦‚è¯´ï¼Œ[Sharding Sphere](https://shardingsphere.apache.org/) æä¾›äº† [Sharding Proxy](https://shardingsphere.apache.org/document/current/cn/manual/sharding-proxy/) ï¼ŒåŸºäº NIO çš„æ–¹å¼å®ç°ï¼Œå¯ä»¥æ”¯æŒä½œä¸º MySQLã€PostgreSQL çš„ Proxy æœåŠ¡å™¨ã€‚

# 13. æ•´åˆå“åº”å¼çš„ R2DBC å’Œäº‹åŠ¡

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š[lab-27-webflux-r2dbc](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-r2dbc) ã€‚

æˆ‘ä»¬çŸ¥é“ï¼ŒJDBC æä¾›çš„æ˜¯åŒæ­¥é˜»å¡çš„æ•°æ®åº“è®¿é—® API ï¼Œé‚£ä¹ˆæ˜¾ç„¶æ— æ³•åœ¨å“åº”å¼ç¼–ç¨‹ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥ WebFlux ä¹Ÿæ— æ³•å»ä½¿ç”¨ã€‚äºæ˜¯ä¹ [R2DBC](https://r2dbc.io/) è¯ç”Ÿäº†ã€‚

> FROM https://r2dbc.io/
>
> R2DBC (Reactive Relational Database Connectivity) is an endeavor to bring a reactive programming API to SQL databases.
>
> R2DBC(å“åº”å¼çš„å…³ç³»æ•°æ®åº“è¿æ¥)ï¼Œæ˜¯ä¸€ç§å°†å“åº”å¼ API å¼•å…¥ SQL æ•°æ®åº“çš„å°è¯•ã€‚

æˆ‘ä»¬å¯ä»¥ç®€å•å°†å…¶ç†è§£æˆå“åº”å¼çš„ JDBC çš„å¼‚æ­¥éé˜»å¡ API ã€‚ç›®å‰å…¶æœ‰å¤šç§é©±åŠ¨å®ç°ï¼Œæœ¬å°èŠ‚æˆ‘ä»¬ä¼šä½¿ç”¨ [jasync-sql](https://github.com/jasync-sql/jasync-sql) æ¥è®¿é—® MySQL æ•°æ®åº“ã€‚

> FROM https://github.com/jasync-sql/jasync-sql
>
> jasync-sql is a Simple, Netty based, asynchronous, performant and reliable database drivers for PostgreSQL and MySQL written in Kotlin.
>
> - åŸºäº Netty å®ç°
> - å¼‚æ­¥ã€é«˜æ€§èƒ½ã€å¯é çš„ PostgreSQLã€MySQL çš„é©±åŠ¨
> - ä½¿ç”¨ Kotlin è¯­è¨€ç¼–å†™

åœ¨ Spring Framework 5.2 M2 ç‰ˆæœ¬ï¼ŒSpring æä¾›äº† [ReactiveTransactionManager](https://github.com/spring-projects/spring-framework/blob/master/spring-tx/src/main/java/org/springframework/transaction/ReactiveTransactionManager.java) å“åº”å¼çš„äº‹åŠ¡ç®¡ç†å™¨ã€‚å¾—ç›Šäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å“åº”å¼å˜æˆä¸­ï¼Œä½¿ç”¨ [`@Transactional`](https://github.com/spring-projects/spring-framework/blob/master/spring-tx/src/main/java/org/springframework/transaction/annotation/Transactional.java) æ³¨è§£æ¥å®ç°å£°æ˜å¼äº‹åŠ¡ï¼Œåˆæˆ–è€…ä½¿ç”¨ [TransactionalOperator](https://github.com/spring-projects/spring-framework/blob/master/spring-tx/src/main/java/org/springframework/transaction/reactive/TransactionalOperator.java)æ¥å®ç°ç¼–ç¨‹å¼äº‹åŠ¡ã€‚æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ `@Transaction` æ³¨è§£æ¥å®ç°å£°æ˜å¼äº‹åŠ¡ï¼Œæ¯•ç«Ÿé¡¹ç›®ä¸­æ¯”è¾ƒå°‘ä½¿ç”¨ç¼–ç¨‹å¼äº‹åŠ¡ã€‚

ç›´æ¥ä½¿ç”¨ JDBC è®¿é—®æ•°æ®åº“ï¼Œç¼–å†™ CRUD æ˜¯å¾ˆç¹çï¼ŒåŒç† R2DBC ä¹Ÿæ˜¯ã€‚æ‰€ä»¥å¼ºå¤§çš„ Spring Data æä¾›äº† [Spring Data R2DBC](https://spring.io/projects/spring-data-r2dbc) åº“ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ R2DBC å¼€å‘ã€‚

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ¥æ•´åˆ Spring Data R2DBC åˆ° WebFlux ä¸­ï¼Œå®ç°å“åº”å¼çš„ CRUD æ“ä½œã€‚ç„¶åå®ç°ç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥æ¥å£ã€‚æ¥å£åˆ—è¡¨å¦‚ä¸‹ï¼š

| è¯·æ±‚æ–¹æ³• | URL             | åŠŸèƒ½                   |
| :------- | :-------------- | :--------------------- |
| `GET`    | `/users/list`   | æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨           |
| `GET`    | `/users/get`    | è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/add`    | æ·»åŠ ç”¨æˆ·               |
| `POST`   | `/users/update` | æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |
| `POST`   | `/users/delete` | åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ· |

> å› ä¸ºä½¿ç”¨çš„æ˜¯ Spring Data R2DBC ï¼Œæ‰€ä»¥å’Œ [ã€Œ9. é›†æˆå“åº”å¼çš„ MongoDBã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚

## 13.1 å¼•å…¥ä¾èµ–

åœ¨ [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-r2dbc/pom.xml) æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚



```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-27-webflux-r2dbc</artifactId>

    <dependencies>
        <!-- å®ç°å¯¹ Spring WebFlux çš„è‡ªåŠ¨åŒ–é…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
            <version>2.2.1.RELEASE</version>
        </dependency>

        <!-- è‡ªåŠ¨åŒ–é…ç½®å“åº”å¼çš„ Spring Data R2DBC -->
        <dependency>
            <groupId>org.springframework.boot.experimental</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
            <version>0.1.0.M2</version>
        </dependency>

        <!-- jasync çš„ r2dbc-mysql é©±åŠ¨ -->
        <dependency>
            <groupId>com.github.jasync-sql</groupId>
            <artifactId>jasync-r2dbc-mysql</artifactId>
            <version>1.0.11</version>
        </dependency>

        <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

    </dependencies>

    <repositories>
        <!-- å¼•å…¥ Spring çš„å¿«ç…§ä»“åº“ -->
        <repository>
            <id>spring-libs-snapshot</id>
            <url>https://repo.spring.io/libs-snapshot</url>
        </repository>
        <!-- å¼•å…¥ Jcenter çš„å¿«ç…§ä»“åº“ -->
        <repository>
            <id>jcenter</id>
            <url>https://jcenter.bintray.com/</url>
        </repository>
    </repositories>

</project>
```



- å…·ä½“æ¯ä¸ªä¾èµ–çš„ä½œç”¨ï¼Œèƒ–å‹è‡ªå·±è®¤çœŸçœ‹ä¸‹è‰¿è‰¿æ·»åŠ çš„æ‰€æœ‰æ³¨é‡Šå™¢ã€‚

## 13.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ [`application.yml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-r2dbc/src/main/resources/application.yaml) ä¸­ï¼Œæ·»åŠ  R2DBC é…ç½®ï¼Œå¦‚ä¸‹ï¼š



```
spring:
  # R2DBC é…ç½®ï¼Œå¯¹åº” R2dbcProperties é…ç½®ç±»
  r2dbc:
    url: mysql://47.112.193.81:3306/lab-27-webflux-r2dbc
    username: lab-27-webflux-r2dbc
    password: 0ed86@11-r2Dbc123
```



## 13.3 DatabaseConfiguration

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.config`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [DatabaseConfiguration](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/config/DatabaseConfiguration.java) é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// DatabaseConfiguration.java

@Configuration
@EnableTransactionManagement // å¼€å¯äº‹åŠ¡çš„æ”¯æŒ
public class DatabaseConfiguration {

    @Bean
    public ConnectionFactory connectionFactory(R2dbcProperties properties) throws URISyntaxException {
        // ä» R2dbcProperties ä¸­ï¼Œè§£æå‡º hostã€portã€database
        URI uri = new URI(properties.getUrl());
        String host = uri.getHost();
        int port = uri.getPort();
        String database = uri.getPath().substring(1); // å»æ‰é¦–ä½çš„ / æ–œæ 
        // åˆ›å»º jasync Configuration é…ç½®é…ç½®å¯¹è±¡
        com.github.jasync.sql.db.Configuration configuration = new com.github.jasync.sql.db.Configuration(
                properties.getUsername(), host, port, properties.getPassword(), database);
        // åˆ›å»º JasyncConnectionFactory å¯¹è±¡
        return  new JasyncConnectionFactory(new MySQLConnectionFactory(configuration));
    }

    @Bean
    public ReactiveTransactionManager transactionManager(R2dbcProperties properties) throws URISyntaxException {
        return new R2dbcTransactionManager(this.connectionFactory(properties));
    }

}
```



- é€šè¿‡ [`@EnableTransactionManagement`](https://github.com/spring-projects/spring-framework/blob/master/spring-tx/src/main/java/org/springframework/transaction/annotation/EnableTransactionManagement.java) æ³¨è§£ï¼Œå¼€å¯ Spring Transaction çš„æ”¯æŒã€‚
- `#connectionFactory(properties)` æ–¹æ³•ï¼Œåˆ›å»º JasyncConnectionFactory Bean å¯¹è±¡ã€‚å› ä¸º `spring-boot-starter-data-r2dbc` æ”¯æŒ R2DBC çš„è‡ªåŠ¨åŒ–é…ç½®ï¼Œä½†æ˜¯æš‚ä¸æ”¯æŒè‡ªåŠ¨åˆ›å»º JasyncConnectionFactory ä½œä¸º ConnectionFactory Bean ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ã€‚
- `#transactionManager(properties)` æ–¹æ³•ï¼Œåˆ›å»ºå“åº”å¼çš„ R2dbcTransactionManager äº‹åŠ¡ç®¡ç†å™¨ã€‚

## 13.4 Application

åˆ›å»º [`Application.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/Application.java) ç±»ï¼Œé…ç½® `@SpringBootApplication` æ³¨è§£å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```



- å…ˆæš‚æ—¶ä¸å¯åŠ¨é¡¹ç›®ã€‚ç­‰æˆ‘ä»¬æ·»åŠ å¥½ API æ¥å£ã€‚

## 13.5 UserRepository

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.dao`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dao) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserRepository](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dao/UserRepository.java) æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserRepository.java

public interface UserRepository extends ReactiveCrudRepository<UserDO, Integer> {

    @Query("SELECT id, username, password, create_time FROM users WHERE username = :username")
    Mono<UserDO> findByUsername(String username);

}
```



- å¯¹åº”çš„å®ä½“ä¸º [`UserDO.java`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/dataobject/UserDO.java) ç±»ã€‚å¯¹åº”å»ºè¡¨è¯­å¥è§ [`users.sql`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-27/lab-27-webflux-r2dbc/src/main/resources/sql/users.sql) æ–‡ä»¶ã€‚
- å®ç° [ReactiveCrudRepository](https://github.com/spring-projects/spring-data-commons/blob/master/src/main/java/org/springframework/data/repository/reactive/ReactiveCrudRepository.java) æ¥å£ï¼Œå®ƒæ˜¯å“åº”å¼çš„ Repository åŸºç¡€æ¥å£ã€‚
- `#findByUsername(String username)` æ–¹æ³•ï¼Œå®šä¹‰äº†æŸ¥è¯¢æŒ‡å®šç”¨æˆ·åçš„ç”¨æˆ·ï¼Œè¿”å›çš„ç»“æœä¹Ÿç®—æ˜¯ä½¿ç”¨ Mono åŒ…è£…è¿‡ã€‚
  - æ³¨æ„ï¼Œè¿™é‡Œçš„ [`@Query`](https://github.com/spring-projects/spring-data-r2dbc/blob/master/src/main/java/org/springframework/data/r2dbc/repository/query/Query.java) æ³¨è§£æ˜¯ Spring Data R2DBC è‡ªå®šä¹‰çš„ï¼Œè€Œä¸æ˜¯ JPA è§„èŒƒä¸­çš„ã€‚
  - å¦‚æœæˆ‘ä»¬æ³¨é‡Šæ‰ `@Query` æ³¨è§£ï¼Œå¯åŠ¨é¡¹ç›®ä¼šæŠ¥ "Query derivation not yet supported!" å¼‚å¸¸æç¤ºã€‚ç›®å‰çœ‹ä¸‹æ¥ï¼ŒSpring Data R2DBC æš‚æ—¶ä¸æ”¯æŒã€åŸºäºæ–¹æ³•åæŸ¥è¯¢ã€‘ã€‚

## 13.6 UserController

åœ¨ [`cn.iocoder.springboot.lab27.springwebflux.controller`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller) åŒ…è·¯å¾„ä¸‹ï¼Œåˆ›å»º [UserController](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-27/lab-27-webflux-r2dbc/src/main/java/cn/iocoder/springboot/lab27/springwebflux/controller/UserController.java) ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š



```
// UserController.java

@RestController
@RequestMapping("/users")
public class UserController {

    private static final UserDO USER_NULL = new UserDO();

    @Autowired
    private UserRepository userRepository;

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/list")
    public Flux<UserVO> list() {
        // è¿”å›åˆ—è¡¨
        return userRepository.findAll()
                .map(userDO -> new UserVO().setId(userDO.getId()).setUsername(userDO.getUsername()));
    }

    /**
     * è·å¾—æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return ç”¨æˆ·
     */
    @GetMapping("/get")
    public Mono<UserVO> get(@RequestParam("id") Integer id) {
        // è¿”å›
        return userRepository.findById(id)
                .map(userDO -> new UserVO().setId(userDO.getId()).setUsername(userDO.getUsername()));
    }

    /**
     * æ·»åŠ ç”¨æˆ·
     *
     * @param addDTO æ·»åŠ ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ·»åŠ æˆåŠŸçš„ç”¨æˆ·ç¼–å·
     */
    @PostMapping("add")
    @Transactional
    public Mono<Integer> add(UserAddDTO addDTO) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findByUsername(addDTO.getUsername());

        // æ‰§è¡Œæ’å…¥
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Integer>>() {

                    @Override
                    public Mono<Integer> apply(UserDO userDO) {
                        if (userDO != USER_NULL) {
                            // è¿”å› -1 è¡¨ç¤ºæ’å…¥å¤±è´¥ã€‚
                            // å®é™…ä¸Šï¼Œä¸€èˆ¬æ˜¯æŠ›å‡º ServiceException å¼‚å¸¸ã€‚å› ä¸ºè¿™ä¸ªç¤ºä¾‹é¡¹ç›®é‡Œæš‚æ—¶æ²¡åšå…¨å±€å¼‚å¸¸çš„å®šä¹‰ï¼Œæ‰€ä»¥æš‚æ—¶è¿”å› -1 å•¦
                            return Mono.just(-1);
                        }
                        // å°† addDTO è½¬æˆ UserDO
                        userDO = new UserDO()
                                .setUsername(addDTO.getUsername())
                                .setPassword(addDTO.getPassword())
                                .setCreateTime(new Date());
                        // æ’å…¥æ•°æ®åº“
                        return userRepository.save(userDO).flatMap(new Function<UserDO, Mono<Integer>>() {
                            @Override
                            public Mono<Integer> apply(UserDO userDO) {
                                // å¦‚æœç¼–å·ä¸ºå¶æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
                                if (userDO.getId() % 2 == 0) {
                                    throw new RuntimeException("æˆ‘å°±æ˜¯æ•…æ„æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œæµ‹è¯•ä¸‹äº‹åŠ¡å›æ»š");
                                }

                                // è¿”å›ç¼–å·
                                return Mono.just(userDO.getId());
                            }
                        });
                    }

                });
    }

    /**
     * æ›´æ–°æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param updateDTO æ›´æ–°ç”¨æˆ·ä¿¡æ¯ DTO
     * @return æ˜¯å¦ä¿®æ”¹æˆåŠŸ
     */
    @PostMapping("/update")
    public Mono<Boolean> update(UserUpdateDTO updateDTO) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findById(updateDTO.getId());

        // æ‰§è¡Œæ›´æ–°
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Boolean>>() {

                    @Override
                    public Mono<Boolean> apply(UserDO userDO) {
                        // å¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œåˆ™ç›´æ¥è¿”å› false å¤±è´¥
                        if (userDO == USER_NULL) {
                            return Mono.just(false);
                        }
                        // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                        return userRepository.findByUsername(updateDTO.getUsername())
                                .defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                                .flatMap(new Function<UserDO, Mono<? extends Boolean>>() {

                                    @Override
                                    public Mono<? extends Boolean> apply(UserDO usernameUserDO) {
                                        // å¦‚æœç”¨æˆ·åå·²ç»ä½¿ç”¨ï¼ˆè¯¥ç”¨æˆ·åå¯¹åº”çš„ id ä¸æ˜¯è‡ªå·±ï¼Œè¯´æ˜å°±å·²ç»è¢«ä½¿ç”¨äº†ï¼‰
                                        if (usernameUserDO != USER_NULL && !Objects.equals(updateDTO.getId(), usernameUserDO.getId())) {
                                            return Mono.just(false);
                                        }
                                        // æ‰§è¡Œæ›´æ–°
                                        userDO.setUsername(updateDTO.getUsername());
                                        userDO.setPassword(updateDTO.getPassword());
                                        return userRepository.save(userDO).map(userDO -> true); // è¿”å› true æˆåŠŸ
                                    }

                                });
                    }

                });
    }

    /**
     * åˆ é™¤æŒ‡å®šç”¨æˆ·ç¼–å·çš„ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ç¼–å·
     * @return æ˜¯å¦åˆ é™¤æˆåŠŸ
     */
    @PostMapping("/delete") // URL ä¿®æ”¹æˆ /delete ï¼ŒRequestMethod æ”¹æˆ DELETE
    public Mono<Boolean> delete(@RequestParam("id") Integer id) {
        // æŸ¥è¯¢ç”¨æˆ·
        Mono<UserDO> user = userRepository.findById(id);

        // æ‰§è¡Œåˆ é™¤ã€‚è¿™é‡Œä»…ä»…æ˜¯ç¤ºä¾‹ï¼Œé¡¹ç›®ä¸­ä¸è¦ç‰©ç†åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°åˆ é™¤
        return user.defaultIfEmpty(USER_NULL) // è®¾ç½® USER_NULL ä½œä¸º null çš„æƒ…å†µï¼Œå¦åˆ™ flatMap ä¸ä¼šå¾€ä¸‹èµ°
                .flatMap(new Function<UserDO, Mono<Boolean>>() {

                    @Override
                    public Mono<Boolean> apply(UserDO userDO) {
                        // å¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œåˆ™ç›´æ¥è¿”å› false å¤±è´¥
                        if (userDO == USER_NULL) {
                            return Mono.just(false);
                        }
                        // æ‰§è¡Œåˆ é™¤
                        return userRepository.deleteById(id).map(aVoid -> true); // è¿”å› true æˆåŠŸ
                    }

                });
    }

}
```



- ä»£ç å’Œ [ã€Œ10. é›†æˆå“åº”å¼çš„ MongoDBã€](http://www.iocoder.cn/Spring-Boot/WebFlux/?github#) æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œå°±ä¸é‡å¤è§£æäº†ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ `#add(UserAddDTO addDTO)` æ–¹æ³•ä¸Šï¼Œæ·»åŠ äº† `@Transactional` æ³¨è§£ï¼Œè¡¨ç¤ºæ•´ä¸ªé€»è¾‘éœ€è¦åœ¨äº‹åŠ¡ä¸­è¿›è¡Œã€‚åŒæ—¶ï¼Œä¸ºäº†æ¨¡æ‹Ÿäº‹åŠ¡å›æ»šçš„æƒ…å†µï¼Œæˆ‘ä»¬æ•…æ„åœ¨æ’å…¥è®°å½•çš„ `id` ç¼–å·ä¸ºå¶æ•°æ—¶ï¼ŒæŠ›å‡º RuntimeException å¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡ã€‚ğŸ˜ˆ è‰¿è‰¿è‡ªå·±å·²ç»æµ‹è¯•ï¼Œç¡®å®äº‹åŠ¡å¯ä»¥å›æ»šã€‚

æ›´å¤šå†…å®¹ï¼Œèƒ–å‹å¯ä»¥çœ‹çœ‹ [ã€ŠSpring Data R2DBC - Reference Documentationã€‹](https://docs.spring.io/spring-data/r2dbc/docs/1.0.0.RC1/reference/html/#preface) æ–‡æ¡£ã€‚

# 14. å…¶ä»–å†…å®¹

WebFlux åŸºæœ¬å¸¦æ¥äº†å…¨æ–°çš„æŠ€æœ¯ä½“ç³»ï¼Œæ‰€ä»¥æ¶‰åŠçš„å†…å®¹ï¼Œå…¶å®éå¸¸å¤šï¼Œæœ¬æ–‡å¹¶æœªå…¨éƒ¨è¦†ç›–åˆ°ã€‚è‰¿è‰¿å»ºè®®ï¼Œå¯ä»¥æŠ½æ—¶é—´å†æŠŠ [ã€ŠWeb on Reactive Stackã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html) æ–‡æ¡£é˜…è¯»ä¸‹ã€‚

å¦‚ä¸‹å†…å®¹ï¼Œèƒ–å‹å¯ä»¥æ‰¾æ—¶é—´çœ‹çœ‹ã€‚

- WebClient ï¼š
  - [ã€ŠWeb on Reactive Stack â€”â€” WebClientã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-client)
  - [ã€Šspring 5 WebClient ä½¿ç”¨æŒ‡å—ã€‹](https://juejin.im/post/5a62f17cf265da3e51333205)
  - [ã€ŠSpring 5 WebClientã€‹](https://www.baeldung.com/spring-5-webclient)
- WebSocket ï¼š
  - [ã€ŠWeb on Reactive Stack â€”â€” WebSocketã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-websocket)
- æœåŠ¡ç«¯æ¨é€äº‹ä»¶ SSE(Server send event)ï¼š
  - [ã€Šä½¿ç”¨ Spring 5 çš„ Webflux å¼€å‘ Reactive åº”ç”¨ â€”â€” æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼ˆSSEï¼‰ã€‹](https://windmt.com/2018/04/25/spring-web-reactive-webflux/#æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼ˆSSEï¼‰)
- RSocket ï¼š
  - [ã€ŠWeb on Reactive Stack â€”â€” RSocketã€‹](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#rsocket)

# 666. å½©è›‹

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº† Spring WebFlux çš„ç®€å•å…¥é—¨ã€‚å¦‚æœç”¨ä¸€å¥ç®€å•çš„è¯æ¥æ¦‚æ‹¬ WebFlux çš„è¯ï¼Œé‚£å°±æ˜¯ï¼š

- WebFlux åœ¨ Spring Framework 5 æ¨å‡ºçš„ï¼Œä»¥ Reactor åº“ä¸ºåŸºç¡€ï¼ŒåŸºäºå¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨ï¼Œå®ç°çš„å“åº”å¼ Web å¼€å‘æ¡†æ¶ã€‚
- WebFlux èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„ç¡¬ä»¶èµ„æºï¼Œå¤„ç†å¤§é‡çš„å¹¶å‘è¯·æ±‚ã€‚å› æ­¤ï¼Œå¯ä»¥åœ¨ä¸æ‰©å……ç¡¬ä»¶çš„èµ„æºçš„æƒ…å†µä¸‹ï¼Œæå‡ç³»ç»Ÿçš„ååæ€§å’Œä¼¸ç¼©æ€§ã€‚

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬æåˆ°çš„æ˜¯**ååæ€§å’Œä¼¸ç¼©æ€§**ï¼Œè€Œä¸æ˜¯æå‡æ¯ä¸ªè¯·æ±‚çš„**æ€§èƒ½**ã€‚æˆ‘ä»¬æ¥å›æƒ³ä¸‹æ•´ä¸ª WebFlux çš„æ‰§è¡Œè¿‡ç¨‹ï¼šè¯·æ±‚æ˜¯è¢«ä½œä¸º**ä¸€ä¸ªäº‹ä»¶**ä¸¢åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œç­‰åˆ°æ‰§è¡Œå®Œæ¯•ï¼Œ**å¼‚æ­¥**å›è°ƒç»“æœç»™ä¸»çº¿ç¨‹ï¼Œæœ€åè¿”å›ç»™å‰ç«¯ã€‚

é‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹ï¼Œç›¸æ¯” SpringMVC çš„æ‰§è¡Œè¿‡ç¨‹æ¥è¯´ï¼Œè‡³å°‘å¤šäº†ä¸€æ¬¡çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œçº¿ç¨‹çš„åˆ‡æ¢æ˜¯æœ‰æˆæœ¬çš„ã€‚æ‰€ä»¥ï¼Œå•çœ‹ä¸€ä¸ªè¯·æ±‚çš„å¤„ç†ï¼ŒSpringMVC çš„æ€§èƒ½æ˜¯ä¼˜äº WebFlux çš„ã€‚

> æˆ‘ä»¬ä¸Šæ–‡æåˆ°çš„ä¸»çº¿ç¨‹ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯ IO çº¿ç¨‹ã€‚

ä½†æ˜¯ï¼Œç”±äº WebFlux çš„ IO çº¿ç¨‹æ˜¯éé˜»å¡çš„ï¼Œå¯ä»¥ä¸æ–­è§£æè¯·æ±‚ï¼Œä¸¢åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚è€Œ SpringMVC çš„ IO çº¿ç¨‹æ˜¯é˜»å¡çš„ï¼Œéœ€è¦ç­‰åˆ°è¯·æ±‚è¢«å¤„ç†å®Œæ¯•ï¼Œæ‰èƒ½è§£æä¸‹ä¸€ä¸ªè¯·æ±‚å¹¶è¿›è¡Œå¤„ç†ã€‚è¿™æ ·ï¼Œéšç€æ¯ä¸ªè¯·æ±‚çš„è¢«å¤„ç†æ—¶é—´è¶Šé•¿ã€å¹¶å‘è¯·æ±‚çš„é‡çº§è¶Šå¤§ï¼ŒWebFlux ç›¸æ¯” SpringMVC çš„æ•´ä½“ååé‡é«˜çš„è¶Šå¤šï¼Œ**å¹³å‡**çš„è¯·æ±‚å“åº”æ—¶é—´è¶ŠçŸ­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æ€§èƒ½å¯¹æ¯”](http://static.iocoder.cn/d7b637d5233897d383207f678a54b042)

ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œéšç€å¹¶å‘è¯·æ±‚é‡çš„å¢å¤§ï¼ŒWebFlux çš„å“åº”æ—¶é—´å¹³ç¨³åœ¨ 100ms å·¦å³ï¼Œè€Œ SpringMVC çš„å“åº”å¼æ—¶é—´ä» 3000 å¹¶å‘é‡å¼€å§‹ï¼Œå“åº”æ—¶é—´ç›´çº¿ä¸Šå‡ã€‚ğŸ˜ˆ æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼Œè‡ªå·±åšä¸€æ³¢æ€§èƒ½çš„åŸºå‡†æµ‹è¯•ï¼š

- [ã€Šæ€§èƒ½æµ‹è¯• â€”â€” SpringMVCã€Webflux åŸºå‡†æµ‹è¯•ã€‹](http://www.iocoder.cn/Performance-Testing/SpringMVC-Webflux-benchmark/?self)
- [ã€Šæ€§èƒ½æµ‹è¯• â€”â€” Spring Cloud Gatewayã€Zuul åŸºå‡†æµ‹è¯•ã€‹](http://www.iocoder.cn/Performance-Testing/SpringCloudGateway-Zuul-benchmark/?self)
- [ã€ŠWebFlux æ€§èƒ½æµ‹è¯•ã€‹](https://lxdd.gitbook.io/spring-webflux/webflux/xing-neng-ce-shi)
- [ã€ŠWebFlux æ€§èƒ½é—®é¢˜å’Œé€‚ç”¨åœºæ™¯ã€‹](https://blog.lovezhy.cc/2018/12/29/webfluxæ€§èƒ½é—®é¢˜/)

é‚£ä¹ˆä»€ä¹ˆåœºæ™¯ä¸‹çš„æœåŠ¡ï¼Œé€‚åˆä½¿ç”¨ WebFlux å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠä»»åŠ¡åˆ†æˆ IO å¯†é›†å‹å’Œ CPU å¯†é›†å‹ï¼Œè€ŒæœåŠ¡æœ¬è´¨ä¸Šï¼Œæ˜¯æ‰§è¡Œä¸€ä¸ªåˆä¸€ä¸ªçš„ä»»åŠ¡ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è¿™ä¹ˆåˆ†ã€‚ğŸ˜ˆ ä¸äº†è§£ IO å¯†é›†å‹å’Œ CPU å¯†é›†å‹çš„èƒ–å‹ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ [ã€Šè®¡ç®—å¯†é›†å‹å’Œ IO å¯†é›†å‹ã€‹](https://www.kancloud.cn/chandler/programming_road/695592) æ–‡ç« ã€‚

è€Œæˆ‘ä»¬ä¸šåŠ¡ä¸­ç¼–å†™çš„ä»£ç ï¼Œéƒ½æ— ä¸€å¹¸å…éœ€è¦è·Ÿ MySQLã€MongoDBã€Elasticsearch ç­‰æ•°æ®åº“æ‰“äº¤é“ï¼Œåˆæˆ–è€…è·Ÿ Redisã€Memcached ç­‰ç¼“å­˜æœåŠ¡æ‰“äº¤é“ï¼Œè¿˜æˆ–è€…éœ€è¦è·Ÿ RocketMQã€RabbitMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—æ‰“äº¤é“ã€‚æ— è®ºè¿™äº›ä¸­é—´ä»¶åšçš„å¤šç‰›é€¼ï¼Œæ€§èƒ½å¤šä¹ˆæ‰æ¸£å¤©ï¼Œæˆ‘ä»¬éƒ½æ— æ³•é¿å…ä¼šç»è¿‡ç½‘ç»œ IO å’Œç£ç›˜ IO ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æä¾›çš„æœåŠ¡ï¼Œå¤§å¤šæ•°éƒ½æ˜¯ IO å¯†é›†å‹ã€‚å¾ˆå°‘ä¼šå­˜åœ¨ï¼Œç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼Œç›´æ¥è¿”å›çš„æƒ…å†µã€‚

**å› æ­¤ï¼Œæˆ‘ä»¬ä¸šåŠ¡ä¸­ç¼–å†™çš„ä»£ç ï¼Œç»å¤§å¤šå¤šå¤šæ•°éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œéƒ½æ˜¯é€‚åˆä½¿ç”¨ WebFlux çš„ã€‚**ä½†æ˜¯ï¼Œå“åº”å¼ç¼–ç¨‹å¯¹å¼€å‘äººå‘˜çš„ç¼–ç èƒ½åŠ›è¦æ±‚ä¼šæ¯”è¾ƒé«˜ï¼Œä¸€æ—¦è„‘å­ä¸€æŠ½ï¼Œåœ¨ IO çº¿ç¨‹ä¸­ç¼–å†™äº†é˜»å¡ä»£ç ï¼Œåå€’å‡ºç°æ€§èƒ½ä¸‹æ»‘ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹è‰¿è‰¿åœ¨ [ã€Šæ€§èƒ½æµ‹è¯• â€”â€” SpringMVCã€Webflux åŸºå‡†æµ‹è¯•ã€‹](http://www.iocoder.cn/Performance-Testing/SpringMVC-Webflux-benchmark/?self) æä¾›çš„æµ‹è¯•ç¤ºä¾‹ï¼Œæ˜æ˜ç™½ç™½çš„ã€‚

è‰¿è‰¿å»ºè®®çš„è¯ï¼Œå¦‚æœè€ƒè™‘ä½¿ç”¨ WebFlux çš„è¯ï¼Œä¸€å®šè¦æŠŠ Reactor å¥½å¥½å­¦ä¹ ä¸‹ï¼Œä¸ç„¶çœŸçš„æ˜¯åšå®å¤§å‘å¥½ã€‚åŒæ—¶ï¼Œæ¯æ¬¡ä¸Šçº¿ä¹‹å‰ï¼Œå¯¹ä½¿ç”¨ WebFlux ç¼–å†™çš„æœåŠ¡ï¼Œåšä¸‹æ€§èƒ½æµ‹è¯•ï¼Œå¯ä»¥å‘ç°ç¼–å†™ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œæ‰¾åˆ°é˜»å¡ IO çº¿ç¨‹çš„é€»è¾‘ã€‚

ç›®å‰ï¼Œæš‚æ—¶æ‰¾ä¸åˆ°å¤§è§„æ¨¡ä½¿ç”¨ WebFlux çš„ä¸šåŠ¡å¼€æºé¡¹ç›®ï¼Œæœ€å¤§ä½¿ç”¨ WebFlux æ„å»ºçš„å¼€æºé¡¹ç›®ï¼Œå°±æ˜¯ Spring Cloud å¼€æºçš„ç½‘å…³ [Spring Cloud Gateway](https://cloud.spring.io/spring-cloud-gateway/reference/html/) ã€‚ğŸ˜ˆ å¯èƒ½ï¼ŒWebFlux æˆ–è€…å“åº”å¼ç¼–ç¨‹æœ€å¥½çš„å½’å®¿ï¼Œæš‚æ—¶æ˜¯ä¸­é—´ä»¶ã€‚å¦‚æœèƒ–å‹æœ‰çœ‹è¿‡ [Dubbo](http://www.iocoder.cn/Dubbo/good-collection/?self) çš„[çº¿ç¨‹æ¨¡å‹](https://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html)ï¼Œå°±ä¼šå‘ç°å’Œ WebFlux æ˜¯å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚