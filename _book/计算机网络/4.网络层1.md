##  一 网络层的功能

### 1.主要任务

- 将分组从源端传到目的端,为分组交换网上的不同主机提供通信服务.
- 网络层的传输单位是数据报

### 2.异构网络互联

所谓`异构网络互联`，是指将两个以上的不同的计算机网络，通过一定的方法， 用一种或多种通信处理设备(即中间设备)相互连接起来，以构成更大的网络系统。中间设备又称`中间系统`或`中继系统`。
根据所在的层次，·`中继系统`分为以下4种:

- 1)物理层中继系统:中继器，集线器(Hub)。
- 2)数据链路层中继系统:网桥或交换机。
- 3)网络层中继系统:路由器。
- 4)网络层以上的中继系统:网关。

使用物理层或数据链路层的中继系统时,只是单纯吧一个网络扩大了,而从网络层的角度来看,它仍然是一个个独立的网络,

不能称之为网络互连.**网络互联通常是指用路由器进行网络互联和路由选择**.路由器是一台专门的计算机,用于在互联网中进行路由选择和转发

TCP/IP 体系再网络互联上采用的做法是再网络层(即IP层) 采用标准化的协议,

即使相互连接的网络是**异构**的,但由于都是用相同的网际协议(Internet Protocol,IP),因此可以把互联后的网络称之为一个虚拟IP网络

也即使这些性能各异的网络在网络层看起来就像是一个统一的网络,简称IP网络



### 3.路由选择与转发

路由器主要完成两个功能:是`路由选择 (确定哪一 条路径)`，二是`分组转发 (当一个分组 到达时所采取的动作)`。

- 1)路由选择。指按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑
  的变化情况，动态地改变所选择的路由。
- 2)分组转发。指路由器根据转发表将用户的IP数据报从合适的端口转发出去。

`路由表`是根据`路由选择算法`得出的，而`转发表`是从`路由表`得出的。
`路由表`则需要对`网络拓扑变化的计算最优化`,`转发表`的结构应当使`查找过程最优化`。
在讨论路由选择的原理时，往往不去区分转发表和路由表，而是笼统地使用路由表一词。

### 4.拥塞控制

![img](https://gitee.com/zisuu/picture/raw/master/img/20201126201140.png)

- 在通信子网中，因出现过量的分组而引起网络性能下降的现象称为`拥塞`。
- `判断网络是否进入拥塞状态的方法`是，观察网络的`吞吐量与网络负载的关系`:如果随着`网络负载的增加`，`网络的吞吐量明显小于正常的吞吐量`，那么网络就可能已进入“`轻度拥塞”`状态;如果`网络的负载继续增大`，而网络的`吞吐量下降到零`，那么网络就可能已进入`死锁状态`。
- `拥塞控制的作用是确保子网能够承载所达到的流量`，这是一一个全局性的过程，涉及各方面的行为:主机、路由器及路由器内部的转发处理过程等。单一地增加资源并不能解决拥塞。
- `流量控制`和`拥塞控制`的`区别`:
- ·`流量控制`往往是指在发送端和接收端之间的点对点通信量的控制。流量控制所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。
- `拥塞控制`必须确保通信子网能够传送待传送的数据，是一一个全局性的问题，涉及网络中所有的主机、路由器及导致网络传输能力下降的所有因素。
- `拥塞控制的方法有两种`:
  1)·`开环控制`。在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。这是一种`静态`的预防方法。一旦整个系统启动并运行，中途就不再需要修改。开环控制手段包括确定何时可接收新流量、何时可丢弃分组及丢弃哪些分组，确定何种调度决策等。所有这些手段的共性是，在做决定时不考虑当前网络的状态。
  2)`闭环控制`。事先不考虑有关发生拥塞的各种因素，采用监测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。闭环控制是基于反馈环路的概念，是一种`动态`的方法。





## 二 数据交换

![image-20201126201438266](https://gitee.com/zisuu/picture/raw/master/img/20201126201438.png)



- 应用层   报文
- 传输层 报文段/用户数据段
- 网络层 IP数据报/分组
- 数据链路层  帧
- 物理层 比特

### 1.电路交换

- 在进行数据传输前，两个结点之间必须先建立一条专用 (双方独占)的物理通信路径(由通信双方之间的交换设备和链路逐段连接而成)，该路径可能经过许多中间结点。这一路径在整个数据传输期间一直被独占，直到通信结束后才被释放。
- 因此，电路交换技术分为三个阶段:`连接建立、数据传输和连接释放`。

![image-20201126201644796](https://gitee.com/zisuu/picture/raw/master/img/20201126201644.png)

### 2.报文交换



![image-20201126202058211](https://gitee.com/zisuu/picture/raw/master/img/20201126202058.png)

- 数据交换的单位是报文，报文携带有源地址，目标地址，数据等信息。
- `报文交换的主要特点是`：存储接受到的报文，判断其目标地址以选择路由，最后，在下一跳路由空闲时，将数据转发给下一跳路由。 中文名报文交换，外文名Message switching。
- 报文交换技术的`优点`如下:
  1)`无须建立连接`。报文交换不需要为通信双方预先建立一条专用的通信线路，不存在建立
  连接时延，用户可以随时发送报文。
  2)`动态分配线路`。当发送方把报文交给交换设备时，交换设备先存储整个报文，然后选择
  一条合适的空闲线路，将报文发送出去。
  3)`提高线路可靠性`。如果某条传输路径发生故障，那么可重新选择另一条路径传输数据，
  因此提高了传输的可靠性。
  4)`提高线路利用率`。通信双方不是固定占有一条通信线路，而是在不同的时间一段一段地
  部分占有这条物理通道，因而大大提高了通信线路的利用率。
  5)`提供多目标服务`。一个报文可以同时发送给多个目的地址，这在电路交换中是很难实现的。
- 报文交换技术的`缺点`如下:
  1)由于数据进入交换结点后要经历存储、转发这一过程，因此会引起`转发时延`(包括接收
  报文、检验正确性、排队、发送时间等)。
  2)报文交换对报文的大小没有限制，这就要求`网络结点需要有较大的缓存空间`。

注意:报文交换主要使用在早期的电报通信网中，现在较少使用，通常被较先进的分组交换
方式所取代。

### 3.分组交换

![image-20201126202516365](https://gitee.com/zisuu/picture/raw/master/img/20201126202516.png)

- 同报文交换一样，分组交换也采用存储转发方式，但解决了报文交换中大报文传输的问题。分组交换限制了每次传送的数据块大小的上限，把大的数据块划分为合理的小数据块，再加上一些必要的控制信息(如源地址、目的地址和编号信息等)，构成分组(Packet)。 网络结点根据控制信息把分组送到下一结点，下一结点接收到分组后，暂时保存并排队等待传输，然后根据分组控制信息选择它的下一个结点，直到到达目的结点。到达目地之后的数据分组再重新组合起来，形成一条完整的数据。
- 分组交换的`优点`如下:
  1)`无建立时延`。不需要为通信双方预先建立一条专用的通信线路，不存在连接建立时延，用户可随时发送分组。
  2)`线路利用率高`。通信双方不是固定占有- -条通信线路，而是在不同的时间一-段一段地部分占有这条物理通路，因而大大提高了通信线路的利用率。
  3)`简化了存储管理(相对于报文交换)`。因为分组的长度固定，相应的缓冲区的大小也固定，在交换结点中存储器的管理通常被简化为对缓冲区的管理，相对比较容易。
  4)`加速传输`。分组是逐个传输的，可以使后-一个分组的存储操作与前一一个分组的转发操作并行，这种流水线方式减少了报文的传输时间。此外，传输一个分组所 需的缓冲区比传输一次报文所需的缓冲区小得多，这样因缓冲区不足而等待发送的概率及时间也必然少得多。
  5)`减少了出错概率和重发数据量`。因为分组较短，其出错概率必然减小，所以每次重发的数据量也就大大减少，这样不仅提高了可靠性，也减少了传输时延。
- 分组交换的`缺点`如下:
  1)`存在传输时延`。尽管分组交换比报文交换的传输时延少，但相对于电路交换仍存在存储转发时延，而且其结点交换机必须具有更强的处理能力。
  2)`需要传输额外的信息量`。每个小数据块都要加上源地址、目的地址和分组编号等信息，从而构成分组，因此使得传送的信息量增大了5%~10%，一定程度上降低了通信效率，增加了处理的时间，使控制复杂，时延增加。
  3)`当分组交换采用数据报服务时，可能会出现失序、丢失或重复分组`，分组到达目的结点时，要对分组按编号进行排序等工作，因此很麻烦。若采用虚电路服务，虽无失序问题，但有呼叫建立、数据传输和虚电路释放三个过程。
- `分组交换`根据其`通信子网向端点系统提供的服务`，还可进一步分为`面向连接的虚电路`方式和
  `无连接的数据报方式`。这两种服务方式都由网络层提供。要注意`数据报方式`和`虚电路方式`是`分组 交换的两种方式`。

![image-20201126202530942](https://gitee.com/zisuu/picture/raw/master/img/20201126202531.png)

## 三 路由算法

### 1.静态路由与动态路由

`路由器转发分组`是通过`路由表`转发的，而`路由表`是通过`各种算法`得到的。从能否随网络的通
信量或拓扑自适应地进行调整变化来划分，`路由算法`可分为两大类：`静态路由与动态路由`。、

- 静态路由指需要网络管理员手工配置路由信息.

- 动态路由(又称自适应路路由算法),指路由器上的路由表项使根据相互连接的路由器之间彼此交换信息,然后按照一定的

  算法优化出阿里的.这些路由信息会在一定时间内不断的更新,以适应网络的变化.常用的动态路由算法可分为两类:

  - 距离-向量路由算法(RIP)
  - 链路状态路由算法(OSPF)

链路状态路由算法和距离向量路由算法的`比较`

- `在距离-向量路由算法中`，每个结点仅与它的直接`邻居`交谈，它为它的邻居提供从自己到网络中所有其他结点的最低费用估计。
- `在链路状态路由算法中`，每个结点通过`广播`的方式与所有`其他结点`交谈，但它仅告诉它们与它直接相连的链路的费用。
- 相较之下，距离-向量路由算法有可能遇到路由环路等问题。



### 2.层次路由

当网络规模扩大时,路由器的路由表成比例的增大.这回消耗极大的时间和资源来扫描路由表

因此路由选择必须要按照层次的方法进行

因特网将整个互联网划分为许多较小的自治系统(AS)(一个自治系统又包含很多的局域网),每个自治系统有权

选择本系统采用何种的路由选择协议.

而如果两个自治系统需要通信,就需要一种在两个自治系统之间的协议来屏蔽这些差异.

![image-20201126203857552](https://gitee.com/zisuu/picture/raw/master/img/20201126203857.png)



![image-20201126203914950](https://gitee.com/zisuu/picture/raw/master/img/20201126203915.png)



## 四 IPV4 ⭐

### 1.TCP/IP协议栈

之前我们介绍过IP在TCP/IP协议族中的位置:

![image-20201126204235301](https://gitee.com/zisuu/picture/raw/master/img/20201126204235.png)

### 2.IPv4分组

IPv4即现在普遍使用的IP(版本4).IP定义数据传送的基本单元---IP分组及其确切的数据格式

IP也包括一套规则,指明分组如何处理,错误怎样控制

#### 1.IPv4分组的格式

一个IP分组由首部和数据两部分组成。首部前一部分的长度固定，共`20B`，是所有IP分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。

![image-20201126204937326](https://gitee.com/zisuu/picture/raw/master/img/20201126204937.png)

可变部分格式:

![image-20201126205014036](https://gitee.com/zisuu/picture/raw/master/img/20201126205014.png)



> - 1)`版本`。指IP的版本，目前广泛使用的版本号为4。
> - 2)`首部长度`。`占4位,1B`。以32位为单位，最大值为60B (15*4B)。最常用的首部长度是20B,此时不使用任何选项(即可选字段)。
> - 3)`总长度`。`占16位,2B`。指首部和数据之和的长度，单位为字节，因此数据报的最大长度为216-1= 65535B。以太网帧的最大传送单元(MTU)为1500B，因此当一个IP数据报封装成帧时，数据报的总长度(首部加数据) - -定不能超过下面数据链路层的MTU值。
> - 4)`标识`。占16位。它是一个计数器，每产生一个数据报就加1,并赋值给标识字段。但它并不是“序号”(因为IP是无连接服务)。当一个数据报的长度超过网络的MTU时，必须分片，此时每个数据报片都复制一次标识号， 以便能正确重装成原来的数据报。
> - 5)`标志`。占3位。标志字段的最低位为MF, MF= 1表示后面还有分片，MF= 0表示最后一个分片。” 标志字段中间的一位是DF,只有当DF =0时才允许分片。
> - 6)`片偏移`。占13位。它指出较长的分组在分片后，某片在原分组中的相对位置。片偏移以`8个字节为偏移单位,8B`，即每个分片的长度一定是8B (64 位)的整数倍。
> - 7)`首部校验和`。占16位。IP数据报的首部校验和只校验分组的首部，而不校验数据部分。
> - 8)`生存时间(TTL)`。占8位。数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。路由器在转发分组前，先把TTL减1。若TTL被减为0，则该分组必须丢弃。
> - 9)`协议`。占8位。指出此分组携带的数据使用何种协议，即分组的数据部分应交给哪个传输层协议，如TCP、UDP等。其中值为6表示TCP,值为17表示UDP。
> - 10)`源地址字段`。占4B，标识发送方的IP地址。
> - 11)目的地址字段`。占4B，标识接收方的IP地址。

#### 2.IP数据报分片

`一个链路层数据报能承载的最大数据量称为最大传送单元(MTU)。`因为IP数据报被封装在链路层数据报中，因此`链路层的MTU严格地限制着IP数据报的长度，而且在IP数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的MTU`。例如，以太网的MTU为`1500B`，而许多广域网的MTU不超过576B。当IP数据报的总长度大于链路MTU时，就需要将IP数据报中的数据分装在两个或多个较小的IP数据报中，这些较小的数据报称为`片`。

在上面的IP分组格式中,有两个重要的字段

- 标志位

  中间为DF :dont Fragment

  (1禁止分片,0允许分片)

  

  最低为MF more Fragment 

  (1代表后面还有分片)

  

- 片偏移 

  指较长分组分片后,某片在原分组中的相对位置,以8B为单位



下面举个列子:

> ![image-20201126210302265](https://gitee.com/zisuu/picture/raw/master/img/20201126210302.png)
>
> ![image-20201126210318142](https://gitee.com/zisuu/picture/raw/master/img/20201126210318.png)
>
> 

### 3.网络层转发分组的流程

- 1)从数据报的首部提取目的主机的IP地址D，得出目的网络地址N。
- 2)若网络N与此路由器直接相连，则把数据报直接交付给目的主机D，这称为路由器的直接交付;否则是间接交付，执行步骤3)。
- 3)若路由表中有目的地址为D的特定主机路由(对特定的目的主机指明一个特定的路由，通常是为了控制或测试网络，或出于安全考虑才采用的)，则把数据报传送给路由表中所指明的下一跳路由器;否则，执行步骤4)。
- 4)若路由表中有到达网络N的路由，则把数据报传送给路由表指明的下一跳路由器;否则，执行步骤5)。
- 5)若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器;否则，执行步骤6)。
- 6)报告转发分组出错。

### 4.IPv4与NAT

#### 1.IPv4地址

**组成与分类**

连接到因特网上的每台`主机(或路由器)`都分配一个`32比特的全球唯一标识符`，即`IP地址`。传统的IP地址是分类的地址，分为`A、B、C、D、E`五类。

![image-20201126211033745](https://gitee.com/zisuu/picture/raw/master/img/20201126211033.png)



- 无论哪类IP地址，都由`网络号`和`主机号`两部分`组成`。
- 即IP地址::= {<网络号>, <主机号>}。
- 其中`网络号`标志`主机(或路由器)`所连接到的`网络`。–个网络号在整个因特网范围内必须是唯一的。
- `主机号`标志`该主机(或路由器)`。一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。
- 由此可见，一个IP地址在整个因特网范围内是唯–的。



**特殊地址**

- 在各类IP地址中，有些IP地址具有`特殊用途`，不用做主机的IP地址:

![image-20201126211347657](https://gitee.com/zisuu/picture/raw/master/img/20201126211347.png)

**常见IP地址ABC类**

![image-20201126211552040](https://gitee.com/zisuu/picture/raw/master/img/20201126211552.png)



- `A类`地址可用的网络数为27-2，减2的原因是:`第一`，网络号字段全为0的IP地址是保留地址，意思是“本网络”;`第二`，网络号为127的IP地址是环回测试地址。
- `B类`地址的可用网络数为214-1，减1的原因是128.0这个网络号是不可指派的。
- `C类`地址的可用网络数为221-1,减1的原因是网络号为192.0.0 的网络是不可指派的。



**IP地址有以下重要特点:**

- 1)每个`IP`地址都由`网络号`和`主机号`两部分`组成`，因此IP地址是–种分等级的地址结构。分等级的好处是:`①`IP地址管理机构在分配IP地址时只分配网络号(`第一级`)， 而主机号(`第二级`)则由得到该网络的单位自行分配，方便了IP 地址的管理;`②`路由器仅根据目的主机所连接的网络号来转发分组(而不考虑目标主机号)，从而减小了路由表所占的存储空间。
- 2）`IP 地址是标志一台主机(或路由器)和一条链路的接口`。当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的IP地址，每个IP地址的网络号必须与所在网络的网络号相同，且这两个IP地址的网络号是不同的。因此IP网络上的一一个路由器必然至少应具有两个IP地址(路由器每个端口必须至少分配一个IP地址)。
- 3)`用转发器或桥接器(网桥等)连接的若干LAN仍然是同一个网络`(同一个广播域)，因此该`LAN`中所有`主机`的`IP`地址的`网络号必须相同`，但主机号必须不同。
- 4)在IP地址中，所有分配到网络号的`网络`(无论是LAN还是WAN)都是`平等`的。
- 5)`在同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的`。路由器总是具有两个或两个以上的IP地址，路由器的每个端口都有一个不同网络号的IP地址。

#### 2.NAT 网络地址转化



**NAT简介**

- `网络地址转换(NAT)`是指通过将`专用网络地址`(如Intranet)转换为`公用地址`(如Internet),从而对外隐藏内部管理的IP地址。它`使得整个专用网只需要一个全球IP地址(分配给NAT转化器)就可以与因特网连通`，由于专用网本地IP地址是可重用的，所以NAT大大节省了IP地址的消耗。同时，它隐藏了内部网络结构，从而降低了内部网络受到攻击的风险。

 **私有IP地址**

- 此外，`为了网络安全，划出了部分IP地址为私有IP地址`。`私有IP地址只用于LAN,不用于WAN连接`(因此私有IP地址不能直接用于Internet,必须通过网关利用NAT把私有IP地址转换为Internet中合法的全球IP地址后才能用于Internet), 并且允许私有IP地址被LAN重复使用。这有效地解决了IP地址不足的问题。私有IP地址网段如下:
  ![image-20201126213423507](https://gitee.com/zisuu/picture/raw/master/img/20201126213423.png)

**专用互联网/本地互联网**

- 在因特网中的所有路由器，`对目的地址是私有地址的数据报一律不进行转发`。这种`采用私有IP地址的互联网络`称为`专用互联网`或`本地互联网`。`私有IP地址`也称`可重用地址`。

**如何实现私有IP地址上网**

![image-20201126214136297](https://gitee.com/zisuu/picture/raw/master/img/20201126214136.png)

- `使用NAT时需要在专用网连接到因特网的路由器上安装NAT软件，NAT路由器至少有一个有效的外部全球地址`。
- `使用本地地址的主机和外界通信时，·NAT路由器使用NAT转换表将本地地址转换成全球地址，或将全球地址转换成本地地址`。
- NAT转换表中存放着{本地IP地址:端口}到{全球IP地址:端口}的映射。
- 通过{ip地址:端口}这样的映射方式，
- 可让多个私有IP地址映射到同一一个全球IP地址。

### 5 子网划分与子网掩码

#### 1.子网划分

`两级IP地址的缺点`:IP地址空间的利用率有时很低;给每个物理网络分配一个网络号会使路由表变得太大而使网络性能变坏;两级的IP地址不够灵活。

于是,在IP地址中又增加了一个`“子网号字段”`，使两级IP地址变成了`三级IP地址`。这种做法称为`子网划分`。子网划分已成为因特网的正式标准协议

●子网划分纯属一个单位内部的事情。`单位对外`仍然`表现为没有划分子网`的`网络`。
●`从主机号借用若干比特作为子网号`，当然主机号也就相应减少了相同的比特。`三级IP地址的结构如下: IP地址={<网络号>,<子网号>, <主机号>}`。
●凡是从其他网络发送给本单位某台主机的IP数据报,仍然是根据IP数据报的目的网络号，`先找到连接到本单位网络上的路由器`。`然后该路由器在收到IP数据报后`，`按目的网络号.和子网号找到目的子网`。`最后把IP数据报直接交付给目的主机`。

![image-20201126214724707](https://gitee.com/zisuu/picture/raw/master/img/20201126214724.png)

#### 2.子网掩码

`子网掩码`的引入，为了告诉主机或路由器对一个A类、B类、C类网络进行了子网划分，使用子网掩码来表达对原网络中主机号的借位。为了使外部可以连接子网内的网络。

![image-20201126214937817](https://gitee.com/zisuu/picture/raw/master/img/20201126214937.png)



- 子网掩码是一个与IP地址相对应的、长32bit的二进制串,它由一串1和跟随的一串0组成。
- 其中，`1对应于IP地址中的网络号及子网号，而0对应于主机号`。

- 计算机只需将`IP地址`和其对应的`子网掩码逐位“与”`(逻辑AND运算)，就可`得出相应子网的网络地址`。

- 现在的因特网标准规定:所有的网络都必须使用子网掩码。如果一个网络未划分子网，那么就采用默认子网掩码。
- A、B、C类地址的默认子网掩码分别为255.0.0.0、 255.255.0.0、255.255.255.0.
- 例如，某主机的IP地址192.168.5.56，子网掩码为255.255.255.0,进行逐位“与”运算后，得出该主机所在子网的网络号为192.168.5.0。

**列题**:

> 某主机的IP地址为180.80.77.55,子网掩码为255.255.252.0.
>
> 因为77 二进制为:0100110
>
> 252为:11111100
>
> 相与后,可得76
>
> 也即,该子网的网络地址为:180.80.76.0

**使用子网时的分组转发**

- 由于子网掩码是一个网络或一个子网的重要属性，所以路由器在相互之间交换路由信息时，`必须把自己所在网络(或子网)的子网掩码告诉对方。路由表中的每个条目，除要给出目的网络地址和下一跳地址外，还要同时给出该目的网络的子网掩码`。

**在使用子网掩码的情况下:**

- 1)一台主机在设置IP地址信息的同时，必须设置·`子网掩码`。
- 2)`同`属于一个`子网`的所有`主机及路由器`的相应`端口`，必须设置`相同`的`子网掩码`。
- 3)`路由器的路由表`中，所包含信息的主要内容必须有`目的网络地址、子网掩码、下一 跳地址`。

**使用子网掩码时路由器的分组转发算法:**

- 1)从收到的分组的首部`提取目的IP地址`，记为`D`。
- 2)`先判断是否为直接交付`。对路由器直接相连的网络逐个进行检查:用各网络的子网掩码和D逐位相“与”，看结果是否和相应的网络地址匹配。`若匹配，则将分组直接交付，否则间接交付，执行步骤3)`。
- 3)`若路由表中有目的地址为D的特定主机路由，则将分组传送给路由表中所指明的下一跳路由器`;否则，执行4)。
- 4)对路由表中的每一行(`目的网络地址、子网掩码、下一跳地址`)中的`子网掩码`和`D`逐位相`“与”`，其结果为N。若N与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器;否则，执行步骤5)。
- 5)若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器;否则，执行步骤6)。
- 6)报告转发分组出错。



#### 3.无类域间路由选择CIDR



### 6.地址解析协议 —ARP

#### 1.IP地址与硬件地址

- IP地址是网络层使用的地址，它是分层次等级的。
- 硬件地址是数据链路层使用的地址(如MAC地址)，它是平面式的。
- 通过数据封装，把IP数据报分组封装为MAC帧后，数据链路层看不见数据报分组中的IP地址。

#### 2.ARP

(Address ResolutionProtocol)

`无论网络层使用什么协议，在实际网络的链路上传送数据帧时，最终必须使用硬件地址`。`所以需要一种方法来完成 IP地址到MAC地址的映射，这就是地址解析协议(Address ResolutionProtocol, ARP)`。 每台主机都设有-一个ARP高速缓存，用来存放本局域网上各主机和路由器的IP地址到MAC地址的映射表，称ARP表。使用ARP来动态维护此ARP表。

工作过程:

![image-20201128094216471](https://gitee.com/zisuu/picture/raw/master/img/20201128094216.png)





### 7.动态主机配置协议—DHCP

(Dynamic Host Configuration Protocol)

- `动态主机配置协议`(Dynamic Host Configuration Protocol, `DHCP`)`常用于给主机动态地分配IP地址`，它提供了即插即用联网的机制，这种机制允许一台计算机加入新的网络和获取IP地址而不用手工参与。
- DHCP是应用层协议，它是基于UDP的。

**DHCP的工作原理如下:**

- 使用client/server方式
- 需要IP地址的主机在启动时就向DHCP服务器广播发送发送报文，这时该主机就成为DHCP客户。本地网络上所有主机都能收到此广播报文，但只有DHCP服务器才回答此广播报文。
- DHCP服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。
- 若找不到，则从服务器的IP地址池中取一个地址分配给该计
  算机。DHCP服务器的回答报文称为提供报文

### 8.网际控制报文协议— ICMP

举例来讲，一个新搭建好的网络，往往需要先进行一个简单的测试，来验证网络是否通畅；但是IP协议并不提供可靠传输，所以IP协议并不会通知传输层是否丢包及丢包的原因。所以才有了ICMP协议的存在。

ICMP协议即Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机与路由器间传递控制消息。这里的控制消息指的是：网络是否通畅、主机是否可达、路由是否可用等网络本身的消息。

**1.ICMP功能**

（1）确认IP包是否成功到达目的地址

（2）通知在发送过程中IP包被丢弃的原因

（3）它是基于IP协议工作的，但并不是传输层的功能，所以把它归结为网络层协议

（4）ICMP只能搭配IPv4使用，若是IPv6，则需要用ICMPv6

**2.ICMP报文格式**

![image-20201128095138090](https://gitee.com/zisuu/picture/raw/master/img/20201128095138.png)

ICMP大概分为两类报文：

（1）通知出错原因

（2）用于诊断查询

ICMP常用类型如下表：

![image-20201128095152626](https://gitee.com/zisuu/picture/raw/master/img/20201128095152.png)

**3. ping命令**

（1）ping + IP地址，可以连接同局域网下的主机

（2）ping + 域名，比如ping+www.baidu.com，就可以与百度连接，得到百度的一个应答报文。这里与ping+IP地址类似，因为一个域名可以通过DNS解析为IP地址

（3）ping命令不仅可以检验网络的验证性，同时也会统计响应时间和TTL（生存周期）

（4）对端收到之后，会返回一个ICMP回送应答（Echo Reply）

要注意的是：telnet是23端口，ssh是22端口，ping不关心端口号。因为ping命令基于ICMP协议，是网络层的内容，而端口号则是传输层的内容。





