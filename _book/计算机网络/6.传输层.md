## 一 传输层功能

### 1.进程之间的逻辑通信

- 与网络层的区别是，网络层提供的是主机之间的逻辑通信。
- 从网络层来说，通信的双方是两台主机，IP 数据报的首部给出了这两台主机的IP地址。
- 但“两台主机之间的通信”实际上是两台主机中的应用进程之间的通信，应用进程之间的通信又称`端到端`的逻辑通信。
- 这里`“逻辑通信”`的意思是:传输层之间的通信好像是沿水平方向传送数据，但事实上这两个传输层之间并没有–条水平方向的物理连接。
  ![image-20201129090734304](https://gitee.com/zisuu/picture/raw/master/img/20201129090734.png)

### 2.复用和分用

- 复用是指发送方不同的应用进程都可使用同一个传输层协议传送数据;
- 分用是指接收方的传输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程。

**注意：**

- 传输层的复用分用功能与网络层的复用分用功能不同。
- 网络层的`复用`是指发送方不同协议的数据都可以封装成IP数据报发送出去,
- 网络层的`分用`是指接收方的网络层在剥去首部后把数据交付给相应的协议。

### 3.差错检查

- 网络层只检查IP数据报的首部，不检验数据部分是否出错。
- 因此传输层需要对数据部分进行差错检测

### 4.两种协议

传输层只有两种协议:TCP和UDP,且只能二选一使用

TCP是面向连接,提供可靠传输的服务

UDP面向无连接,不可靠服务

![image-20201129091834454](https://gitee.com/zisuu/picture/raw/master/img/20201129091834.png)

### 5.端口与套接字

**端口**

- 端口能够让应用层的各种应用进程将其数据通过端口向下交付给传输层，以及让传输层知道应当将其报文段中的数据向上通过端口交付给应用层相应的进程。
- 端口是传输层`服务访问点`(TSAP)，它在传输层的作用类似于IP地址在网络层的作用或MAC地址在数据链路层的作用，只不过`IP地址和MAC地址标识的是主机，而端口标识的是主机中的应用进程`。
- `数据链路层的SAP是MAC地址，网络层的SAP是IP地址，传输层的SAP是端口`。
- 在协议栈层间的抽象的协议端口是软件端口，它与路由器或交换机上的硬件端口是完全不同的概念。
- 硬件端口是不同硬件设备进行交互的接口，而软件端口是应用层的各种协议进程与传输实体进行层间交互的一种地址。
- 传输层使用的是软件端口。

![image-20201129091509767](https://gitee.com/zisuu/picture/raw/master/img/20201129091509.png)

**套接字**

(详细可看计算机网络篇第二篇文章)

![image-20201129091631145](https://gitee.com/zisuu/picture/raw/master/img/20201129091631.png)





## 二 UDP协议

### 1.特点

**1)UDP无须建立连接。**

- UDP不会引入建立连接的时延。
- 试想如果DNS运行在TCP而非UDP.上，那么DNS的`速度`会慢很多。
- HTTP使用TCP而非UDP，是因为对于基于文本数据的Web网页来说，`可靠性`是至关重要的。

**2)无连接状态。**

- TCP需要在端系统中维护连接状态。此连接状态包括接收和发送缓存、拥塞控制参数和序号与确认号的参数。
- 而UDP不维护连接状态，也不跟踪这些参数。
- 因此，`某些专用应用服务器使用UDP`时，`一般都能支持更多的活动客户机`。

**3)分组首部开销小。**

- `TCP`有`20B`的`首部`开销，而`UDP`仅有`8B`的开销。

**4)应用层能更好地控制要发送的数据和发送时间。**

- UDP没有拥塞控制，因此网络中的拥塞`不会影响主机的发送效率`。
- `某些实时应用要求以稳定的速度发送`，能容忍一些数据的丢失，但`不允许有较大的时延`，而UDP正好满足这些应用的需求。

**5)UDP常用于一次性传输较少数据的网络应用**

- 如DNS、SNMP等，因为对于这些应用，若采用TCP，则将为连接创建、维护和拆除带来不小的开销。
- UDP也常用于多媒体应用(如IP电话、实时视频会议、流媒体等)，显然，可靠数据传输对这些应用来说并不是最重要的，但TCP的拥塞控制会导致数据出现较大的延迟，这是它们不可容忍的。

**6)UDP提供尽最大努力的交付，即不保证可靠交付**

- 但这并不意味着应用对数据的要求是不可靠的，因此所有维护传输可靠性的工作需要用户在应用层来完成。
- `应用实体可以根据应用的需求来灵活设计自己的可靠性机制`。

**7)UDP是面向报文的。**

- 发送方UDP对`应用层交下来的报文`，在添加首部后就向下交付给IP层，
  `既不合并，也不拆分`，而是保留这些报文的边界;
- 接收方UDP对IP层交上来UDP用户数据报，在去除首部后就原封不动地交付给上层应用进程，一次交付一个完整的报文。
- 因此`报文不可分割，是UDP数据报处理的最小单位`。

### 2.首部格式

![image-20201129092647209](https://gitee.com/zisuu/picture/raw/master/img/20201129092647.png)

> - 1)源端口。源端口号。在需要对方回信时选用，不需要时可用全0。
> - 2)目的端口。目的端口号。这在终点交付报文时必须使用到。
> - 3)长度。UDP数据报的长度(包括首部和数据)，其最小值是8 (仅有首部)。
> - 4)校验和。检测UDP数据报在传输中是否有错。有错就丢弃。该字段是可选的，当源主机不想计算校验和时，则直接令该字段为全0。

### 3.差错检验

UDP 检验和提供了差错检测的功能。这是基于**端到端原则**实现的。但是 UDP 的检验和并不提供差错回复的能力。

**原理**

对发送方的 UDP 报文段的所有 16 比特字的和进行反码运算，当求和遇见溢出的时候，进行回卷（回卷的补充在下面），得到的结果放在 UDP 报文段中的检验和字段

**什么是回卷**

所谓 “回卷” 就是当进行 16 比特的加法运算的时候，如果进位到 17位，则将第 17 位和后 16 位进行加法和运算。

我们将在下面的小例子中实际操练。

假设我们有 3 个 16 比特的字，分别如下

```
0110011001100000
0101010101010101
1000111100001100
123
```

**第一步：对 3 个 16 比特的字依次相加**

```
0110 0110 0110 0000 + 0101 0101 0101 0101 + 1000 1111 0000 1100 = 0100 1010 1100 0010
1
```

注意，在最后一次加法的过程中，发生了**回卷**，看下面，多了第 17 位，要消除第 17 位
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190226170316884.png)

这两个数相加得到
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190226170705880.png)

此时用 1 + 0100 1010 1100 0001 = 0100 1010 1100 0010

**第二步：对和进行反码运算**

```
0100 1010 1100 0010 的反码 1011 0101 0011 1101.
1
```

**第三步：将这个值放入校验和中**

**第四步：在接收方中，将全部的 4 个 16比特的字（包含了校验和）加在一起，没有差错的话，就是 1111 1111 1111 1111**

## 三 TCP协议

### 1.协议特点

- **面向连接**

- **点对点服务**

- **可靠服务**

  可靠有序,不丢不重

- **全双工通信**

- **面向字节流**

  ![image-20201129094116798](https://gitee.com/zisuu/picture/raw/master/img/20201129094117.png)

### 2.首部格式

- `TCP传送的数据单元称为报文段`。一个TCP报文段分为TCP首部和TCP数据两部分，整个TCP报文段作为IP数据报的数据部分封装在IP数据报中
- 其首部的前20B是固定的。TCP报文段的首部最短为20B，后面有4N字节是根据需要而增加的选项，通常长度为4B的整数倍。
- TCP报文段既可以用来运载数据，又可以用来建立连接、释放连接和应答。

![image-20201129094359875](https://gitee.com/zisuu/picture/raw/master/img/20201129094400.png)

> - 1)`源端口和目的端口字段`。各占2B。端口是运输层与应用层的服务接口，运输层的复用和分用功能都要通过端口实现。
> - 2)`序号字段`。占4B。TCP是面向字节流的(即TCP传送时是逐个字节传送的)，所以TCP连接传送的数据流中的每个字节都编上一个序号。序号字段的值指的是本报文段所发送的数据的第一个字节的序号。
> - 3)`确认号字段`。占4B,是期望收到对方的下一个报文段的数据的第一个字节的序号。若确认号为N，则表明到序号N- 1为止的所有数据都已正确收到。
> - 4)`数据偏移(即首部长度)`。占4位，这里不是IP数据报分片的那个数据偏移，而是表示首部长度，
> - 5)`紧急位URG`。URG= 1时，表明紧急指针字段有效。它告诉系统报文段中有紧急数据，应尽快传送(相当于高优先级的数据)。但`URG需要和紧急指针配套使用`，即`数据从第一个字节到紧急指针所指字节`就是`紧急数据`。
> - 7)`确认位ACK`。只有当ACK= 1时确认号字段才有效。当ACK=0时，确认号无效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置1.
> - 8)`推送位PSH (Push)`。 接收TCP收到PSH= 1的报文段，就尽快地交付给接收应用进程而不再等到整个缓存都填满后再向上交付。
> - 9)`复位位RST (Reset)`。RST=1时，表明TCP连接中出现严重差错(如主机崩溃或其他原因)，必须释放连接，然后再重新建立运输连接。
> - 10)`同步位SYN`。同步SYN= 1表示这是一个`连接请求或连接接收报文`。当`SYN=1, ACK=0`时，表明这是一个`连接请求`报文，对方若同意建立连接，则在响应报文中使用`SYN=1, ACK=1`。即SYN= 1表示这是一个连接请求或连接接收报文。
> - 11)`终止位FIN (Finish)`。用来释放一个连接。FIN= 1表明此报文段的发送方的数据已发送完毕，并要求释放传输连接。
> - 12)`窗口字段`。占2B。它指出现在允许对方发送的数据量，接收方的数据缓存空间是有限的，因此用窗口值作为接收方让发送方设置其发送窗口的依据，单位为字节。
>   例如，假设确认号是701，窗口字段是1000。这表明，从701号算起，发送此报文段的接收方方还有接收1000B数据(字节序号为701 ~1700)的接收缓存空间。
> - 13)`校验和`。占2B。校验和字段检验的范围包括首部和数据两部分。
> - 14)`紧急指针字段`。占16 位，指出在本报文段中紧急数据共有多少字节(紧急数据放在本报文段数据的最前面)。
> - 15)`选项字段`。长度可变。TCP最初只规定了一种选项，即最大报文段长度(Maximum SegmentSize，MSS)。MSS是TCP报文段中的数据字段的最大长度。窗口扩大、时间戳、选择确认
>   16)`填充字段`。这是为了使整个首部长度是4B的整数倍。填充0.

### 3.连接管理

关于三次握手,四次挥手的连接管理内容,可看第一篇文章

### 4.可靠传输

#### 序号

![image-20201129095922374](https://gitee.com/zisuu/picture/raw/master/img/20201129095922.png)

#### 确认

![image-20201129095943567](https://gitee.com/zisuu/picture/raw/master/img/20201129095943.png)

#### 重传

![image-20201129100045409](https://gitee.com/zisuu/picture/raw/master/img/20201129100045.png)

### 5.流量控制

- 在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，这称为`接收窗口rwnd`, 即`调整TCP报文段首部中的“窗口”字段值`，来限制发送方向网络注入报文的速率。
- 同时，发送方根据其对当前网络拥塞程序的估计而确定的窗口值，这称为`拥塞窗口cwnd`，其大小与网络的带宽和时延密切相关。

- `例如`，在通信中，有效数据只从A发往B，而B仅向A发送确认报文，这时B可以通过设置确认报文段首部的窗口字段来将rwnd通知给A。
- rwnd 即接收方允许连续接收的最大能力，单位是字节。
- 发送方A总是根据最新收到的rwnd值来限制自己发送窗口的大小，从而将未确认的数据量控制在rwnd大小之内，保证A不会使B的接收缓存溢出。
- 当然，`A的发送窗口的实际大小取rwnd和cwnd中的最小值`

**传输层和数据链路层的流量控制的区别是:**

- 传输层定义`端到端`用户之间的流量控制，数据链路层定义`两个中间的相邻结点`的流量控制。
- 另外，`数据链路层`的滑动窗口协议的`窗口`大小`不能动态变化`，`传输层`的则可以`动态变化`。





### 6.拥塞控制

#### **定义**

- 所谓`拥塞控制，是指防止过多的数据注入网络，保证网络中的路由器或链路不致过载`。出现拥塞时，端点并不了解到拥塞发生的细节，对通信连接的端点来说，拥塞往往表现为通信时延的增加。当然，拥塞控制和流量控制也有相似的地方，即它们都通过控制发送方发送数据的速率来达到控制效果。

#### **与流量控制的对比**

- `拥塞控制`是让网络能够承受现有的网络负荷，是一个全局性的过程，涉及所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。
- `流量控制`往往是指点对点的通信量的控制，即接收端控制发送端，它所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。

- **例如：**
- 某个链路的传输速率为10Gb/s,某巨型机向一台PC以1Gb/s的速率传送文件，显然网络的带宽是足够大的，不存在拥塞问题，但如此高的发送速率将导致PC可能来不及接收，因此必须进行`流量控制`。
- 但若有100万台PC在此链路上以1Mb/s的速率传送文件，则现在的问题就变为网络的负载是否超过了现有网络所能承受的范围。就像我们上网一样，有时候加载会很慢，提示访问请求过多，请稍后再试，就是网络产生了拥塞，带宽小，一下不能支持给多个请求终端发送数据。

为了更好地对传输层进行拥塞控制，因特网建议标准定义了以下4种算法:`慢开始、拥塞避免、快重传、快恢复。`



#### 窗口

- 在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，这称为`接收窗口rwnd`, 即`调整TCP报文段首部中的“窗口”字段值`，来限制发送方向网络注入报文的速率。
- 同时，发送方根据其对当前网络拥塞程序的估计而确定的窗口值，这称为`拥塞窗口cwnd`，其大小与网络的带宽和时延密切相关。

#### 慢开始与拥塞避免

**慢开始**

- 在TCP刚刚连接好并开始发送TCP报文段时，先令拥塞窗口cwnd= 1,即一个最大报文段长度MSS.每收到一个对新报文段的确认后，将cwnd加1,即增大一个 MSS.用这样的方法逐步增大发送方的拥塞窗口cwnd,可使分组注入网络的速率更加合理。

> 例如，A向B发送数据，发送时A的拥塞窗口为2,那么A一次可以发送两个TCP报文段，经过一个RTT后(也称一个`传输轮次`)，A收到B对刚才两个报文的确认，于是把拥塞窗口调整为4，下一次发送时就可一次发送4个报文段。

- 使用慢开始算法后，每经过一个传输轮次(即往返时延RTT)，拥塞窗口cwnd就会加倍，即cwnd的大小指数式增长。这样，慢开始一直把拥塞窗口cwnd增大到一个规定的`慢开始门限ssthresh(阈值)`，然后`改用拥塞避免算法`。



**拥塞避免**

- 拥塞避免算法的做法如下:发送端的拥塞窗口cwnd每经过- -一个往返时延RTT就增加一个MSS的大小，而不是加倍,使cwnd按线性规律缓慢增长(即加法增大),而当出现一次超时(网络拥塞)时，令慢开始门限ssthresh等于当前cwnd的一半(即乘法减小)。
- 根据cwnd的大小执行不同的算法，可归纳如下:
  ●当cwnd < ssthresh时，使用慢开始算法。
  ●当 cwnd > ssthresh时，停止使用慢开始算法而改用拥塞避免算法。
  ●当cwnd = sthresh时，既可使用慢开始算法，又可使用拥塞避免算法(通常做法)。

![image-20201129160051249](https://gitee.com/zisuu/picture/raw/master/img/20201129160051.png)

#### 快重传和块恢复

**快重传**

`快重传和快恢复算法是对慢开始和拥塞避免算法的改进。`
**(1)快重传**

- 在TCP可靠传输机制中，`快重传技术`使用了`冗余ACK来检测丢包的发生`。同样，`冗余ACK也用于网络拥塞的检测`(丢了包当然意味着网络可能出现了拥塞)。快重传并非取消重传计时器，而是在某些情况下可更早地重传丢失的报文段。
  当发送方连续收到三个重复的ACK报文时，`直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时`。

**(2)快恢复**

- `快恢复算法`的原理如下:
- 发送端收到连续三个冗余ACK (即重复确认)时，执行`“乘法减小”算法`，把慢开始门限ssthresh 设置为出现拥塞时发送方cwnd的一半。
- 与慢开始(慢开始算法将拥塞窗口cwnd设置为1)的`不同之处`是，它把cwnd的值设置为慢开始门限ssthresh改变后的数值，然后开始执行`拥塞避免算法(“ 加法增大”)`，使拥塞窗口缓慢地线性增大。
- `由于跳过了cwnd从1起始的慢开始过程,所以被称为快恢复`。

- 在`流量控制`中，发送方发送数据的量由接收方决定，而在`拥塞控制`中，则由发送方自己通过检测网络状况来决定。

![image-20201129160125205](https://gitee.com/zisuu/picture/raw/master/img/20201129160125.png)

#### 总结

- 实际上，`慢开始、拥塞避免、快重传和快恢复几种算法`应是同时应用在拥塞控制机制之中的
- 当发送方检测到超时的时候，就采用慢开始和拥塞避免，
- 当发送方接收到冗余ACK时，就采用快重传和快恢复。

> `注意：` `发送方发送窗口的实际大小`由`流量控制`和`拥塞控制`共同决定。
> 因此，当题目中同时出现接收端窗口(rwnd) 和拥塞窗口(cwnd) 时，发送方实际的发送窗口大小是由rwnd和cwnd中较小的那一个确定的。



















